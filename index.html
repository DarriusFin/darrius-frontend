<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DarriusAI Â· Inflection Hunter Pro | AI æ‹ç‚¹å†³ç­–ç³»ç»Ÿ</title>

  <!-- Lightweight Charts (TradingView) -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0E1117;
      --panel:#151A23;
      --panel2:#101521;
      --border:#232A36;

      --text:#E6EDF3;
      --muted:#8B949E;

      --green:#2BE2A6;
      --blue:#4CC2FF;
      --red:#FF5A5A;
      --orange:#FFB86C;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;

      --btnGrad: linear-gradient(90deg, rgba(43,226,166,1) 0%, rgba(76,194,255,1) 100%);
      --btnGrad2: linear-gradient(90deg, rgba(76,194,255,1) 0%, rgba(43,226,166,1) 100%);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 12% 12%, rgba(76,194,255,.10), transparent 55%),
        radial-gradient(1000px 500px at 88% 10%, rgba(43,226,166,.10), transparent 55%),
        radial-gradient(800px 500px at 60% 90%, rgba(255,90,90,.06), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
      overflow:hidden;
    }

    /* Top bar */
    #topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      border-bottom:1px solid var(--border);
      background: rgba(14,17,23,.65);
      backdrop-filter: blur(10px);
    }
    #brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:320px;
    }
    #logo{
      width:36px;height:36px;border-radius:10px;
      background: linear-gradient(135deg, rgba(43,226,166,.22), rgba(76,194,255,.22));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
    }
    #logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, rgba(43,226,166,.0), rgba(43,226,166,.55), rgba(76,194,255,.55), rgba(43,226,166,.0));
      animation: spin 6s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    #brandText{ line-height:1.1; }
    #brandTitle{
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
    }
    #brandTitle .accent{
      background: linear-gradient(90deg, var(--green), var(--blue));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    #brandSub{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
    }

    #topRight{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width:320px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(21,26,35,.75);
      box-shadow: var(--shadow);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
      max-width: 42vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--green);
      box-shadow: 0 0 0 3px rgba(43,226,166,.12);
    }
    #statusBadge.ok .dot{ background: var(--green); box-shadow: 0 0 0 3px rgba(43,226,166,.14); }
    #statusBadge.bad .dot{ background: var(--red); box-shadow: 0 0 0 3px rgba(255,90,90,.14); }
    #statusText{
      max-width: 34vw;
      overflow:hidden;text-overflow:ellipsis;
    }
    #copyright{
      color:rgba(230,237,243,.70);
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
    }

    /* Main layout */
    #main{
      height: calc(100vh - 64px);
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap:16px;
      padding:16px;
    }

    .panel{
      background: linear-gradient(180deg, rgba(21,26,35,.92), rgba(16,21,33,.86));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0; /* allow inner scroll */
    }

    .panelHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHeader .h{
      font-weight:800;
      letter-spacing:.2px;
      font-size:13px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panelHeader .h .tag{
      font-weight:700;
      color:#071019;
      background: rgba(43,226,166,.90);
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
    }
    .panelBody{
      padding:14px;
      overflow:auto;
      min-height:0;
    }

    /* Left metrics */
    .card{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.07);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .cardTitle b{ color:var(--text); font-size:12.5px; }
    .small{
      font-size:12px; color:var(--muted);
      line-height:1.45;
    }

    /* Gauge */
    .gaugeWrap{
      display:flex;align-items:center;gap:12px;
    }
    .gauge{
      width:160px;height:160px;border-radius:50%;
      background:
        conic-gradient(var(--green) 0deg, var(--green) 250deg, rgba(255,255,255,.10) 250deg, rgba(255,255,255,.10) 360deg);
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .gauge:after{
      content:"";
      position:absolute; inset:14px;
      background: rgba(14,17,23,.95);
      border-radius:50%;
      border:1px solid rgba(255,255,255,.06);
    }
    .gaugeCenter{
      position:absolute; inset:0;
      display:flex;align-items:center;justify-content:center;
      z-index:2;
      flex-direction:column;
      text-align:center;
    }
    .gaugeCenter .num{
      font-size:36px; font-weight:900;
      letter-spacing:.5px;
    }
    .gaugeCenter .lbl{
      margin-top:2px;
      font-size:12px;color:var(--muted);
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .kv b{ color:var(--text); font-weight:800; }

    .signalBox{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .signal{
      padding:12px;
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .signal .side{
      font-weight:900;
      letter-spacing:.4px;
    }
    .signal.buy{ border-left: 4px solid var(--green); }
    .signal.sell{ border-left: 4px solid var(--red); }
    .signal.neutral{ border-left: 4px solid rgba(255,255,255,.18); }
    .signal .meta{
      font-size:12px;color:var(--muted);
      margin-top:6px;
      line-height:1.35;
    }

    /* Center chart */
    #chartPanel .panelBody{ padding:0; }
    #chartTop{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }
    #priceLine{
      display:flex;align-items:center;gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    #priceLine .sym{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    #hintText{
      color:var(--muted);
      font-size:12px;
      max-width:52%;
      overflow:hidden;text-overflow:ellipsis; white-space:nowrap;
    }
    #chart{
      height: calc(100vh - 64px - 16px - 16px - 54px); /* topbar + paddings + chartTop */
      min-height:360px;
      width:100%;
    }

    /* Right controls */
    .field{ margin-bottom:10px; }
    .label{
      font-size:12px;color:var(--muted);
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .label b{ color:var(--text); }
    input, select{
      width:100%;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(139,148,158,.85); }
    input:focus, select:focus{
      border-color: rgba(76,194,255,.55);
      box-shadow: 0 0 0 4px rgba(76,194,255,.12);
    }

    .btn{
      width:100%;
      border:0;
      color:#071019;
      font-weight:900;
      letter-spacing:.3px;
      padding:12px 12px;
      border-radius:12px;
      cursor:pointer;
      background: var(--btnGrad);
      box-shadow: 0 10px 20px rgba(0,0,0,.30);
      transition: transform .06s ease, filter .15s ease;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight:800;
      padding:11px 12px;
      border-radius:12px;
      cursor:pointer;
      background: rgba(0,0,0,.18);
      transition: transform .06s ease, filter .15s ease;
    }
    .btnGhost:hover{ filter: brightness(1.05); }
    .btnGhost:active{ transform: translateY(1px); }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.06);
      margin:12px 0;
    }

    .note{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .note b{ color:var(--text); }

    #logBox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px;
      color: rgba(230,237,243,.85);
      height:120px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* Footer disclaimer */
    #footer{
      padding:10px 16px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.20);
      color: rgba(230,237,243,.72);
      font-size:11px;
      line-height:1.45;
    }
    #footer .muted{ color: rgba(139,148,158,.92); }
    #footer a{ color: rgba(76,194,255,.95); text-decoration:none; }
    #footer a:hover{ text-decoration:underline; }

    /* Responsive */
    @media (max-width: 1180px){
      body{ overflow:auto; }
      #main{
        height:auto;
        grid-template-columns: 1fr;
      }
      #chart{ height: 520px; }
      #topRight{ min-width: 0; }
      #brand{ min-width: 0; }
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="brand">
      <div id="logo"></div>
      <div id="brandText">
        <div id="brandTitle">
          <span class="accent">DarriusAI</span> Â· Inflection Hunter Pro
        </div>
        <div id="brandSub">AI æ‹ç‚¹å†³ç­–ç³»ç»Ÿ Â· æ‹ç‚¹çŒæ‰‹</div>
      </div>
    </div>

    <div id="topRight">
      <div id="statusBadge" class="pill ok" title="System Status">
        <span class="dot"></span>
        <span id="statusText">Ready Â· å‰ç«¯å·²å°±ç»ª</span>
      </div>
      <div id="copyright">Â© 2025 Darrius FinTech Inc. All Rights Reserved.</div>
    </div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div class="panel" id="leftPanel">
      <div class="panelHeader">
        <div class="h">Market Pulse Â· å¸‚åœºæƒ…ç»ª <span class="tag" id="pulseTag">LIVE</span></div>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="gaugeWrap">
            <div class="gauge" id="pulseGauge">
              <div class="gaugeCenter">
                <div class="num" id="pulseScore">76</div>
                <div class="lbl">Sentiment</div>
              </div>
            </div>
            <div style="flex:1">
              <div class="kv">
                <span>Bullish</span><b id="bullPct">48.35%</b>
                <span>Bearish</span><b id="bearPct" style="color:var(--red)">26.42%</b>
                <span>Neutral</span><b id="neuPct">25.23%</b>
                <span>Net Inflow</span><b id="netInflow" style="color:var(--green)">+353.49</b>
              </div>
              <div class="small" style="margin-top:10px">
                è¯´æ˜ï¼šè¯¥æ¨¡å—ä¸ºå‰ç«¯å±•ç¤ºä½ï¼ˆå¯æ¥å…¥ä½ æœªæ¥çš„çœŸå®æƒ…ç»ªæ•°æ®æºï¼‰ã€‚
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardTitle"><b>Risk Copilot Â· é£é™©åŠ©æ‰‹</b><span class="small" id="riskMode">Demo</span></div>
          <div class="kv">
            <span>Entry Â· å…¥åœº</span><b id="riskEntry">â€”</b>
            <span>Stop Â· æ­¢æŸ</span><b id="riskStop" style="color:var(--red)">â€”</b>
            <span>Targets Â· ç›®æ ‡</span><b id="riskTargets">â€”</b>
            <span>Confidence Â· å¼ºåº¦</span><b id="riskConf">â€”</b>
            <span>Backtest WinRate Â· å›æµ‹èƒœç‡</span><b id="riskWR">â€”</b>
          </div>
        </div>

        <div class="signalBox">
          <div class="signal neutral" id="signalRow">
            <div>
              <div class="side" id="signalSide">Waitingâ€¦</div>
              <div class="meta" id="signalMeta">ç­‰å¾…æ•°æ® / æ¼”ç¤ºä¿¡å·å±•ç¤ºä½</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:900" id="signalPx">â€”</div>
              <div class="meta" id="signalTf">TF: 1D</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="small">
          <b>Disclaimer:</b> Educational only, not financial advice. / ä»…ä¾›å­¦ä¹ ç ”ç©¶ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="panel" id="chartPanel">
      <div id="chartTop">
        <div id="priceLine">
          <span class="sym" id="symText">BTCUSDT</span>
          <span id="priceText">â€”</span>
        </div>
        <div id="hintText">Demo chart loaded Â· æ¼”ç¤ºå›¾è¡¨å·²åŠ è½½</div>
      </div>
      <div class="panelBody">
        <div id="chart"></div>
      </div>
      <div id="footer">
        <div>
          <b>English:</b>
          DarriusAI provides algorithmic market analysis for educational and informational purposes only.
          It does not constitute investment advice. Trading involves risk. Past performance does not guarantee future results.
        </div>
        <div class="muted" style="margin-top:6px">
          <b>ä¸­æ–‡ï¼š</b>
          æœ¬ç³»ç»Ÿä»…æä¾›ç®—æ³•åˆ†æä¸å¸‚åœºç ”ç©¶ä¿¡æ¯ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚é‡‘èå¸‚åœºå­˜åœ¨é£é™©ï¼Œå†å²è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Šã€‚
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel" id="rightPanel">
      <div class="panelHeader">
        <div class="h">Control Center Â· æ§åˆ¶å°</div>
      </div>
      <div class="panelBody">

        <div class="card" style="margin-bottom:12px">
          <div class="cardTitle"><b>Market Control Â· å“ç§ä¸å‘¨æœŸ</b><span class="small">Data Source</span></div>

          <div class="field">
            <div class="label"><span>Symbol Â· å“ç§</span><span class="small">(Binanceæ ¼å¼ï¼Œå¦‚ BTCUSDT)</span></div>
            <input id="symbol" value="BTCUSDT" />
          </div>

          <div class="field">
            <div class="label"><span>Timeframe Â· å‘¨æœŸ</span></div>
            <select id="tf">
              <option value="1d">1d Â· æ—¥çº¿</option>
              <option value="4h">4h Â· 4å°æ—¶</option>
              <option value="1h">1h Â· 1å°æ—¶</option>
              <option value="15m">15m Â· 15åˆ†é’Ÿ</option>
            </select>
          </div>

          <button class="btn" id="loadBtn">Load Â· åŠ è½½</button>

          <div class="row2">
            <label class="btnGhost" style="display:flex;align-items:center;justify-content:center;gap:8px;">
              <input type="checkbox" id="tgEMA" checked style="width:auto;margin:0;transform:translateY(1px)">
              EMA(20)
            </label>
            <label class="btnGhost" style="display:flex;align-items:center;justify-content:center;gap:8px;">
              <input type="checkbox" id="tgAux" checked style="width:auto;margin:0;transform:translateY(1px)">
              Aux çº¿
            </label>
          </div>

          <div class="note" style="margin-top:10px">
            <b>æç¤ºï¼š</b>å¦‚æœ Binance/æ•°æ®æºä¸å¯ç”¨ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨æ¼”ç¤ºæ•°æ®ï¼ˆä¸å½±å“è®¢é˜…ä¸æ”¯ä»˜é“¾è·¯æµ‹è¯•ï¼‰ã€‚
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div class="cardTitle"><b>ğŸ”’ Pro Access Â· è®¢é˜…</b><span class="small">Secure by Stripe</span></div>

          <div class="field">
            <div class="label"><span>User ID Â· ç”¨æˆ·ID</span><span class="small">ï¼ˆå¿…å¡«ï¼‰</span></div>
            <input id="userId" placeholder="ä¾‹å¦‚ï¼šuser_123 / ä½ çš„ç³»ç»Ÿç”¨æˆ·ID" />
          </div>

          <div class="field">
            <div class="label"><span>Email Â· é‚®ç®±</span><span class="small">ï¼ˆå»ºè®®å¡«ï¼Œç”¨äºæ”¶æ®ï¼‰</span></div>
            <input id="email" placeholder="ç”¨äºé¦–æ¬¡å…œåº•åŒ¹é… / receipts" />
          </div>

          <div class="field">
            <div class="label"><span>Plan Â· å¥—é¤</span><span class="small" id="trialHint">Trial info</span></div>
            <select id="planSelect">
              <option value="weekly">Weekly Â· å‘¨ä»˜ - $4.90</option>
              <option value="monthly">Monthly Â· æœˆä»˜ - $19.90 (Trial 1 day)</option>
              <option value="quarterly">Quarterly Â· å­£ä»˜ - $49.90 (Trial 3 days)</option>
              <option value="yearly">Annual Â· å¹´ä»˜ - $189 (Trial 5 days)</option>
            </select>
          </div>

          <button class="btn" id="subscribeBtn">Start Subscription Â· å¼€é€šè®¢é˜…</button>

          <div class="note" style="margin-top:10px">
            <b>è§„åˆ™ï¼š</b>è¯•ç”¨å¿…é¡»ç»‘å®šä¿¡ç”¨å¡ï¼›è¯•ç”¨åˆ°æœŸè‹¥æœªä»˜è´¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å–æ¶ˆè®¿é—®æƒé™ã€‚<br/>
            <b>è¯´æ˜ï¼š</b>å‰ç«¯åªä¼  <code>user_id</code> + <code>price_id</code>ï¼›åç«¯ç»Ÿä¸€åˆ›å»º Stripe Checkout Session/Subscriptionã€‚
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div class="cardTitle"><b>Share & Export Â· åˆ†äº«ä¸å¯¼å‡º</b><span class="small">Utilities</span></div>

          <button class="btnGhost" id="copyLinkBtn">Copy Share Link Â· å¤åˆ¶åˆ†äº«é“¾æ¥</button>
          <div style="height:10px"></div>
          <button class="btnGhost" id="exportBtn">Export PNG Â· å¯¼å‡ºå›¾ç‰‡ï¼ˆå«å›¾è¡¨ï¼‰</button>

          <div class="note" style="margin-top:10px">
            è¯´æ˜ï¼šå¯¼å‡ºä½¿ç”¨ LightweightCharts æˆªå›¾èƒ½åŠ›ã€‚è‹¥éœ€â€œå«æ›´å¤šOverlayå›¾å±‚â€å¯ç»§ç»­å¢å¼ºã€‚
          </div>
        </div>

        <div class="card">
          <div class="cardTitle"><b>Diagnostics Â· è¯Šæ–­</b><span class="small">API / Logs</span></div>
          <div class="row2" style="margin-top:0">
            <button class="btnGhost" id="healthBtn">Health</button>
            <button class="btnGhost" id="routesBtn">Routes</button>
          </div>
          <div style="height:10px"></div>
          <div id="logBox"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /**
     * âœ… API base
     * ä½ å½“å‰å·²ç»è·‘é€šï¼šhttps://darrius-api.onrender.com
     * å¦‚æœæœªæ¥ä½ æ¢æˆ api.darrius.aiï¼Œåªéœ€è¦æ”¹è¿™é‡Œã€‚
     */
    const API_BASE = "https://darrius-api.onrender.com";

    // âœ… Stripe price idsï¼ˆä½ ç»™çš„æœ€æ–° 4 ä¸ªï¼‰
    const PRICE_MAP = {
      weekly:    { price_id: "price_1SpJMmR84UMUVSTg0T7xfm6r", trial_days: 0,  label: "Weekly Â· å‘¨ä»˜ - $4.90" },
      monthly:   { price_id: "price_1SpbvRR84UMUVSTggbg0SFzi", trial_days: 1,  label: "Monthly Â· æœˆä»˜ - $19.90 (Trial 1 day)" },
      quarterly: { price_id: "price_1SpbwYR84UMUVSTgMQpUrE42", trial_days: 3,  label: "Quarterly Â· å­£ä»˜ - $49.90 (Trial 3 days)" },
      yearly:    { price_id: "price_1SpbpxR84UMUVSTgapaJDjMX", trial_days: 5,  label: "Annual Â· å¹´ä»˜ - $189 (Trial 5 days)" },
    };

    function $(id){ return document.getElementById(id); }

    function setStatus(text, ok=true){
      const badge = $("statusBadge");
      badge.classList.remove("ok","bad");
      badge.classList.add(ok ? "ok" : "bad");
      $("statusText").textContent = text;
    }

    function log(msg){
      const box = $("logBox");
      const t = `[${new Date().toISOString().slice(11,19)}] ${msg}`;
      box.textContent = (box.textContent || "").split("\n").slice(-140).join("\n");
      box.textContent += (box.textContent ? "\n" : "") + t;
      box.scrollTop = box.scrollHeight;
      console.log("[Darrius Frontend]", msg);
    }

    // =========================
    // Chart + Demo data
    // =========================
    let chart=null, candle=null, ema=null, aux=null;

    function genDemoCandles(n=220){
      const now = Math.floor(Date.now()/1000);
      const step = 60*60; // 1h
      let t = now - n*step;
      let price = 67000;
      const arr = [];

      for(let i=0;i<n;i++){
        const drift = Math.sin(i/18)*140;
        const noise = (Math.random()-0.5)*260;
        const open = price;
        const close = open + drift + noise;

        const high = Math.max(open, close) + Math.random()*220;
        const low  = Math.min(open, close) - Math.random()*220;

        price = close;

        arr.push({
          time: t,
          open: +open.toFixed(2),
          high: +high.toFixed(2),
          low:  +low.toFixed(2),
          close:+close.toFixed(2),
        });
        t += step;
      }
      return arr;
    }

    function calcEMA(bars, period=20){
      const k = 2/(period+1);
      let emaPrev = null;
      const out = [];
      for(const b of bars){
        const v = b.close;
        if(emaPrev === null) emaPrev = v;
        else emaPrev = v*k + emaPrev*(1-k);
        out.push({ time: b.time, value: +emaPrev.toFixed(2) });
      }
      return out;
    }

    function setPulse(score){
      score = Math.max(0, Math.min(100, score));
      $("pulseScore").textContent = String(score);
      const deg = Math.round(score/100*360);
      $("pulseGauge").style.background =
        `conic-gradient(var(--green) 0deg, var(--green) ${deg}deg, rgba(255,255,255,.10) ${deg}deg, rgba(255,255,255,.10) 360deg)`;
      $("pulseTag").textContent = score>=60 ? "BULL" : (score<=40 ? "BEAR" : "NEUTRAL");
      $("pulseTag").style.background = score>=60 ? "rgba(43,226,166,.90)" : (score<=40 ? "rgba(255,90,90,.88)" : "rgba(255,184,108,.90)");
    }

    function setSignal(side, price, tf){
      const row = $("signalRow");
      row.classList.remove("buy","sell","neutral");
      $("signalTf").textContent = "TF: " + tf.toUpperCase();

      if(side==="BUY"){
        row.classList.add("buy");
        $("signalSide").textContent = "BUY Â· ä¹°å…¥";
        $("signalMeta").textContent = "High-probability inflection detected (demo). / æ¼”ç¤ºä¿¡å·";
        $("signalPx").textContent = "@ " + price;
      }else if(side==="SELL"){
        row.classList.add("sell");
        $("signalSide").textContent = "SELL Â· å–å‡º";
        $("signalMeta").textContent = "Risk-off inflection detected (demo). / æ¼”ç¤ºä¿¡å·";
        $("signalPx").textContent = "@ " + price;
      }else{
        row.classList.add("neutral");
        $("signalSide").textContent = "Waitingâ€¦";
        $("signalMeta").textContent = "Waiting for dataâ€¦ / ç­‰å¾…æ•°æ®â€¦";
        $("signalPx").textContent = "â€”";
      }
    }

    function initChart(){
      if(typeof LightweightCharts==="undefined"){
        setStatus("Chart lib missing", false);
        log("âŒ lightweight-charts æœªåŠ è½½");
        return;
      }

      const el = $("chart");
      chart = LightweightCharts.createChart(el, {
        layout: { background: { color: "transparent" }, textColor: "#E6EDF3" },
        grid: {
          vertLines: { color: "rgba(255,255,255,.04)" },
          horzLines: { color: "rgba(255,255,255,.04)" },
        },
        rightPriceScale: { borderVisible:false },
        timeScale: { timeVisible:true, secondsVisible:false, borderVisible:false },
        crosshair: { mode: 1 },
      });

      candle = chart.addCandlestickSeries({
        upColor: "#2BE2A6",
        downColor:"#FF5A5A",
        wickUpColor:"#2BE2A6",
        wickDownColor:"#FF5A5A",
        borderVisible:false,
      });

      // EMA and Aux line placeholders
      ema = chart.addLineSeries({ lineWidth: 2, color: "rgba(76,194,255,.92)" });
      aux = chart.addLineSeries({ lineWidth: 2, color: "rgba(255,184,108,.88)" });

      function fit(){
        const r = el.getBoundingClientRect();
        chart.applyOptions({
          width: Math.max(1, Math.floor(r.width)),
          height: Math.max(1, Math.floor(r.height)),
        });
        chart.timeScale().fitContent();
      }
      const ro = new ResizeObserver(() => fit());
      ro.observe(el);
      window.addEventListener("resize", fit);

      // initial demo
      const bars = genDemoCandles(220);
      candle.setData(bars);

      const emaData = calcEMA(bars, 20);
      ema.setData(emaData);

      // Aux: just another smoothed line (demo)
      const auxData = calcEMA(bars, 50);
      aux.setData(auxData);

      const last = bars[bars.length-1];
      $("symText").textContent = "BTCUSDT";
      $("priceText").textContent = last.close.toFixed(2);
      $("hintText").textContent = "Demo chart loaded Â· æ¼”ç¤ºå›¾è¡¨å·²åŠ è½½";
      setStatus("Ready Â· å‰ç«¯å·²å°±ç»ª", true);

      // demo left panel values
      setPulse(76);
      $("riskEntry").textContent = (last.close*0.985).toFixed(2);
      $("riskStop").textContent  = (last.close*0.970).toFixed(2);
      $("riskTargets").textContent = [(last.close*1.01).toFixed(2),(last.close*1.02).toFixed(2),(last.close*1.035).toFixed(2)].join(", ");
      $("riskConf").textContent = "92%";
      $("riskWR").textContent = "72%";

      setSignal(Math.random()>0.5?"BUY":"SELL", last.close.toFixed(2), $("tf").value);
      fit();
    }

    function applyToggles(){
      const showEma = $("tgEMA").checked;
      const showAux = $("tgAux").checked;
      ema.applyOptions({ visible: !!showEma });
      aux.applyOptions({ visible: !!showAux });
    }

    function updateTrialHint(){
      const plan = $("planSelect").value;
      const t = PRICE_MAP[plan]?.trial_days ?? 0;
      $("trialHint").textContent = t>0 ? `Trial ${t} day(s)` : "No trial";
    }

    // =========================
    // API calls
    // =========================
    async function apiGet(path){
      const resp = await fetch(`${API_BASE}${path}`, { method:"GET" });
      const txt = await resp.text();
      if(!resp.ok) throw new Error(`HTTP ${resp.status}: ${txt.slice(0,160)}`);
      try{ return JSON.parse(txt); }catch(_){ return txt; }
    }

    async function testHealth(){
      try{
        setStatus("Checking APIâ€¦", true);
        $("hintText").textContent = "Testing API healthâ€¦";
        const data = await apiGet("/health");
        setStatus("API OK", true);
        $("hintText").textContent = "API connected Â· å·²è¿æ¥ API";
        log(`âœ… /health OK: ${typeof data==="string"?data:JSON.stringify(data).slice(0,220)}`);
      }catch(e){
        setStatus("API Not Ready", false);
        $("hintText").textContent = "API not ready Â· APIæœªå°±ç»ª";
        log(`âš ï¸ /health failed: ${e.message}`);
      }
    }

    async function showRoutes(){
      try{
        setStatus("Loading routesâ€¦", true);
        const data = await apiGet("/routes");
        setStatus("Routes OK", true);
        log(`âœ… /routes: ${JSON.stringify(data).slice(0,500)}...`);
      }catch(e){
        setStatus("Routes failed", false);
        log(`âŒ /routes failed: ${e.message}`);
      }
    }

    async function subscribe(){
      const user_id = ($("userId").value || "").trim();
      const email = ($("email").value || "").trim();
      const plan = $("planSelect").value;

      if(!user_id){
        alert("User ID å¿…å¡«ï¼ˆç”¨äºæŠŠ Stripe è®¢é˜…ç»‘å®šåˆ°ä½ çš„ç³»ç»Ÿç”¨æˆ·ï¼‰ã€‚\n\nè¯·å…ˆå¡«å†™ User IDã€‚");
        $("userId").focus();
        return;
      }

      const { price_id, trial_days } = PRICE_MAP[plan] || {};
      if(!price_id){
        alert("Plan mapping missing. è¯·æ£€æŸ¥ PRICE_MAP é…ç½®ã€‚");
        return;
      }

      try{
        setStatus("Creating checkoutâ€¦", true);
        log(`â¡ï¸ POST /billing/checkout user_id=${user_id} plan=${plan} price_id=${price_id} trial=${trial_days}`);

        const resp = await fetch(`${API_BASE}/billing/checkout`, {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ user_id, email: email || undefined, price_id })
        });

        const txt = await resp.text();
        if(!resp.ok) throw new Error(`HTTP ${resp.status}: ${txt.slice(0,200)}`);

        let data = null;
        try{ data = JSON.parse(txt); }catch(_){ data = { raw: txt }; }

        if(!data || !data.checkout_url){
          throw new Error("No checkout_url returned");
        }

        setStatus("Redirecting to Stripeâ€¦", true);
        log(`âœ… checkout_url received. Redirecting...`);
        window.location.href = data.checkout_url;

      }catch(e){
        setStatus("Network/API error", false);
        log(`âŒ subscribe failed: ${e.message}`);
        alert("è®¢é˜…å¤±è´¥ï¼šç½‘ç»œé”™è¯¯/åç«¯æœªè”é€šæˆ–æ¥å£æŠ¥é”™ã€‚\n\nè¯·çœ‹å³ä¸‹æ—¥å¿—ï¼ˆDiagnosticsï¼‰ã€‚\n\né”™è¯¯ï¼š\n" + e.message);
      }
    }

    // =========================
    // Utilities
    // =========================
    async function copyShareLink(){
      const sym = ($("symbol").value || "BTCUSDT").trim().toUpperCase();
      const tf = $("tf").value;
      const url = `${location.origin}${location.pathname}?symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tf)}`;
      try{
        await navigator.clipboard.writeText(url);
        log("âœ… Share link copied: " + url);
        alert("å·²å¤åˆ¶åˆ†äº«é“¾æ¥ï¼š\n" + url);
      }catch(e){
        log("âš ï¸ Clipboard failed. " + e.message);
        prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š", url);
      }
    }

    function exportPNG(){
      try{
        if(!chart || typeof chart.takeScreenshot !== "function"){
          alert("å½“å‰å›¾è¡¨ç‰ˆæœ¬ä¸æ”¯æŒ takeScreenshotã€‚");
          return;
        }
        const canvas = chart.takeScreenshot();
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        const sym = ($("symbol").value || "BTCUSDT").trim().toUpperCase();
        const tf = $("tf").value;
        a.download = `DarriusAI_${sym}_${tf}.png`;
        a.click();
        log("âœ… Export PNG done.");
      }catch(e){
        log("âŒ Export failed: " + e.message);
        alert("å¯¼å‡ºå¤±è´¥ï¼š" + e.message);
      }
    }

    function load(){
      const sym = ($("symbol").value || "BTCUSDT").trim().toUpperCase();
      const tf = $("tf").value;

      $("symText").textContent = sym;
      $("hintText").textContent = "Loadingâ€¦ / åŠ è½½ä¸­ï¼ˆæ¼”ç¤ºæ•°æ®ï¼‰";

      // For now we keep demo data; later connect to your backend feed.
      const bars = genDemoCandles(220);
      candle.setData(bars);
      ema.setData(calcEMA(bars, 20));
      aux.setData(calcEMA(bars, 50));
      applyToggles();

      const last = bars[bars.length-1];
      $("priceText").textContent = last.close.toFixed(2);

      // Update left panel demo risk based on last price
      $("riskEntry").textContent = (last.close*0.985).toFixed(2);
      $("riskStop").textContent  = (last.close*0.970).toFixed(2);
      $("riskTargets").textContent = [(last.close*1.01).toFixed(2),(last.close*1.02).toFixed(2),(last.close*1.035).toFixed(2)].join(", ");
      $("riskConf").textContent = "92%";
      $("riskWR").textContent = "72%";

      setSignal(Math.random()>0.5?"BUY":"SELL", last.close.toFixed(2), tf);
      log(`âœ… Loaded (demo): symbol=${sym} tf=${tf}`);
      $("hintText").textContent = "Loaded Â· å·²åŠ è½½ï¼ˆæ¼”ç¤ºæ•°æ®ï¼‰";
    }

    // Boot
    (function boot(){
      // URL params
      const p = new URLSearchParams(location.search);
      const qsSym = p.get("symbol");
      const qsTf  = p.get("tf");
      if(qsSym) $("symbol").value = qsSym.toUpperCase();
      if(qsTf) $("tf").value = qsTf;

      // trial hint
      updateTrialHint();

      // init chart
      initChart();

      // listeners
      $("tgEMA").addEventListener("change", applyToggles);
      $("tgAux").addEventListener("change", applyToggles);
      $("planSelect").addEventListener("change", updateTrialHint);

      $("loadBtn").addEventListener("click", load);
      $("subscribeBtn").addEventListener("click", subscribe);

      $("healthBtn").addEventListener("click", testHealth);
      $("routesBtn").addEventListener("click", showRoutes);

      $("copyLinkBtn").addEventListener("click", copyShareLink);
      $("exportBtn").addEventListener("click", exportPNG);

      // initial toggles
      applyToggles();

      log("Booting frontendâ€¦");
      log("API_BASE=" + API_BASE);
      log("Stripe plans loaded: weekly/monthly/quarterly/yearly");
    })();
  </script>
</body>
</html>
