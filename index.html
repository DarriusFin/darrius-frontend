<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DarriusAI · Inflection Hunter | AI 拐点决策系统</title>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0B0F17;
      --bg2:#0A1220;

      --panel:#121A28;
      --panel2:#0F1726;

      --border:rgba(255,255,255,.08);
      --border2:rgba(255,255,255,.10);

      --text:#EAF0F7;
      --muted:#A2B0C2;

      --brand1:#2BE2A6; /* green */
      --brand2:#4CC2FF; /* blue */
      --warn:#FFB86C;
      --danger:#FF5A5A; /* red */

      --shadow: 0 18px 45px rgba(0,0,0,.40);
      --shadow2: 0 10px 25px rgba(0,0,0,.28);

      --r12:12px;
      --r14:14px;
      --r18:18px;

      --gradBrand: linear-gradient(90deg, rgba(43,226,166,1) 0%, rgba(76,194,255,1) 100%);
      --gradBrandSoft: linear-gradient(90deg, rgba(43,226,166,.18) 0%, rgba(76,194,255,.18) 100%);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,194,255,.10), transparent 60%),
        radial-gradient(900px 520px at 88% 12%, rgba(43,226,166,.10), transparent 62%),
        radial-gradient(700px 420px at 50% 92%, rgba(255,184,108,.06), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
      overflow:hidden;
    }

    a{ color: rgba(76,194,255,.95); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* ===== Header ===== */
    #topbar{
      height:78px;
      padding:0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(10,15,23,.55);
      backdrop-filter: blur(10px);
    }

    #brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:420px;
    }

    .logo{
      width:48px;height:48px;border-radius:16px;
      background: var(--gradBrandSoft);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
      position:relative;
      overflow:hidden;
      flex:0 0 auto;
    }
    /* ✅ 旋转图形：加入绿↔红↔蓝的渐变，贴合涨跌视觉 */
    .logo::after{
      content:"";
      position:absolute; inset:-55%;
      background: conic-gradient(from 180deg,
        rgba(43,226,166,0),
        rgba(43,226,166,.70),
        rgba(76,194,255,.70),
        rgba(255,90,90,.65),
        rgba(43,226,166,0));
      animation: spin 6s linear infinite;
      filter: drop-shadow(0 0 12px rgba(76,194,255,.25));
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    #brandText{ line-height:1.08; }
    /* ✅ 左上角更醒目：DarriusAI + Inflection Hunter 放大 */
    #brandLine1{
      font-weight:950;
      letter-spacing:.3px;
      font-size:26px;
    }
    #brandLine1 .accent{
      background: var(--gradBrand);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow: 0 0 22px rgba(76,194,255,.10);
    }
    #brandLine2{
      margin-top:8px;
      color:var(--muted);
      font-size:14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chip{
      font-size:13px;
      padding:6px 11px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,247,.90);
      white-space:nowrap;
    }
    .chip.brand{
      border:1px solid rgba(43,226,166,.30);
      background: rgba(43,226,166,.12);
      color: rgba(234,240,247,.95);
    }

    #topRight{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width:360px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,26,40,.65);
      box-shadow: var(--shadow2);
      font-size:12px;
      color: var(--text);
      white-space:nowrap;
      max-width: 42vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--brand1);
      box-shadow: 0 0 0 4px rgba(43,226,166,.10);
      flex:0 0 auto;
    }
    .pill.bad .dot{
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(255,90,90,.10);
    }

    #copyright{
      font-size:12px;
      color: rgba(234,240,247,.68);
      background: rgba(0,0,0,.16);
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
      white-space:nowrap;
    }

    /* ===== Main Layout ===== */
    #main{
      height: calc(100vh - 78px);
      padding:16px;
      display:grid;
      grid-template-columns: 330px 1fr 380px;
      gap:16px;
      min-height:0;
    }

    .panel{
      background: linear-gradient(180deg, rgba(18,26,40,.92), rgba(15,23,38,.88));
      border: 1px solid var(--border);
      border-radius: var(--r18);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panelHeader{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .panelHeader .h{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panelHeader .h .tag{
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,247,.92);
    }
    .panelBody{
      padding:14px;
      overflow:auto;
      min-height:0;
    }

    .card{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--r14);
      padding:12px;
      margin-bottom:12px;
    }

    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      color: var(--muted);
      font-size:12px;
    }
    .cardTitle b{
      color: var(--text);
      font-size:12.5px;
      font-weight:900;
    }

    .small{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      font-size:12px;
      color: var(--muted);
    }
    .kv b{ color: var(--text); font-weight:900; }

    /* ===== Gauge ===== */
    .gaugeWrap{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .gauge{
      width:160px;height:160px;border-radius:50%;
      background: conic-gradient(rgba(255,255,255,.10) 0deg, rgba(255,255,255,.10) 360deg);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      position:relative;
      flex:0 0 auto;
    }
    .gauge::after{
      content:"";
      position:absolute; inset:14px;
      border-radius:50%;
      background: rgba(10,15,23,.92);
      border:1px solid rgba(255,255,255,.06);
    }
    .gaugeCenter{
      position:absolute; inset:0;
      z-index:2;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      text-align:center;
    }
    .gaugeCenter .num{
      font-size:36px;
      font-weight:950;
      letter-spacing:.6px;
    }
    .gaugeCenter .lbl{
      margin-top:2px;
      font-size:12px;
      color: var(--muted);
    }

    /* ===== Signal box ===== */
    .signalBox{
      border-radius: var(--r14);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .signal{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      background: rgba(0,0,0,.16);
      border-left: 4px solid rgba(255,255,255,.10);
    }
    .signal.buy{ border-left-color: var(--brand1); }
    .signal.sell{ border-left-color: var(--danger); }
    .signal.neutral{ border-left-color: rgba(255,255,255,.14); }
    /* ✅ 信号更权威、更亮 */
    .signal .side{
      font-weight:950;
      letter-spacing:.4px;
      font-size:16px;
      text-shadow: 0 0 14px rgba(255,255,255,.10);
    }
    .signal.buy .side{ text-shadow: 0 0 16px rgba(43,226,166,.22); }
    .signal.sell .side{ text-shadow: 0 0 16px rgba(255,90,90,.22); }
    .signal .meta{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }

    /* ===== Left footer disclaimer ===== */
    #leftDisclaimer{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,.06);
      font-size:11px;
      line-height:1.55;
      color: rgba(234,240,247,.72);
    }
    #leftDisclaimer b{ color: rgba(234,240,247,.92); }

    /* ===== Center Chart ===== */
    #chartPanel .panelBody{ padding:0; }
    #chartTop{
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
    }
    #chartTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    #priceLine{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
    }
    /* ✅ 核心图左上角 Symbol 字体加大 */
    #priceLine .sym{
      font-size:18px;
      color: rgba(234,240,247,.90);
      font-weight:950;
      letter-spacing:.4px;
    }
    #priceText{
      font-size:16px;
      color: rgba(234,240,247,.95);
    }

    #hintText{
      font-size:12px;
      color: var(--muted);
      max-width:55%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ✅ Timeframe Tabs（补齐 5m/15m/30m/1h/4h/1D/1W/1M） */
    #tfTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    #tfTabs button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: rgba(234,240,247,.90);
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      transition: filter .12s ease, transform .06s ease;
    }
    #tfTabs button:hover{ filter: brightness(1.06); }
    #tfTabs button:active{ transform: translateY(1px); }
    #tfTabs button.active{
      border-color: rgba(76,194,255,.38);
      background: rgba(76,194,255,.12);
      box-shadow: 0 0 0 4px rgba(76,194,255,.10);
    }

    #chart{
      height: calc(100vh - 78px - 16px - 16px - 86px);
      min-height:420px;
      width:100%;
    }

    /* ===== Right Controls ===== */
    .field{ margin-bottom:10px; }
    .label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
      font-size:12px;
      color: var(--muted);
    }
    .label b{ color: var(--text); }

    input, select{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 10px;
      border-radius: var(--r12);
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(162,176,194,.80); }
    input:focus, select:focus{
      border-color: rgba(76,194,255,.50);
      box-shadow: 0 0 0 4px rgba(76,194,255,.12);
    }

    .btn{
      width:100%;
      border:0;
      color:#081119;
      font-weight:950;
      letter-spacing:.3px;
      padding:12px 12px;
      border-radius: var(--r12);
      cursor:pointer;
      background: var(--gradBrand);
      box-shadow: var(--shadow2);
      transition: transform .06s ease, filter .15s ease;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight:900;
      padding:11px 12px;
      border-radius: var(--r12);
      cursor:pointer;
      background: rgba(0,0,0,.14);
      transition: transform .06s ease, filter .15s ease;
    }
    .btnGhost:hover{ filter: brightness(1.05); }
    .btnGhost:active{ transform: translateY(1px); }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .note{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .note b{ color: var(--text); }

    .hr{
      height:1px;
      background: rgba(255,255,255,.06);
      margin:12px 0;
    }

    /* ===== Subscription ===== */
    .subHero{
      border-radius: var(--r14);
      padding:12px;
      background: linear-gradient(180deg, rgba(43,226,166,.14), rgba(76,194,255,.10));
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    .subHeroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .subHeroTitle{
      font-weight:950;
      letter-spacing:.2px;
    }
    .subHeroTitle .accent{
      background: var(--gradBrand);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .subHeroMeta{
      color: rgba(234,240,247,.75);
      font-size:12px;
      line-height:1.35;
      margin-top:5px;
    }
    .badge{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
      color: rgba(234,240,247,.88);
    }
    .badge.secure{
      border-color: rgba(76,194,255,.28);
      background: rgba(76,194,255,.10);
    }

    .subHintRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color: var(--muted);
      margin-top:8px;
      flex-wrap:wrap;
    }
    .subHintRow .trial{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,247,.90);
    }

    /* ===== Subscription status pill ===== */
    #subscriptionStatus{
      margin-top:10px;
      padding:10px 10px;
      border-radius: var(--r12);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      font-size:12px;
      color: rgba(234,240,247,.86);
      line-height:1.35;
    }

    /* ===== Diagnostics hidden by default (Admin only) ===== */
    .hidden{ display:none !important; }

    #logBox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--r12);
      padding:10px;
      color: rgba(234,240,247,.86);
      height:120px;
      overflow:auto;
      white-space:pre-wrap;
    }

    @media (max-width: 1180px){
      body{ overflow:auto; }
      #main{
        height:auto;
        grid-template-columns: 1fr;
      }
      #chart{ height: 560px; }
      #brand{ min-width:0; }
      #topRight{ min-width:0; }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div id="topbar">
    <div id="brand">
      <div class="logo"></div>
      <div id="brandText">
        <div id="brandLine1">
          <span class="accent">DarriusAI</span> · Inflection Hunter
        </div>
        <div id="brandLine2">
          <span class="chip brand">AI 拐点决策系统</span>
          <span class="chip">拐点猎手</span>
        </div>
      </div>
    </div>

    <div id="topRight">
      <div id="statusBadge" class="pill">
        <span class="dot"></span>
        <span id="statusText">Ready · 前端已就绪</span>
      </div>
      <div id="copyright">© <span id="yearNow"></span> Darrius FinTech Inc. All Rights Reserved.</div>
    </div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div class="panel" id="leftPanel">
      <div class="panelHeader">
        <div class="h">Market Pulse · 市场情绪 <span class="tag" id="pulseTag">LIVE</span></div>
      </div>
      <div class="panelBody">

        <div class="card">
          <div class="gaugeWrap">
            <div class="gauge" id="pulseGauge">
              <div class="gaugeCenter">
                <div class="num" id="pulseScore">—</div>
                <div class="lbl">Sentiment</div>
              </div>
            </div>
            <div style="flex:1">
              <div class="kv">
                <span>Bullish</span><b id="bullPct">—</b>
                <span>Bearish</span><b id="bearPct" style="color:var(--danger)">—</b>
                <span>Neutral</span><b id="neuPct">—</b>
                <span>Net Inflow</span><b id="netInflow" style="color:var(--brand1)">—</b>
              </div>
              <div class="small" style="margin-top:10px">
                说明：本页演示版已做“情绪/信号一致性”，后续接入真实情绪/资金流数据源即可替换。
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardTitle"><b>Risk Copilot · 风险助手</b><span class="small" id="riskMode">Auto</span></div>
          <div class="kv">
            <span>Entry · 入场</span><b id="riskEntry">—</b>
            <span>Stop · 止损</span><b id="riskStop" style="color:var(--danger)">—</b>
            <span>Targets · 目标</span><b id="riskTargets">—</b>
            <span>Confidence · 强度</span><b id="riskConf">—</b>
            <span>Backtest WinRate · 回测胜率</span><b id="riskWR">—</b>
          </div>
        </div>

        <div class="signalBox">
          <div class="signal neutral" id="signalRow">
            <div>
              <div class="side" id="signalSide">Waiting…</div>
              <div class="meta" id="signalMeta">等待数据…</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:950" id="signalPx">—</div>
              <div class="meta" id="signalTf">TF: —</div>
            </div>
          </div>
        </div>

        <!-- ✅ Affiliate moved to LEFT bottom -->
        <div class="card" id="affiliateCard" style="margin-top:12px">
          <div class="cardTitle"><b>Affiliate · 推荐人</b><span class="small">预留入口</span></div>
          <button class="btnGhost" id="affiliateBtn">Affiliate / 推荐人入口</button>
          <div class="note" style="margin-top:10px">
            预留：未来推荐人可在此获取专属链接/代码，并进入后台查看推荐客户数与返佣金额（例如 20%）。
          </div>
        </div>

        <!-- Disclaimer -->
        <div id="leftDisclaimer">
          <div><b>English:</b> For educational and informational purposes only. Not investment advice. Trading involves risk.</div>
          <div style="margin-top:6px"><b>中文：</b> 本系统仅用于教学与信息展示，不构成投资建议。金融市场有风险，请独立决策。</div>
          <div style="margin-top:6px; opacity:.9">
            Links: <a href=" " target="_blank" rel="noreferrer">darrius.ai</a> ·
            <a href="#" onclick="alert('后续可接：Terms / Privacy / Contact');return false;">Terms</a> ·
            <a href="#" onclick="alert('后续可接：Terms / Privacy / Contact');return false;">Privacy</a> ·
            <a href="#" onclick="alert('后续可接：support@darrius.ai');return false;">Support</a>
          </div>
        </div>

      </div>
    </div>

    <!-- CENTER -->
    <div class="panel" id="chartPanel">
      <div id="chartTop">
        <div id="chartTopRow">
          <div id="priceLine">
            <span class="sym" id="symText">—</span>
            <span id="priceText">—</span>
          </div>
          <div id="hintText">Loading…</div>
        </div>

        <!-- ✅ Timeframe Tabs -->
        <div id="tfTabs">
          <button data-tf="5m">5m</button>
          <button data-tf="15m">15m</button>
          <button data-tf="30m">30m</button>
          <button data-tf="1h">1h</button>
          <button data-tf="4h">4h</button>
          <button data-tf="1d" class="active">1D</button>
          <button data-tf="1w">1W</button>
          <button data-tf="1m">1M</button>
        </div>
      </div>

      <div class="panelBody">
        <div id="chart"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel" id="rightPanel">
      <div class="panelHeader">
        <div class="h">Control Center · 控制台</div>
      </div>

      <div class="panelBody">
        <!-- Data Source (Reserved for future real data) -->
        <div class="card">
          <div class="cardTitle"><b>Data Source · 数据源</b><span class="small">预留接口</span></div>
          <div class="field">
            <div class="label"><span>Source · 来源</span><span class="small">未来接第三方实盘</span></div>
            <select id="dataSource">
              <option value="demo">Demo (Local)</option>
              <option value="provider">3rd-Party Provider (Reserved)</option>
            </select>
          </div>
          <div class="note">
            <b>说明：</b>未来你购买股票/外汇/黄金等实盘数据后，只需实现 <code>fetchMarketData()</code> 连接新 API 即可。
          </div>
        </div>

        <!-- Market Control -->
        <div class="card">
          <div class="cardTitle"><b>Market · 品种与周期</b><span class="small">Chart</span></div>

          <div class="field">
            <div class="label"><span>Symbol · 品种</span><span class="small">(如 BTCUSDT)</span></div>
            <input id="symbol" value="BTCUSDT"/>
          </div>

          <!-- ✅ TF 下拉补齐，且与顶部 Tabs 同步 -->
          <div class="field">
            <div class="label"><span>Timeframe · 周期</span></div>
            <select id="tf">
              <option value="5m">5m · 5分钟</option>
              <option value="15m">15m · 15分钟</option>
              <option value="30m">30m · 30分钟</option>
              <option value="1h">1h · 1小时</option>
              <option value="4h">4h · 4小时</option>
              <option value="1d" selected>1d · 日线</option>
              <option value="1w">1w · 周线</option>
              <option value="1m">1m · 月线</option>
            </select>
          </div>

          <button class="btn" id="loadBtn">Load · 加载</button>

          <div class="row2">
            <label class="btnGhost" style="display:flex;align-items:center;justify-content:center;gap:8px;">
              <input type="checkbox" id="tgEMA" checked style="width:auto;margin:0;transform:translateY(1px)">
              EMA
            </label>
            <label class="btnGhost" style="display:flex;align-items:center;justify-content:center;gap:8px;">
              <input type="checkbox" id="tgAux" checked style="width:auto;margin:0;transform:translateY(1px)">
              AUX
            </label>
          </div>

          <!-- ✅ 商业机密：不展示 EMA/AUX period（已移除 UI 输入） -->
          <div class="note" style="margin-top:8px">
            <b>提示：</b>EMA/AUX 的内部参数为商业机密，对用户侧隐藏。系统会自动适配不同周期下的敏感性与平滑度。
          </div>
        </div>

        <!-- Subscription -->
        <div class="subHero">
          <div class="subHeroTop">
            <div>
              <div class="subHeroTitle"><span class="accent">Subscription</span> · 订阅开通</div>
              <div class="subHeroMeta">
                ✅ 后端 <code>/api/plans</code> 作为唯一真相；已订阅用户使用 Customer Portal 管理（升级/取消/恢复/换卡/发票）。
              </div>
            </div>
            <div class="badge secure">Stripe Secure</div>
          </div>

          <div class="subHintRow">
            <div>试用需绑定信用卡；到期未付费会自动取消权限。</div>
            <div class="trial" id="trialHint">Trial</div>
          </div>

          <div id="subscriptionStatus">Status: —</div>
        </div>

        <div class="card" style="margin-top:-2px">
          <div class="field">
            <div class="label"><span><b>User ID</b> · 用户ID</span><span class="small">（必填）</span></div>
            <input id="userId" placeholder="例如：user_123 / 你的系统用户ID"/>
          </div>

          <div class="field">
            <div class="label"><span>Email · 邮箱</span><span class="small">（建议填）</span></div>
            <input id="email" placeholder="用于收据 / 首次兜底匹配"/>
          </div>

          <div class="field">
            <div class="label"><span>Plan · 套餐</span><span class="small" id="planStatus">从后端拉取…</span></div>
            <select id="planSelect">
              <option value="">Loading…</option>
            </select>
          </div>

          <!-- ✅ 可保留 Override 作为兜底，但默认不使用（不会影响 plans 稳定性） -->
          <div class="field">
            <div class="label"><span>Price ID Override</span><span class="small">（兜底）</span></div>
            <input id="priceOverride" placeholder="如：price_xxx（通常无需填）"/>
          </div>

          <!-- ✅ Start / Manage 两个按钮配套齐全 -->
          <button class="btn" id="btnStartSub" disabled>Start Subscription · 开通订阅</button>
          <div style="height:10px"></div>
          <button class="btnGhost" id="btnManageSub" style="display:none">Manage Subscription · 管理订阅（升级/取消/恢复/换卡/发票）</button>

          <div class="note" style="margin-top:10px">
            <b>说明：</b>套餐永不为空：前端只拉 <code>/api/plans</code>，并通过 <code>/api/subscription/status</code> 判断权限状态。
          </div>
        </div>

        <!-- Share & Export -->
        <div class="card">
          <div class="cardTitle"><b>Share & Export · 分享与导出</b><span class="small">Utilities</span></div>
          <button class="btnGhost" id="copyLinkBtn">Copy Share Link · 复制分享链接</button>
          <div style="height:10px"></div>
          <button class="btnGhost" id="exportBtn">Export PNG · 导出图片（含图表）</button>
        </div>

        <!-- Diagnostics (Admin only) -->
        <div class="card hidden" id="diagCard">
          <div class="cardTitle"><b>Diagnostics · 诊断</b><span class="small">Admin only</span></div>
          <div class="row2" style="margin-top:0">
            <button class="btnGhost" id="healthBtn">Health</button>
            <button class="btnGhost" id="routesBtn">Routes</button>
          </div>
          <div style="height:10px"></div>
          <div id="logBox"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /***************
     * Config
     ***************/
    const API_BASE = "https://darrius-api.onrender.com";
    function $(id){ return document.getElementById(id); }

    function setStatus(text, ok=true){
      const badge = $("statusBadge");
      badge.classList.toggle("bad", !ok);
      $("statusText").textContent = text;
    }

    function log(msg){
      const card = $("diagCard");
      if(card.classList.contains("hidden")) return;
      const box = $("logBox");
      const t = `[${new Date().toISOString().slice(11,19)}] ${msg}`;
      const old = (box.textContent || "").split("\n");
      const clipped = old.slice(Math.max(0, old.length - 160)).join("\n");
      box.textContent = clipped + (clipped ? "\n" : "") + t;
      box.scrollTop = box.scrollHeight;
      console.log("[DarriusAI]", msg);
    }

    /***************
     * Admin Mode
     ***************/
    function isAdmin(){
      const p = new URLSearchParams(location.search);
      return p.get("admin")==="1";
    }

    /***************
     * API helpers
     ***************/
    async function apiGet(path){
      const resp = await fetch(`${API_BASE}${path}`, { method:"GET" });
      const txt = await resp.text();
      if(!resp.ok) throw new Error(`HTTP ${resp.status}: ${txt.slice(0,180)}`);
      try{ return JSON.parse(txt); }catch(_){ return txt; }
    }
    async function apiPost(path, body){
      const resp = await fetch(`${API_BASE}${path}`, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body || {})
      });
      const txt = await resp.text();
      if(!resp.ok) throw new Error(`HTTP ${resp.status}: ${txt.slice(0,240)}`);
      try{ return JSON.parse(txt); }catch(_){ return { raw: txt }; }
    }

    /***************
     * Chart + Indicators
     ***************/
    let chart=null, candle=null, ema=null, aux=null;

    function genDemoCandles(n=220, tf="1d"){
      const now = Math.floor(Date.now()/1000);
      const tfMap = { "5m":300, "15m":900, "30m":1800, "1h":3600, "4h":14400, "1d":86400, "1w":604800, "1m":2592000 };
      const step = tfMap[tf] || 3600;
      let t = now - n*step;
      let price = 67000;
      const arr = [];
      for(let i=0;i<n;i++){
        const wave = Math.sin(i/18)*160;
        const noise = (Math.random()-0.5)*300;
        const open = price;
        const close = open + wave + noise;
        const high = Math.max(open, close) + Math.random()*250;
        const low  = Math.min(open, close) - Math.random()*250;
        price = close;
        arr.push({ time:t, open:+open.toFixed(2), high:+high.toFixed(2), low:+low.toFixed(2), close:+close.toFixed(2) });
        t += step;
      }
      return arr;
    }

    function calcEMA(bars, period){
      const p = Math.max(2, Number(period)||10);
      const k = 2/(p+1);
      let prev = null;
      const out = [];
      for(const b of bars){
        const v = b.close;
        prev = (prev===null) ? v : (v*k + prev*(1-k));
        out.push({ time:b.time, value:+prev.toFixed(2) });
      }
      return out;
    }

    function applyToggles(){
      ema.applyOptions({ visible: !!$("tgEMA").checked });
      aux.applyOptions({ visible: !!$("tgAux").checked });
    }

    /***************
     * ✅ B/S: Cross + EMA slope flip + cooldown
     * - Mark on confirmation bar (not cross bar)
     * - Market Pulse filter optional (default off)
     ***************/
    function generateBSSignals(emaSeries, auxSeries, bars, opts={}){
      const cooldownBars = Number(opts.cooldownBars ?? 12);
      const usePulseFilter = !!opts.usePulseFilter;
      const pulseBias = (opts.pulseBias || "NEUTRAL").toUpperCase(); // "BULL"/"BEAR"/"NEUTRAL"

      const n = Math.min(emaSeries.length, auxSeries.length, bars.length);
      if(n < 3) return [];

      let pending = null; // {side:"B"/"S", crossIndex:number}
      let lastSignalIndex = -1e9;
      const markers = [];

      function slope(i){
        return emaSeries[i].value - emaSeries[i-1].value;
      }

      for(let t=1; t<n; t++){
        const emaPrev = emaSeries[t-1].value, emaNow = emaSeries[t].value;
        const auxPrev = auxSeries[t-1].value, auxNow = auxSeries[t].value;

        const crossUp = (auxPrev <= emaPrev) && (auxNow > emaNow);
        const crossDn = (auxPrev >= emaPrev) && (auxNow < emaNow);

        if(crossUp) pending = { side:"B", crossIndex:t };
        else if(crossDn) pending = { side:"S", crossIndex:t };

        if(!pending) continue;

        if(t - lastSignalIndex < cooldownBars) continue;

        const sNow = slope(t);
        const sPrev = slope(t-1);

        if(pending.side==="B"){
          let confirmed = (sNow > 0) && (sPrev <= 0);
          if(usePulseFilter && pulseBias==="BEAR") confirmed = false;
          if(confirmed){
            markers.push({
              time: bars[t].time,
              position: "belowBar",
              color: "#29ff7a",
              shape: "text",
              text: "B",
            });
            lastSignalIndex = t;
            pending = null;
          }
        }else{
          let confirmed = (sNow < 0) && (sPrev >= 0);
          if(usePulseFilter && pulseBias==="BULL") confirmed = false;
          if(confirmed){
            markers.push({
              time: bars[t].time,
              position: "aboveBar",
              color: "#ff3b3b",
              shape: "text",
              text: "S",
            });
            lastSignalIndex = t;
            pending = null;
          }
        }
      }

      // 控制密度：保留最后 N 个
      const keepN = Number(opts.keepN ?? 18);
      return markers.slice(-keepN);
    }

    /***************
     * Market Pulse & Signal (consistent logic)
     ***************/
    function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

    function computeSentiment(bars, emaSeries){
      const n = bars.length;
      const last = bars[n-1];
      const e = emaSeries[emaSeries.length-1]?.value ?? last.close;

      const prevE = emaSeries[emaSeries.length-10]?.value ?? emaSeries[0]?.value ?? e;
      const slope = (e - prevE) / Math.max(1, Math.abs(prevE)) * 100; // %
      const dist = (last.close - e) / Math.max(1, Math.abs(e)) * 100; // %

      let score = 50 + (dist*480) + (slope*900);
      score = clamp(score, 0, 100);

      const bull = clamp(score, 0, 100);
      const bear = clamp(100 - score, 0, 100);
      const neutral = clamp(100 - Math.abs(score-50)*2, 0, 100);

      const sum = bull + bear + neutral;
      const bullPct = bull/sum*100;
      const bearPct = bear/sum*100;
      const neuPct  = neutral/sum*100;

      const netInflow = (score-50) * 12.3;

      return {
        score: Math.round(score),
        bullPct, bearPct, neuPct,
        netInflow,
        bias: score>=58 ? "BULL" : (score<=42 ? "BEAR" : "NEUTRAL")
      };
    }

    /* ✅ 环形图按比例显示：绿(多) + 红(空) + 灰(中性) */
    function setPulseUI(s){
      $("pulseScore").textContent = String(s.score);

      const bull = clamp(s.bullPct, 0, 100);
      const bear = clamp(s.bearPct, 0, 100);
      const neu  = clamp(s.neuPct, 0, 100);

      const bullDeg = bull/100*360;
      const bearDeg = bear/100*360;
      const neuDeg  = Math.max(0, 360 - bullDeg - bearDeg);

      // 顺序：bull(绿) -> bear(红) -> neutral(灰)
      const d1 = bullDeg;
      const d2 = bullDeg + bearDeg;

      $("pulseGauge").style.background =
        `conic-gradient(
          var(--brand1) 0deg, var(--brand1) ${d1}deg,
          var(--danger) ${d1}deg, var(--danger) ${d2}deg,
          rgba(255,255,255,.12) ${d2}deg, rgba(255,255,255,.12) ${d2+neuDeg}deg
        )`;

      $("bullPct").textContent = bull.toFixed(2) + "%";
      $("bearPct").textContent = bear.toFixed(2) + "%";
      $("neuPct").textContent  = neu.toFixed(2) + "%";
      $("netInflow").textContent = (s.netInflow>=0?"+":"") + s.netInflow.toFixed(2);

      const tag = $("pulseTag");
      if(s.bias==="BULL"){
        tag.textContent="BULL";
        tag.style.background="rgba(43,226,166,.14)";
        tag.style.border="1px solid rgba(43,226,166,.25)";
      }else if(s.bias==="BEAR"){
        tag.textContent="BEAR";
        tag.style.background="rgba(255,90,90,.12)";
        tag.style.border="1px solid rgba(255,90,90,.22)";
      }else{
        tag.textContent="NEUTRAL";
        tag.style.background="rgba(255,184,108,.12)";
        tag.style.border="1px solid rgba(255,184,108,.22)";
      }
    }

    function setSignal(bias, price, tf, lastBsText){
      const row = $("signalRow");
      row.classList.remove("buy","sell","neutral");
      $("signalTf").textContent = "TF: " + tf.toUpperCase();

      const bsHint = lastBsText ? ` · Latest: ${lastBsText}` : "";

      if(bias==="BULL"){
        row.classList.add("buy");
        $("signalSide").textContent = "BUY · 看多 / 买入";
        $("signalMeta").textContent = "Bullish momentum aligned with Market Pulse." + bsHint;
        $("signalPx").textContent = "@ " + price;
      }else if(bias==="BEAR"){
        row.classList.add("sell");
        $("signalSide").textContent = "SELL · 看空 / 卖出";
        $("signalMeta").textContent = "Bearish momentum aligned with Market Pulse." + bsHint;
        $("signalPx").textContent = "@ " + price;
      }else{
        row.classList.add("neutral");
        $("signalSide").textContent = "WAIT · 观望";
        $("signalMeta").textContent = "Neutral market. Wait for clearer inflection." + bsHint;
        $("signalPx").textContent = "@ " + price;
      }
    }

    function updateRisk(bars){
      const last = bars[bars.length-1];
      const entry = last.close * 0.992;
      const stop  = last.close * 0.978;
      const t1    = last.close * 1.008;
      const t2    = last.close * 1.018;
      const t3    = last.close * 1.032;

      $("riskEntry").textContent = entry.toFixed(2);
      $("riskStop").textContent  = stop.toFixed(2);
      $("riskTargets").textContent = [t1,t2,t3].map(x=>x.toFixed(2)).join(", ");

      const vol = Math.abs(bars[bars.length-1].close - bars[bars.length-12].close) / bars[bars.length-12].close * 100;
      const conf = clamp(92 - vol*2.0, 55, 95);
      $("riskConf").textContent = Math.round(conf) + "%";
      $("riskWR").textContent = "72%";
    }

    function initChart(){
      if(typeof LightweightCharts==="undefined"){
        setStatus("Chart lib missing", false);
        alert("lightweight-charts 未加载。");
        return;
      }
      const el = $("chart");
      chart = LightweightCharts.createChart(el, {
        layout: { background: { color: "transparent" }, textColor: "#EAF0F7" },
        grid: {
          vertLines: { color: "rgba(255,255,255,.04)" },
          horzLines: { color: "rgba(255,255,255,.04)" },
        },
        rightPriceScale: { borderVisible:false },
        timeScale: { timeVisible:true, secondsVisible:false, borderVisible:false },
        crosshair: { mode: 1 },
      });

      candle = chart.addCandlestickSeries({
        upColor: "#2BE2A6",
        downColor:"#FF5A5A",
        wickUpColor:"#2BE2A6",
        wickDownColor:"#FF5A5A",
        borderVisible:false,
      });

      ema = chart.addLineSeries({ lineWidth: 2, color: "rgba(76,194,255,.90)" });
      aux = chart.addLineSeries({ lineWidth: 2, color: "rgba(255,184,108,.80)" });

      function fit(){
        const r = el.getBoundingClientRect();
        chart.applyOptions({ width: Math.max(1, Math.floor(r.width)), height: Math.max(1, Math.floor(r.height)) });
        chart.timeScale().fitContent();
      }
      new ResizeObserver(() => fit()).observe(el);
      window.addEventListener("resize", fit);

      load(); // first load
      fit();
    }

    /***************
     * Data fetch placeholder
     ***************/
    async function fetchMarketData(symbol, tf){
      return genDemoCandles(240, tf);
    }

    /***************
     * Timeframe sync (Tabs <-> Select)
     ***************/
    function setActiveTf(tf){
      $("tf").value = tf;
      document.querySelectorAll("#tfTabs button").forEach(b=>{
        b.classList.toggle("active", (b.dataset.tf===tf));
      });
    }

    /***************
     * Load / render
     ***************/
    async function load(){
      const sym = ($("symbol").value || "BTCUSDT").trim().toUpperCase();
      const tf = $("tf").value;

      $("symText").textContent = sym;
      $("hintText").textContent = "Loading… / 加载中";

      const bars = await fetchMarketData(sym, tf);

      /* ✅ 商业机密：内部参数不展示给客户（可后续按你真实算法替换） */
      const EMA_INTERNAL = 10;
      const AUX_INTERNAL = 21;

      const emaSeries = calcEMA(bars, EMA_INTERNAL);
      const auxSeries = calcEMA(bars, AUX_INTERNAL);

      candle.setData(bars);
      ema.setData(emaSeries);
      aux.setData(auxSeries);
      applyToggles();

      const last = bars[bars.length-1];
      $("priceText").textContent = last.close.toFixed(2);

      const s = computeSentiment(bars, emaSeries);
      setPulseUI(s);

      /* ✅ B/S：交叉 + EMA斜率翻转 + cooldown；标在确认完成那根K线 */
      const markers = generateBSSignals(emaSeries, auxSeries, bars, {
        cooldownBars: 12,
        usePulseFilter: false,   // 可选过滤项：默认关闭
        pulseBias: s.bias,
        keepN: 18,
      });
      candle.setMarkers(markers);

      // 给信号栏补充“最近一次 B/S”
      let lastBsText = "";
      if(markers && markers.length){
        const m = markers[markers.length-1];
        lastBsText = m.text === "B" ? "B (confirmed)" : "S (confirmed)";
      }

      setSignal(s.bias, last.close.toFixed(2), tf, lastBsText);
      updateRisk(bars);

      $("hintText").textContent = "Loaded · 已加载（B/S=交叉+斜率翻转+cooldown，标在确认K线）";
      setStatus("API OK", true);

      log(`✅ load: ${sym} ${tf} bias=${s.bias} score=${s.score}`);
    }

    /***************
     * Billing: Plans + Status + Portal (FULL)
     * 1) /api/plans is the ONLY source of truth
     * 2) /api/subscription/status decides access display
     * 3) /billing/portal for upgrade/cancel/resume/card/invoices
     ***************/
    let PLANS = []; // {key,label,price_id,trial_days}

    function setPlanStatus(t){ $("planStatus").textContent = t; }

    function updateTrialHint(){
      const key = $("planSelect").value;
      const p = PLANS.find(x=>x.key===key);
      const t = p ? (p.trial_days||0) : 0;
      $("trialHint").textContent = t>0 ? `Trial ${t} day(s)` : "No Trial";
    }

    function populatePlans(plans){
      PLANS = plans.slice();
      const sel = $("planSelect");
      sel.innerHTML = "";
      for(const p of PLANS){
        const opt = document.createElement("option");
        opt.value = p.key;
        opt.textContent = `${p.label}${p.trial_days ? ` (Trial ${p.trial_days}d)` : ""}`;
        sel.appendChild(opt);
      }
      setPlanStatus(`已加载 ${PLANS.length} 个计划（/api/plans）`);
      $("btnStartSub").disabled = (PLANS.length===0);
      updateTrialHint();
    }

    async function initPlans(){
      try{
        setPlanStatus("从后端 /api/plans 拉取…");
        const data = await apiGet("/api/plans");
        if(!data || !data.ok || !Array.isArray(data.plans) || data.plans.length===0){
          throw new Error("Invalid /api/plans response");
        }
        const plans = data.plans.map(x=>({
          key: x.key,
          label: x.label || x.key,
          price_id: x.price_id,
          trial_days: x.trial_days || 0
        })).filter(x=>x.key && x.price_id);

        if(plans.length===0) throw new Error("No valid plans returned");
        populatePlans(plans);
        setStatus("API OK", true);
        log("✅ plans loaded from /api/plans");
      }catch(e){
        setPlanStatus("拉取失败（联系管理员/检查后端）");
        $("planSelect").innerHTML = `<option value="">(Plans not loaded)</option>`;
        $("btnStartSub").disabled = true;
        setStatus("API Not Ready", false);
        if(isAdmin()) log("❌ initPlans: " + e.message);
      }
    }

    function renderSubscriptionCard(sub){
      const box = $("subscriptionStatus");
      const btnManage = $("btnManageSub");
      const btnStart = $("btnStartSub");

      if(!sub){
        box.textContent = "Status: Not subscribed";
        btnManage.style.display = "none";
        btnStart.style.display = "inline-flex";
        return;
      }
      const end = sub.current_period_end ? new Date(sub.current_period_end).toLocaleString() : "";
      const cap = sub.cancel_at_period_end ? ` · cancel_at_period_end=${sub.cancel_at_period_end}` : "";
      box.textContent = `Status: ${sub.status || "-"} | End: ${end}${cap}`;

      btnStart.style.display = "none";
      btnManage.style.display = "inline-flex";
    }

    async function refreshSubStatus(){
      const user_id = ($("userId").value || "").trim();
      if(!user_id){
        renderSubscriptionCard(null);
        return;
      }
      try{
        const data = await apiGet(`/api/subscription/status?user_id=${encodeURIComponent(user_id)}`);
        renderSubscriptionCard(data.subscription || null);
      }catch(e){
        $("subscriptionStatus").textContent = "Status: (check failed) — 请检查后端或稍后再试";
        if(isAdmin()) log("❌ status: " + e.message);
      }
    }

    async function startSubscription(){
      const user_id = ($("userId").value || "").trim();
      const email = ($("email").value || "").trim();
      const plan = $("planSelect").value;
      const override = ($("priceOverride").value || "").trim();

      if(!user_id){
        alert("User ID 必填（用于绑定 Stripe 订阅到你的系统用户）。");
        $("userId").focus();
        return;
      }

      try{
        setStatus("Creating checkout…", true);

        // ✅ 默认走 plan（推荐）；override 仅兜底
        const payload = override
          ? { user_id, email: email || undefined, price_id: override }
          : { user_id, email: email || undefined, plan };

        if(isAdmin()) log(`➡️ POST /billing/checkout user_id=${user_id} ${override ? "price_id=override" : "plan="+plan}`);

        const data = await apiPost("/billing/checkout", payload);

        if(!data || !data.checkout_url){
          throw new Error("No checkout_url returned");
        }
        setStatus("Redirecting to Stripe…", true);
        if(isAdmin()) log("✅ checkout_url received. Redirecting...");
        window.location.href = data.checkout_url;
      }catch(e){
        setStatus("Network/API error", false);
        if(isAdmin()) log(`❌ subscribe failed: ${e.message}`);
        alert("订阅失败：网络错误/后端未联通或接口报错。\n\n错误：\n" + e.message);
      }
    }

    async function openPortal(){
      const user_id = ($("userId").value || "").trim();
      if(!user_id){
        alert("请先填写 User ID。");
        $("userId").focus();
        return;
      }
      try{
        setStatus("Opening portal…", true);
        const out = await apiPost("/billing/portal", { user_id, return_url: window.location.href });
        if(!out || !out.portal_url) throw new Error("No portal_url returned");
        window.location.href = out.portal_url;
      }catch(e){
        setStatus("Portal error", false);
        alert("打开管理订阅失败：\n" + e.message);
        if(isAdmin()) log("❌ portal: " + e.message);
      }
    }

    /***************
     * Admin diagnostics
     ***************/
    async function testHealth(){
      try{
        setStatus("Checking API…", true);
        const data = await apiGet("/health");
        setStatus("API OK", true);
        log(`✅ /health: ${typeof data==="string"?data:JSON.stringify(data).slice(0,260)}`);
      }catch(e){
        setStatus("API Not Ready", false);
        log(`❌ /health: ${e.message}`);
        alert("Health 检查失败：\n" + e.message);
      }
    }

    async function showRoutes(){
      try{
        setStatus("Loading routes…", true);
        const data = await apiGet("/routes");
        setStatus("Routes OK", true);
        log(`✅ /routes: ${JSON.stringify(data).slice(0,520)}...`);
      }catch(e){
        setStatus("Routes failed", false);
        log(`❌ /routes: ${e.message}`);
        alert("Routes 获取失败：\n" + e.message);
      }
    }

    /***************
     * Utilities
     ***************/
    async function copyShareLink(){
      const sym = ($("symbol").value || "BTCUSDT").trim().toUpperCase();
      const tf = $("tf").value;
      const url = `${location.origin}${location.pathname}?symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tf)}`;
      try{
        await navigator.clipboard.writeText(url);
        alert("已复制分享链接：\n" + url);
      }catch(_){
        prompt("复制失败，请手动复制：", url);
      }
    }

    function exportPNG(){
      try{
        if(!chart || typeof chart.takeScreenshot !== "function"){
          alert("当前图表版本不支持 takeScreenshot（或被浏览器限制）。");
          return;
        }
        const canvas = chart.takeScreenshot();
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        const sym = ($("symbol").value || "BTCUSDT").trim().toUpperCase();
        const tf = $("tf").value;
        a.download = `DarriusAI_${sym}_${tf}.png`;
        a.click();
      }catch(e){
        alert("导出失败：" + e.message);
      }
    }

    /***************
     * Affiliate reserved
     ***************/
    function openAffiliate(){
      alert("Affiliate 入口已预留：\n\n下一步建议：\n1) 做 /affiliate 登录\n2) 做 /affiliate/dashboard（推荐数、返佣、链接/代码）\n3) 注册时接入电子签：W9/W-8 + 合作协议 + 佣金/结算条款");
    }

    /***************
     * Boot
     ***************/
    (function boot(){
      $("yearNow").textContent = String(new Date().getFullYear());

      if(isAdmin()){
        $("diagCard").classList.remove("hidden");
        log("Admin mode enabled (?admin=1)");
      }

      const p = new URLSearchParams(location.search);
      const qsSym = p.get("symbol");
      const qsTf  = p.get("tf");
      if(qsSym) $("symbol").value = qsSym.toUpperCase();
      if(qsTf) {
        $("tf").value = qsTf;
        setActiveTf(qsTf);
      } else {
        setActiveTf($("tf").value);
      }

      // Top TF tabs
      document.querySelectorAll("#tfTabs button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const tf = btn.dataset.tf;
          setActiveTf(tf);
          load();
        });
      });

      // Sync select -> tabs
      $("tf").addEventListener("change", ()=>{
        setActiveTf($("tf").value);
      });

      // events
      $("tgEMA").addEventListener("change", applyToggles);
      $("tgAux").addEventListener("change", applyToggles);

      $("loadBtn").addEventListener("click", ()=>{
        setActiveTf($("tf").value);
        load();
      });

      $("planSelect").addEventListener("change", updateTrialHint);

      $("btnStartSub").addEventListener("click", startSubscription);
      $("btnManageSub").addEventListener("click", openPortal);

      $("userId").addEventListener("blur", refreshSubStatus);
      $("userId").addEventListener("change", refreshSubStatus);

      $("copyLinkBtn").addEventListener("click", copyShareLink);
      $("exportBtn").addEventListener("click", exportPNG);

      $("affiliateBtn").addEventListener("click", openAffiliate);

      if(isAdmin()){
        $("healthBtn").addEventListener("click", testHealth);
        $("routesBtn").addEventListener("click", showRoutes);
      }

      setStatus("Ready · 前端已就绪", true);

      initChart();
      initPlans().then(()=>refreshSubStatus());
    })();
  </script>
</body>
</html>
