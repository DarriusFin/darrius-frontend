<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DarriusAI • Inflection Hunter</title>

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root{
      --bg:#070b12;
      --panel:#0b1220;
      --txt:#e7eefc;
      --muted:#9cb0d6;
      --good:#2ee59d;
      --bad:#ff5c6c;
      --warn:#ffcc66;
      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 35% 20%, rgba(32,214,167,.10), transparent 60%),
                  radial-gradient(1000px 500px at 70% 10%, rgba(99,155,255,.10), transparent 60%),
                  var(--bg);
      color:var(--txt);
    }
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 360px 1fr 360px;
      gap:14px;
      padding:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .cardHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .brand .title{ font-weight:900; letter-spacing:.2px; }
    .brand .sub{ font-size:12px; color:var(--muted); }

    .badge{
      font-size:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:4px 8px;
      border-radius:999px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.ok{ color:var(--good); border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.08); }
    .badge.warn{ color:var(--warn); border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.08); }
    .badge.bad{ color:var(--bad); border-color: rgba(255,92,108,.35); background: rgba(255,92,108,.08); }

    .cardBody{ padding:14px; overflow:auto; min-height:0; }
    .section{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sectionTitle{
      font-weight:900;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .mini{ font-size:12px; color:var(--muted); line-height:1.35; }
    .mono{ font-family: var(--mono); font-size:12px; color:rgba(231,238,252,.92); }

    label{ font-size:12px; color:var(--muted); }
    input, select{
      width:100%;
      border-radius:12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      color:var(--txt);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{ color:rgba(156,176,214,.55); }

    .row{ display:flex; gap:10px; align-items:center; }
    .btn{
      width:100%;
      border:none;
      border-radius:12px;
      padding:11px 12px;
      cursor:pointer;
      font-weight:900;
      color:#022016;
      background: linear-gradient(180deg, rgba(32,214,167,1), rgba(20,190,150,1));
      box-shadow: 0 10px 18px rgba(32,214,167,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:none;
      font-weight:800;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Center chart */
    #chartWrap{ padding:0; }
    #chartTop{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #chartTitle{ font-weight:900; letter-spacing:.2px; }
    #tfPills{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      color:var(--txt);
      border-color: rgba(32,214,167,.38);
      background: rgba(32,214,167,.10);
    }
    #chart{
      width:100%;
      height: calc(100vh - 14px*2 - 44px - 2px);
      min-height:520px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      font-size:13px;
      display:none;
      max-width: min(860px, 92vw);
      z-index:9999;
    }
    .toast.show{ display:block; }
    .toast strong{ color: var(--warn); }

    .divider{ height:1px; background: rgba(255,255,255,.06); margin:6px 0; }

    @media (max-width: 1180px){
      .app{ grid-template-columns: 1fr; height:auto; }
      #chart{ height: 62vh; min-height: 420px; }
    }
  </style>
Fio
</head>

<body>
  <div class="app">

    <!-- LEFT -->
    <div class="card">
      <div class="cardHeader">
        <div class="brand">
          <div class="title">DarriusAI • Inflection Hunter</div>
          <div class="sub">AI 拐点猎手系统</div>
        </div>
        <div id="apiBadge" class="badge">API …</div>
      </div>

      <div class="cardBody">
        <div class="section">
          <div class="sectionTitle">
            Market Pulse
            <span id="pulseBadge" class="badge ok">BULL</span>
          </div>
          <div class="row">
            <div style="flex:1">
              <div class="mini">Sentiment</div>
              <div style="font-size:42px;font-weight:900;line-height:1; color:var(--good);" id="sentimentScore">—</div>
            </div>
            <div style="flex:2">
              <div class="mini" id="pulseDesc">Loading…</div>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <!-- SAFE Signal Summary: no algorithm leakage -->
        <div class="section">
          <div class="sectionTitle">Signal Summary</div>
          <div class="mini" id="signalText">—</div>
          <div class="mini">Proprietary rules. UI shows status only.</div>
        </div>

        <div style="height:10px"></div>

        <div class="section">
          <div class="sectionTitle">Signals Count</div>
          <div class="mini">Buy: <span class="mono" id="buyCount">0</span> · Sell: <span class="mono" id="sellCount">0</span></div>
          <div class="mini" id="sigHint">—</div>
        </div>

        <div style="height:10px"></div>

        <div class="mini">
          Educational use only. No solicitation. Past performance is not indicative of future results.
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="card" id="chartWrap">
      <div id="chartTop">
        <div class="row" style="gap:10px;">
          <div id="chartTitle">BTCUSDT</div>
          <div class="badge" id="lastPrice">—</div>
          <!-- SAFE: no rule wording -->
          <div class="badge" id="loadedText">Loaded · —</div>
        </div>
        <div id="tfPills"></div>
      </div>
      <div id="chart"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="cardHeader">
        <div class="brand">
          <div class="title">Control Center • 控制台</div>
          <div class="sub">Market / Timeframe / Subscription</div>
        </div>
        <div class="badge">© 2026</div>
      </div>

      <div class="cardBody" style="display:flex; flex-direction:column; gap:12px;">

        <!-- Market -->
        <div class="section">
          <div class="sectionTitle">Market</div>

          <div class="row">
            <div style="flex:1">
              <label for="symbolInput">Symbol</label>
              <input id="symbolInput" placeholder="e.g. BTCUSDT" value="BTCUSDT" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="tfSelect">Timeframe</label>
              <select id="tfSelect"></select>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="loadBtn">Load • 加载</button>
          </div>

          <div class="mini" id="tfSupportHint" style="display:none; color: var(--warn);">
            <strong>Notice:</strong> timeframe not supported. Fallback to 1D.
          </div>
        </div>

        <!-- Indicators -->
        <div class="section">
          <div class="sectionTitle">Indicators</div>
          <div class="row">
            <label class="mini" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="toggleEMA" checked /> EMA
            </label>
            <label class="mini" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="toggleAUX" checked /> AUX
            </label>
            <label class="mini" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="toggleSignals" checked /> B/S
            </label>
          </div>
          <div class="mini">B/S are drawn as independent overlays and persist across redraws.</div>
        </div>

        <!-- Subscription (CORE) -->
        <div class="section">
          <div class="sectionTitle">
            Subscription
            <span class="badge ok" id="stripeBadge">Stripe Secure</span>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="userIdInput">User ID</label>
              <input id="userIdInput" placeholder="e.g. user_123" value="darrius888"/>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="emailInput">Email (optional)</label>
              <input id="emailInput" placeholder="name@domain.com" value="perrywu666@outlook.com"/>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="planSelect">Plan</label>
              <select id="planSelect"></select>
              <div class="mini" id="planSelfCheck"></div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- 2 lines status -->
          <div class="mini">
            <div>Status: <span id="subStatusText" class="mono">unknown</span></div>
            <div>Plan: <span id="subPlanText" class="mono">—</span></div>
          </div>

          <!-- SINGLE BUTTON -->
          <div class="row">
            <button class="btn" id="subActionBtn" disabled>Subscribe & Start</button>
          </div>

          <div class="row">
            <button class="btn secondary" id="refreshSubBtn">Refresh Status</button>
          </div>

          <div class="mini">Plans are core. UI enforces 4 plans and self-checks.</div>
        </div>

        <!-- Utilities -->
        <div class="section">
          <div class="sectionTitle">Utilities</div>
          <div class="row">
            <button class="btn secondary" id="copyLinkBtn">Copy Share Link</button>
            <button class="btn secondary" id="exportPngBtn">Export PNG</button>
          </div>
        </div>

      </div>
    </div>

  </div>

  <div id="toast" class="toast"></div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const API_BASE = ""; // same origin recommended. If API is different, put e.g. "https://darrius-api.onrender.com"

const ENDPOINTS = {
  prices:   "/billing/prices",                 // GET -> array of 4 plans
  checkout: "/billing/checkout",               // POST -> {checkout_url}
  subStatus:"/api/subscription/status",        // GET -> {subscribed,status,price_id}
  portal:  "/api/billing/portal",              // POST -> {portal_url}
  market:  "/api/market",                      // GET -> ?symbol&tf
  health:  "/health"                           // GET -> ok
};

// 8 required timeframes (never depend on backend)
const TIMEFRAMES = [
  {key:'5m', label:'5m'},
  {key:'15m', label:'15m'},
  {key:'30m', label:'30m'},
  {key:'1h', label:'1h'},
  {key:'4h', label:'4h'},
  {key:'1d', label:'1D'},
  {key:'1w', label:'1W'},
  {key:'1m', label:'1M'},
];
const FALLBACK_TF = '1d';

// YOUR 4 core Stripe price IDs (absolute truth)
const PLAN_CATALOG_FALLBACK = [
  { price_id:"price_1SpJMmR84UMUVSTg0T7xfm6r", interval:"weekly",    amount:4.90,  currency:"USD", label:"Weekly · $4.90" },
  { price_id:"price_1SpbvRR84UMUVSTggbg0SFzi", interval:"monthly",   amount:19.90, currency:"USD", label:"Monthly · $19.90" },
  { price_id:"price_1SpbwYR84UMUVSTgMQpUrE42", interval:"quarterly", amount:49.90, currency:"USD", label:"Quarterly · $49.90" },
  { price_id:"price_1SpbpxR84UMUVSTgapaJDjMX", interval:"yearly",    amount:189.0, currency:"USD", label:"Yearly · $189" },
];

const PLAN_ORDER = { weekly:1, week:1, monthly:2, month:2, quarterly:3, quarter:3, yearly:4, year:4, annual:4 };

/** =========================
 *  STATE
 *  ========================= */
let state = {
  symbol: "BTCUSDT",
  tf: "1d",
  plans: [],
  selectedPriceId: null,
  chartData: null,
  subscription: { subscribed:false, status:"unknown", price_id:null }
};

function $(id){ return document.getElementById(id); }

function toast(msg, ms=2600){
  const el = $("toast");
  el.innerHTML = msg;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=> el.classList.remove("show"), ms);
}

async function apiFetch(path, options={}){
  const url = API_BASE + path;
  const res = await fetch(url, {
    headers: { "Content-Type":"application/json" },
    ...options
  });
  const ct = res.headers.get("content-type") || "";
  let data = null;
  if(ct.includes("application/json")) data = await res.json().catch(()=>null);
  else data = { raw: await res.text().catch(()=> "") };

  if(!res.ok){
    const msg = (data && (data.error || data.detail || data.message)) ? (data.error || data.detail || data.message) : `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

function normalizeTf(tf){
  tf = (tf||"").toLowerCase().trim();
  return TIMEFRAMES.some(x=>x.key===tf) ? tf : FALLBACK_TF;
}

function setApiBadge(ok){
  const b = $("apiBadge");
  if(ok){
    b.textContent = "API OK";
    b.className = "badge ok";
  }else{
    b.textContent = "API ERR";
    b.className = "badge bad";
  }
}

function setActiveTfPill(tf){
  tf = normalizeTf(tf);
  document.querySelectorAll(".pill").forEach(p=>{
    p.classList.toggle("active", normalizeTf(p.getAttribute("data-tf")) === tf);
  });
}

/** =========================
 *  TIMEFRAMES (always 8)
 *  ========================= */
function initTimeframesUI(){
  const sel = $("tfSelect");
  sel.innerHTML = TIMEFRAMES.map(t => `<option value="${t.key}">${t.label}</option>`).join("");
  sel.value = state.tf;

  sel.addEventListener("change", ()=>{
    state.tf = normalizeTf(sel.value);
    setActiveTfPill(state.tf);
  });

  const wrap = $("tfPills");
  wrap.innerHTML = TIMEFRAMES.map(t => `<div class="pill" data-tf="${t.key}">${t.label}</div>`).join("");
  wrap.addEventListener("click", (e)=>{
    const p = e.target.closest(".pill");
    if(!p) return;
    const tf = p.getAttribute("data-tf");
    state.tf = normalizeTf(tf);
    $("tfSelect").value = state.tf;
    setActiveTfPill(state.tf);
    // auto-load on pill click:
    loadMarketAndRender();
  });

  setActiveTfPill(state.tf);
}

/** =========================
 *  PLANS (core: must be 4)
 *  ========================= */
function planLabel(p){
  // prefer backend label if exists
  if(p.label) return p.label;
  const name =
    (p.plan || p.interval || "").toLowerCase().includes("week") ? "Weekly" :
    (p.plan || p.interval || "").toLowerCase().includes("month") ? "Monthly" :
    (p.plan || p.interval || "").toLowerCase().includes("quarter") ? "Quarterly" :
    (p.plan || p.interval || "").toLowerCase().includes("year") ? "Yearly" : "Plan";
  return `${name}`;
}

async function loadPlans(){
  let plans = [];
  try{
    const data = await apiFetch(ENDPOINTS.prices, { method:"GET" });
    const raw = Array.isArray(data) ? data : (data.plans || data.data || []);
    plans = (raw||[]).map(p=>{
      const price_id = p.price_id || p.id || p.priceId || p.price;
      const interval = (p.plan || p.interval || "").toString().toLowerCase();
      const label = p.label || null;
      return { price_id, interval, label, raw:p };
    }).filter(x=>x.price_id);
  }catch(e){
    // ignore and fallback
  }

  // enforce fallback if not exactly 4
  if(plans.length !== 4){
    plans = PLAN_CATALOG_FALLBACK.map(x=>({ ...x }));
  }

  plans.sort((a,b)=>{
    const ia = PLAN_ORDER[a.interval] ?? 99;
    const ib = PLAN_ORDER[b.interval] ?? 99;
    return ia - ib;
  });

  state.plans = plans;
  const sel = $("planSelect");
  sel.innerHTML = plans.map(p => `<option value="${p.price_id}">${p.label || planLabel(p)}</option>`).join("");

  state.selectedPriceId = plans[0]?.price_id || null;
  sel.value = state.selectedPriceId;

  sel.onchange = ()=>{
    state.selectedPriceId = sel.value;
    syncPlanText();
    updateSubActionEnabled();
  };

  // self-check
  if(state.plans.length === 4){
    $("planSelfCheck").textContent = "Plans OK: 4 loaded.";
    $("planSelfCheck").style.color = "var(--good)";
  }else{
    $("planSelfCheck").textContent = `Plans ERROR: ${state.plans.length} (expected 4).`;
    $("planSelfCheck").style.color = "var(--bad)";
  }

  syncPlanText();
  updateSubActionEnabled();
}

function syncPlanText(){
  const p = state.plans.find(x=>x.price_id === state.selectedPriceId);
  $("subPlanText").textContent = p ? (p.label || planLabel(p)) : "—";
}

function updateSubActionEnabled(){
  const userId = ($("userIdInput").value||"").trim();
  $("subActionBtn").disabled = !(userId && state.selectedPriceId);
}

/** =========================
 *  SUBSCRIPTION (single button)
 *  ========================= */
async function refreshSubscriptionStatus(){
  const userId = ($("userIdInput").value||"").trim();
  if(!userId){
    toast("<strong>User ID required.</strong>");
    return;
  }

  $("refreshSubBtn").disabled = true;
  $("refreshSubBtn").textContent = "Refreshing…";

  try{
    const qs = new URLSearchParams({ user_id: userId });
    const data = await apiFetch(`${ENDPOINTS.subStatus}?${qs.toString()}`, { method:"GET" });

    state.subscription.subscribed = !!data.subscribed;
    state.subscription.status = (data.status || "unknown").toString().toLowerCase();
    state.subscription.price_id = data.price_id || null;

    $("subStatusText").textContent = state.subscription.status;

    // if backend returns price_id, map to plan label
    if(state.subscription.price_id){
      const p = state.plans.find(x=>x.price_id === state.subscription.price_id) || PLAN_CATALOG_FALLBACK.find(x=>x.price_id===state.subscription.price_id);
      if(p) $("subPlanText").textContent = p.label || planLabel(p);
    }else{
      syncPlanText();
    }

    updateSubActionText();

  }catch(e){
    // keep unknown, but still usable
    $("subStatusText").textContent = "unknown";
    updateSubActionText();
  }finally{
    $("refreshSubBtn").disabled = false;
    $("refreshSubBtn").textContent = "Refresh Status";
    updateSubActionEnabled();
  }
}

function updateSubActionText(){
  const st = state.subscription.status;
  const btn = $("subActionBtn");
  if(st === "active" || st === "trialing"){
    btn.textContent = "Manage Subscription";
  }else{
    btn.textContent = "Subscribe & Start";
  }
}

async function handleSubscriptionAction(){
  const userId = ($("userIdInput").value||"").trim();
  const email = ($("emailInput").value||"").trim();
  if(!userId){
    toast("<strong>User ID required.</strong>");
    return;
  }

  const btn = $("subActionBtn");
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = "Working…";

  try{
    // active -> portal
    if(state.subscription.status === "active" || state.subscription.status === "trialing"){
      const data = await apiFetch(ENDPOINTS.portal, {
        method:"POST",
        body: JSON.stringify({ user_id: userId })
      });
      const url = data.portal_url || data.url;
      if(url){ window.location.href = url; return; }
      toast("<strong>Portal not available.</strong>");
      return;
    }

    // else -> checkout
    if(!state.selectedPriceId){
      toast("<strong>Please select a plan.</strong>");
      return;
    }

    const data = await apiFetch(ENDPOINTS.checkout, {
      method:"POST",
      body: JSON.stringify({ user_id: userId, price_id: state.selectedPriceId, email })
    });

    const url = data.checkout_url || data.url;
    if(url){ window.location.href = url; return; }

    toast("<strong>Checkout error:</strong> no redirect url.");
  }catch(e){
    toast(`<strong>Action failed:</strong> ${e.message}`);
  }finally{
    btn.disabled = false;
    btn.textContent = old;
  }
}

/** =========================
 *  MARKET + CHART (B/S overlay persists)
 *  ========================= */
function baseLayout(){
  return {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:60,r:20,t:18,b:40},
    xaxis:{ gridcolor:"rgba(255,255,255,.06)", tickfont:{color:"rgba(231,238,252,.7)"}, rangeslider:{visible:false}, zeroline:false },
    yaxis:{ gridcolor:"rgba(255,255,255,.06)", tickfont:{color:"rgba(231,238,252,.7)"}, zeroline:false },
  };
}

function toLineSeries(series, candles){
  if(!series) return {ex:[], ey:[]};
  if(Array.isArray(series) && series.length && typeof series[0] === "number"){
    const ex = (candles||[]).map(d=> d.t ?? d.time ?? d.ts ?? d[0]);
    const ey = series.map(v=> Number(v));
    return {ex, ey};
  }
  if(Array.isArray(series) && series.length && typeof series[0] === "object"){
    const ex = series.map(d=> d.t ?? d.time ?? d.ts ?? d.x).filter(Boolean);
    const ey = series.map(d=> d.v ?? d.value ?? d.y).filter(v=>v!==undefined && v!==null);
    return {ex, ey};
  }
  if(series.x && series.y) return {ex: series.x, ey: series.y};
  return {ex:[], ey:[]};
}

function renderChart(payload){
  if(!payload){
    Plotly.newPlot("chart", [], baseLayout(), {displayModeBar:false, responsive:true});
    return;
  }

  const candles = payload.candles || payload.ohlc || [];
  const ema = payload.ema || payload.EMA || [];
  const aux = payload.aux || payload.AUX || [];
  const signals = payload.signals || payload.SIGNALS || payload.bs || payload.BS || [];

  const x = candles.map(d => d.t ?? d.time ?? d.ts ?? d[0]);
  const open = candles.map(d => d.o ?? d.open ?? d[1]);
  const high = candles.map(d => d.h ?? d.high ?? d[2]);
  const low  = candles.map(d => d.l ?? d.low  ?? d[3]);
  const close= candles.map(d => d.c ?? d.close?? d[4]);

  const last = close.length ? close[close.length-1] : null;
  $("lastPrice").textContent = last ? `Last: ${Number(last).toFixed(2)}` : "—";

  const showEMA = $("toggleEMA").checked;
  const showAUX = $("toggleAUX").checked;
  const showSig = $("toggleSignals").checked;

  const traces = [{
    type:"candlestick",
    x, open, high, low, close,
    name:"Price",
    increasing: {line:{color:"#2ee59d"}},
    decreasing: {line:{color:"#ff5c6c"}},
  }];

  if(showEMA){
    const {ex, ey} = toLineSeries(ema, candles);
    if(ex.length) traces.push({ type:"scatter", mode:"lines", x:ex, y:ey, name:"EMA", line:{width:2, color:"rgba(255,255,255,.65)"}, hoverinfo:"skip" });
  }
  if(showAUX){
    const {ex, ey} = toLineSeries(aux, candles);
    if(ex.length) traces.push({ type:"scatter", mode:"lines", x:ex, y:ey, name:"AUX", line:{width:2, color:"rgba(99,155,255,.75)"}, hoverinfo:"skip" });
  }

  const normSide = (s)=>{
    const t = (s.type ?? s.signal ?? s.side ?? s.action ?? "").toString().trim().toUpperCase();
    if(["B","BUY","LONG","ENTRY","OPEN_LONG"].includes(t)) return "B";
    if(["S","SELL","SHORT","EXIT","CLOSE_LONG","OPEN_SHORT"].includes(t)) return "S";
    const tl = t.toLowerCase();
    if(tl === "buy") return "B";
    if(tl === "sell") return "S";
    return "";
  };
  const normTime = (s)=> (s.t ?? s.time ?? s.ts ?? s.date);
  const normPrice = (s)=> (s.price ?? s.p ?? s.value ?? s.y);

  const buys = Array.isArray(signals) ? signals.filter(s=> normSide(s)==="B") : [];
  const sells= Array.isArray(signals) ? signals.filter(s=> normSide(s)==="S") : [];

  $("buyCount").textContent = String(buys.length);
  $("sellCount").textContent = String(sells.length);

  $("sigHint").textContent =
    (sells.length===0 && buys.length>0) ? "Sell=0: backend may not have emitted S (rule not met / cooldown / window)."
    : (buys.length===0 && sells.length===0) ? "No signals returned by backend."
    : "Signals rendered.";

  if(showSig){
    const bx = buys.map(normTime).filter(Boolean);
    const by = buys.map(normPrice).filter(v=>v!==undefined && v!==null);
    const sx = sells.map(normTime).filter(Boolean);
    const sy = sells.map(normPrice).filter(v=>v!==undefined && v!==null);

    if(bx.length && by.length){
      traces.push({
        type:"scatter", mode:"markers+text", name:"Buy",
        x:bx, y:by, text:bx.map(()=> "B"), textposition:"top center",
        marker:{size:10, color:"#2ee59d", line:{width:1, color:"rgba(0,0,0,.45)"}},
        hovertemplate:"<b>B</b><br>%{x}<br>%{y}<extra></extra>"
      });
    }
    if(sx.length && sy.length){
      traces.push({
        type:"scatter", mode:"markers+text", name:"Sell",
        x:sx, y:sy, text:sx.map(()=> "S"), textposition:"bottom center",
        marker:{size:10, color:"#ff5c6c", line:{width:1, color:"rgba(0,0,0,.45)"}},
        hovertemplate:"<b>S</b><br>%{x}<br>%{y}<extra></extra>"
      });
    }
  }

  Plotly.react("chart", traces, baseLayout(), {displayModeBar:false, responsive:true});
}

function updateLeftPanelsFromPayload(payload){
  const sentiment = payload.sentiment_score ?? payload.sentiment ?? payload.market_pulse?.sentiment ?? null;
  $("sentimentScore").textContent = (sentiment!==null && sentiment!==undefined) ? Math.round(Number(sentiment)) : "—";

  const pulse = (payload.pulse ?? payload.market_pulse?.label ?? "BULL").toString().toUpperCase();
  $("pulseBadge").textContent = pulse;
  $("pulseBadge").className = pulse.includes("BEAR") ? "badge bad" : "badge ok";

  $("pulseDesc").textContent = payload.pulse_desc ?? payload.market_pulse?.desc ?? "Market pulse loaded.";

  // SAFE summary: no rule words
  let summary = payload.current_signal || payload.signal_status || "";
  if(!summary){
    const sig = payload.signals || payload.bs || [];
    if(Array.isArray(sig) && sig.length){
      const last = sig[sig.length-1];
      const t = (last.type ?? last.side ?? last.signal ?? "").toString().toUpperCase();
      if(["B","BUY","LONG"].includes(t)) summary = "BUY · Confirmed";
      else if(["S","SELL","SHORT","EXIT"].includes(t)) summary = "SELL · Confirmed";
      else summary = "Signal · Ready";
    }else{
      summary = "Signal · Ready";
    }
  }
  $("signalText").textContent = summary;
}

async function loadMarketAndRender(){
  const symbol = ($("symbolInput").value || "BTCUSDT").trim().toUpperCase();
  let tf = normalizeTf($("tfSelect").value || state.tf || FALLBACK_TF);

  state.symbol = symbol;
  state.tf = tf;
  $("chartTitle").textContent = symbol;
  setActiveTfPill(tf);

  $("loadBtn").disabled = true;
  $("loadBtn").textContent = "Loading…";

  try{
    const qs = new URLSearchParams({ symbol, tf });
    const data = await apiFetch(`${ENDPOINTS.market}?${qs.toString()}`, { method:"GET" });

    let supported = (data.supported !== undefined) ? !!data.supported : true;
    let payload = data.data ? data.data : data;

    if(!supported){
      $("tfSupportHint").style.display = "block";
      toast(`<strong>Timeframe not supported</strong> (${tf}). Fallback to 1D.`);
      tf = FALLBACK_TF;
      state.tf = tf;
      $("tfSelect").value = tf;
      setActiveTfPill(tf);

      const qs2 = new URLSearchParams({ symbol, tf });
      const data2 = await apiFetch(`${ENDPOINTS.market}?${qs2.toString()}`, { method:"GET" });
      payload = data2.data ? data2.data : data2;
    }else{
      $("tfSupportHint").style.display = "none";
    }

    state.chartData = payload;
    renderChart(payload);
    updateLeftPanelsFromPayload(payload);
    setApiBadge(true);

    // SAFE loaded text
    $("loadedText").textContent = `Loaded · TF=${state.tf.toUpperCase()} · Signals Ready`;

  }catch(e){
    setApiBadge(false);
    toast(`<strong>Load failed:</strong> ${e.message}`);
  }finally{
    $("loadBtn").disabled = false;
    $("loadBtn").textContent = "Load • 加载";
  }
}

/** =========================
 *  CONTROLS + UTILITIES
 *  ========================= */
function initControls(){
  $("symbolInput").addEventListener("change", (e)=>{
    state.symbol = (e.target.value || "BTCUSDT").trim().toUpperCase();
    $("chartTitle").textContent = state.symbol;
  });
  $("loadBtn").addEventListener("click", ()=> loadMarketAndRender());
  $("toggleEMA").addEventListener("change", ()=> renderChart(state.chartData));
  $("toggleAUX").addEventListener("change", ()=> renderChart(state.chartData));
  $("toggleSignals").addEventListener("change", ()=> renderChart(state.chartData));

  $("userIdInput").addEventListener("input", ()=> updateSubActionEnabled());
  $("subActionBtn").addEventListener("click", ()=> handleSubscriptionAction());
  $("refreshSubBtn").addEventListener("click", ()=> refreshSubscriptionStatus());

  $("copyLinkBtn").addEventListener("click", async ()=>{
    const u = new URL(location.href);
    u.searchParams.set("symbol", state.symbol);
    u.searchParams.set("tf", state.tf);
    await navigator.clipboard.writeText(u.toString());
    toast("Share link copied.");
  });

  $("exportPngBtn").addEventListener("click", async ()=>{
    try{
      await Plotly.downloadImage("chart", {format:"png", filename:`${state.symbol}_${state.tf}`});
    }catch(e){
      toast(`<strong>Export failed:</strong> ${e.message}`);
    }
  });
}

async function checkHealth(){
  try{
    await apiFetch(ENDPOINTS.health, { method:"GET" });
    setApiBadge(true);
  }catch(e){
    setApiBadge(false);
  }
}

async function boot(){
  // URL params
  const params = new URLSearchParams(location.search);
  const urlSymbol = (params.get("symbol")||"").trim();
  const urlTf = normalizeTf(params.get("tf")||"");
  if(urlSymbol) state.symbol = urlSymbol.toUpperCase();
  if(urlTf) state.tf = urlTf;

  $("symbolInput").value = state.symbol;
  $("chartTitle").textContent = state.symbol;

  initTimeframesUI();
  initControls();
  renderChart(null);

  await checkHealth();
  await loadPlans();
  await refreshSubscriptionStatus();

  $("tfSelect").value = state.tf;
  setActiveTfPill(state.tf);

  await loadMarketAndRender();
  updateSubActionText();
}

boot();
</script>
</body>
</html>
