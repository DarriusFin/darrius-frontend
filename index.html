<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DarriusAI • Inflection Hunter</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root{
      --bg:#070b12; --txt:#e7eefc; --muted:#9cb0d6;
      --good:#2ee59d; --bad:#ff5c6c; --warn:#ffcc66;
      --radius:14px; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background: radial-gradient(1200px 600px at 35% 20%, rgba(32,214,167,.10), transparent 60%),
                  radial-gradient(1000px 500px at 70% 10%, rgba(99,155,255,.10), transparent 60%),
                  var(--bg);
    }
    .app{height:100vh;display:grid;grid-template-columns:360px 1fr 360px;gap:14px;padding:14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:0;
    }
    .cardHeader{
      padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex;flex-direction:column;gap:2px;line-height:1.1;}
    .brand .title{font-weight:800;letter-spacing:.2px;}
    .brand .sub{font-size:12px;color:var(--muted);}
    .badge{
      font-size:12px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04);
      padding:4px 8px; border-radius:999px; color:var(--muted); white-space:nowrap;
    }
    .badge.ok{color:var(--good);border-color:rgba(46,229,157,.35);background:rgba(46,229,157,.08);}
    .badge.warn{color:var(--warn);border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.08);}
    .badge.bad{color:var(--bad);border-color:rgba(255,92,108,.35);background:rgba(255,92,108,.08);}

    .cardBody{padding:14px; overflow:auto; min-height:0;}
    .section{
      border:1px solid rgba(255,255,255,.06); background:rgba(0,0,0,.14);
      border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px;
    }
    .sectionTitle{font-weight:800;font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .mini{font-size:12px;color:var(--muted);line-height:1.35;}
    .mono{font-family:var(--mono);font-size:12px;color:rgba(231,238,252,.92);}
    .row{display:flex;gap:10px;align-items:center;}
    label{font-size:12px;color:var(--muted);}
    input,select{
      width:100%; border-radius:12px; background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08); color:var(--txt);
      padding:10px 12px; outline:none;
    }
    .btn{
      width:100%; border:none; border-radius:12px; padding:11px 12px; cursor:pointer;
      font-weight:900; color:#022016;
      background:linear-gradient(180deg, rgba(32,214,167,1), rgba(20,190,150,1));
      box-shadow:0 10px 18px rgba(32,214,167,.18);
    }
    .btn.secondary{
      background:rgba(255,255,255,.06); color:var(--txt);
      border:1px solid rgba(255,255,255,.10); box-shadow:none; font-weight:700;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;}

    #chartWrap{padding:0;}
    #chartTop{
      padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    #chartTitle{font-weight:900;letter-spacing:.2px;}
    #tfPills{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04);
      color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer;
      user-select:none;
    }
    .pill.active{color:var(--txt);border-color:rgba(32,214,167,.38);background:rgba(32,214,167,.10);}
    #chart{width:100%; height: calc(100vh - 14px*2 - 44px - 2px); min-height:520px;}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.75); border:1px solid rgba(255,255,255,.12);
      color:var(--txt); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
      font-size:13px; display:none; max-width:min(860px, 92vw); z-index:9999;
    }
    .toast.show{display:block;}
    .toast strong{color:var(--warn);}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:6px 0;}
  </style>
</head>

<body>
<div class="app">

  <!-- LEFT -->
  <div class="card">
    <div class="cardHeader">
      <div class="brand">
        <div class="title">DarriusAI • Inflection Hunter</div>
        <div class="sub">AI 拐点猎手系统</div>
      </div>
      <div id="apiBadge" class="badge">API …</div>
    </div>

    <div class="cardBody">
      <div class="section">
        <div class="sectionTitle">System Debug</div>
        <div class="mini">API_BASE: <span id="dbgApiBase" class="mono">—</span></div>
        <div class="mini">Last Error: <span id="dbgErr" class="mono">—</span></div>
        <button class="btn secondary" id="btnSelfTest">Self Test</button>
      </div>

      <div style="height:10px"></div>

      <div class="section">
        <div class="sectionTitle">Signal Summary</div>
        <div class="mini" id="signalText">Signals Ready</div>
        <div class="mini">Proprietary rules. UI shows confirmation status only.</div>
      </div>

      <div style="height:10px"></div>

      <div class="section">
        <div class="sectionTitle">Signals Count</div>
        <div class="mini">Buy: <span class="mono" id="buyCount">0</span> · Sell: <span class="mono" id="sellCount">0</span></div>
        <div class="mini" id="sigHint">Market API pending.</div>
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="card" id="chartWrap">
    <div id="chartTop">
      <div class="row" style="gap:10px;">
        <div id="chartTitle">BTCUSDT</div>
        <div class="badge" id="lastPrice">—</div>
        <div class="badge" id="loadedText">Loaded · Demo</div>
      </div>
      <div id="tfPills"></div>
    </div>
    <div id="chart"></div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <div class="cardHeader">
      <div class="brand">
        <div class="title">Control Center • 控制台</div>
        <div class="sub">Market / Timeframe / Subscription</div>
      </div>
      <div class="badge">© 2026</div>
    </div>

    <div class="cardBody" style="display:flex; flex-direction:column; gap:12px;">

      <div class="section">
        <div class="sectionTitle">Market</div>

        <div class="row">
          <div style="flex:1">
            <label for="symbolInput">Symbol</label>
            <input id="symbolInput" value="BTCUSDT" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label for="tfSelect">Timeframe</label>
            <select id="tfSelect"></select>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="loadBtn">Load • 加载</button>
        </div>

        <div class="mini" style="color:var(--warn);">
          注意：你当前 app.py 还没实现 <span class="mono">/api/market</span>，所以图表先展示 Demo（不空白）。
        </div>
      </div>

      <div class="section">
        <div class="sectionTitle">
          Subscription
          <span class="badge ok">Stripe Secure</span>
        </div>

        <div class="row">
          <div style="flex:1">
            <label for="userIdInput">User ID</label>
            <input id="userIdInput" value="darrius888"/>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label for="emailInput">Email (optional)</label>
            <input id="emailInput" value="perrywu666@outlook.com"/>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label for="planSelect">Plan</label>
            <select id="planSelect"></select>
            <div class="mini" id="planSelfCheck"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="mini">
          <div>Status: <span id="subStatusText" class="mono">unknown</span></div>
          <div>Plan: <span id="subPlanText" class="mono">—</span></div>
        </div>

        <div class="row">
          <button class="btn" id="subActionBtn" disabled>Subscribe & Start</button>
        </div>

        <button class="btn secondary" id="refreshSubBtn">Refresh Status</button>
      </div>

      <div class="section">
        <div class="sectionTitle">Utilities</div>
        <div class="row">
          <button class="btn secondary" id="copyLinkBtn">Copy Share Link</button>
          <button class="btn secondary" id="exportPngBtn">Export PNG</button>
        </div>
      </div>

    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
/** =========================
 *  CONFIG (HARD-STABLE)
 *  ========================= */

// ✅ 自动锁定到 Render；也支持 ?api=https://xxx 覆盖调试
const qs = new URLSearchParams(location.search);
const API_BASE = (qs.get("api") || "https://darrius-api.onrender.com").trim();

// ✅ routes aligned to your current app.py
const ENDPOINTS = {
  health:   "/health",
  home:     "/", // 你的 app.py 有 home(): "darrius-api is running"
  prices:   "/billing/prices",
  checkout: "/billing/checkout",          // returns checkout_url
  subStatus:"/api/subscription/status",   // GET ?user_id=
  portal:   "/api/billing/portal"         // POST {user_id} returns portal_url
};

const TIMEFRAMES = [
  {key:'5m', label:'5m'},
  {key:'15m', label:'15m'},
  {key:'30m', label:'30m'},
  {key:'1h', label:'1h'},
  {key:'4h', label:'4h'},
  {key:'1d', label:'1D'},
  {key:'1w', label:'1W'},
  {key:'1m', label:'1M'},
];
const FALLBACK_TF = '1d';

const PLAN_CATALOG_FALLBACK = [
  { price_id:"price_1SpJMmR84UMUVSTg0T7xfm6r", interval:"weekly",    amount:4.90,   currency:"USD" },
  { price_id:"price_1SpbvRR84UMUVSTggbg0SFzi", interval:"monthly",   amount:19.90,  currency:"USD" },
  { price_id:"price_1SpbwYR84UMUVSTgMQpUrE42", interval:"quarterly", amount:49.90,  currency:"USD" },
  { price_id:"price_1SpbpxR84UMUVSTgapaJDjMX", interval:"yearly",    amount:189.00, currency:"USD" },
];
const PLAN_ORDER = { weekly:1, monthly:2, quarterly:3, yearly:4 };

let state = { symbol:"BTCUSDT", tf:"1d", plans:[], selectedPriceId:null, subscription:{status:"unknown"} };

function $(id){ return document.getElementById(id); }
function toast(msg, ms=2600){
  const el = $("toast");
  el.innerHTML = msg; el.classList.add("show");
  clearTimeout(el._t); el._t = setTimeout(()=> el.classList.remove("show"), ms);
}
function setApiBadge(kind, text){
  const b = $("apiBadge");
  b.textContent = text;
  b.className = "badge " + kind;
}
function setErr(msg){
  $("dbgErr").textContent = msg || "—";
}

$("dbgApiBase").textContent = API_BASE;

async function apiFetch(path, options={}){
  const url = API_BASE + path;
  const res = await fetch(url, {
    mode: "cors",
    headers: { "Content-Type":"application/json" },
    ...options
  });
  const ct = res.headers.get("content-type") || "";
  let data = null;
  if(ct.includes("application/json")) data = await res.json().catch(()=>null);
  else data = { raw: await res.text().catch(()=> "") };

  if(!res.ok){
    const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

function normalizeTf(tf){
  tf = (tf||"").toLowerCase().trim();
  return TIMEFRAMES.some(x=>x.key===tf) ? tf : FALLBACK_TF;
}

function setActiveTfPill(tf){
  tf = normalizeTf(tf);
  document.querySelectorAll(".pill").forEach(p=>{
    p.classList.toggle("active", normalizeTf(p.getAttribute("data-tf")) === tf);
  });
}

function initTimeframesUI(){
  const sel = $("tfSelect");
  sel.innerHTML = TIMEFRAMES.map(t => `<option value="${t.key}">${t.label}</option>`).join("");
  sel.value = state.tf;

  const wrap = $("tfPills");
  wrap.innerHTML = TIMEFRAMES.map(t => `<div class="pill" data-tf="${t.key}">${t.label}</div>`).join("");

  wrap.addEventListener("click", (e)=>{
    const p = e.target.closest(".pill"); if(!p) return;
    state.tf = normalizeTf(p.getAttribute("data-tf"));
    sel.value = state.tf; setActiveTfPill(state.tf);
  });
  sel.addEventListener("change", ()=>{ state.tf = normalizeTf(sel.value); setActiveTfPill(state.tf); });

  setActiveTfPill(state.tf);
}

/** 关键：永远不空白 —— 页面启动立刻画 Demo */
function renderDemoChart(){
  const N=140; const x=[]; const y=[];
  for(let i=0;i<N;i++){ x.push(i); y.push(2 + Math.sin(i/12)*0.8 + Math.sin(i/30)*0.4); }
  const trace = {type:"scatter", mode:"lines", x, y, name:"Demo"};
  const layout = {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:60,r:20,t:18,b:40},
    xaxis:{gridcolor:"rgba(255,255,255,.06)", tickfont:{color:"rgba(231,238,252,.7)"}},
    yaxis:{gridcolor:"rgba(255,255,255,.06)", tickfont:{color:"rgba(231,238,252,.7)"}},
    annotations:[{
      text:"Demo Chart (你的 app.py 尚未实现 /api/market) — 绝不允许空白。",
      xref:"paper", yref:"paper", x:0.5, y:0.5, showarrow:false,
      font:{color:"rgba(255,204,102,.95)", size:14}
    }]
  };
  Plotly.react("chart", [trace], layout, {displayModeBar:false, responsive:true});
  $("loadedText").textContent = "Loaded · Demo";
  $("lastPrice").textContent = "—";
}

/** 关键：Health 双保险，/health 失败再试 / */
async function checkHealth(){
  try{
    await apiFetch(ENDPOINTS.health, {method:"GET"});
    setApiBadge("ok","API OK");
    setErr("—");
    return true;
  }catch(e1){
    try{
      // / returns plain text, still should be 200
      await apiFetch(ENDPOINTS.home, {method:"GET"});
      setApiBadge("warn","API OK (fallback)");
      setErr("/health failed, but / is reachable");
      return true;
    }catch(e2){
      setApiBadge("bad","API ERR");
      setErr(`health:${e1.message} | home:${e2.message}`);
      return false;
    }
  }
}

/** Plans: 必须 4 个，不够就 fallback */
async function loadPlans(){
  let plans = [];
  let fromBackend = false;

  try{
    const data = await apiFetch(ENDPOINTS.prices, {method:"GET"});
    if(Array.isArray(data)){
      plans = data.map(p=>({
        price_id: p.price_id,
        interval: (p.plan||"").toLowerCase(),
        amount: (p.label||"").includes("$") ? Number((p.label.match(/\$([0-9]+(?:\.[0-9]+)?)/)||[])[1]||0) : 0
      })).filter(x=>x.price_id);
      fromBackend = (plans.length === 4);
    }
  }catch(e){
    fromBackend = false;
  }

  if(plans.length !== 4){
    plans = PLAN_CATALOG_FALLBACK.map(x=>({price_id:x.price_id, interval:x.interval, amount:x.amount}));
    fromBackend = false;
  }

  plans.sort((a,b)=>(PLAN_ORDER[a.interval]||99)-(PLAN_ORDER[b.interval]||99));
  state.plans = plans;

  const sel = $("planSelect");
  sel.innerHTML = plans.map(p=>`<option value="${p.price_id}">${p.interval} — $${(p.amount||0).toFixed(2)}</option>`).join("");
  state.selectedPriceId = plans[0]?.price_id || null;
  sel.value = state.selectedPriceId;

  $("planSelfCheck").textContent = fromBackend ? "Plans OK: 4 loaded (backend)." : "Plans OK: forced 4-plan fallback.";
  $("planSelfCheck").style.color = fromBackend ? "var(--good)" : "var(--warn)";

  updateSubPlanTextFromSelection();
  updateSubActionEnabled();

  sel.onchange = ()=>{
    state.selectedPriceId = sel.value;
    updateSubPlanTextFromSelection();
    updateSubActionEnabled();
  };
}

function updateSubPlanTextFromSelection(){
  const p = state.plans.find(x=>x.price_id===state.selectedPriceId);
  $("subPlanText").textContent = p ? `${p.interval} — $${(p.amount||0).toFixed(2)}` : "—";
}

function updateSubActionEnabled(){
  const uid = ($("userIdInput").value||"").trim();
  $("subActionBtn").disabled = !(uid && state.selectedPriceId);
}

function updateSubActionButtonText(){
  const st = (state.subscription.status||"unknown").toLowerCase();
  const btn = $("subActionBtn");
  if(st==="active" || st==="trialing") btn.textContent = "Manage Subscription";
  else if(st==="incomplete" || st==="past_due" || st==="pending") btn.textContent = "Complete Checkout";
  else btn.textContent = "Subscribe & Start";
}

async function refreshSubscriptionStatus(){
  const uid = ($("userIdInput").value||"").trim();
  if(!uid){ toast("<strong>User ID required.</strong>"); return; }
  $("refreshSubBtn").disabled = true; $("refreshSubBtn").textContent = "Refreshing…";
  try{
    const q = new URLSearchParams({user_id:uid});
    const data = await apiFetch(`${ENDPOINTS.subStatus}?${q.toString()}`, {method:"GET"});
    state.subscription.status = (data.status || "unknown");
    $("subStatusText").textContent = String(state.subscription.status);
    updateSubActionButtonText();
  }catch(e){
    state.subscription.status = "unknown";
    $("subStatusText").textContent = "unknown";
    updateSubActionButtonText();
  }finally{
    $("refreshSubBtn").disabled = false; $("refreshSubBtn").textContent = "Refresh Status";
    updateSubActionEnabled();
  }
}

async function handleSubscriptionAction(){
  const uid = ($("userIdInput").value||"").trim();
  const email = ($("emailInput").value||"").trim();
  if(!uid){ toast("<strong>User ID required.</strong>"); return; }

  const btn = $("subActionBtn");
  btn.disabled = true;
  const old = btn.textContent; btn.textContent = "Working…";

  try{
    const st = (state.subscription.status||"unknown").toLowerCase();
    if(st==="active" || st==="trialing"){
      const data = await apiFetch(ENDPOINTS.portal, {method:"POST", body:JSON.stringify({user_id:uid})});
      if(data && data.portal_url){ location.href = data.portal_url; return; }
      toast("<strong>Portal not available.</strong>");
      return;
    }

    const data = await apiFetch(ENDPOINTS.checkout, {
      method:"POST",
      body: JSON.stringify({ user_id: uid, price_id: state.selectedPriceId, email })
    });
    if(data && data.checkout_url){ location.href = data.checkout_url; return; }
    toast("<strong>Checkout failed:</strong> missing checkout_url");
  }catch(e){
    toast(`<strong>Action failed:</strong> ${e.message}`);
    setErr(e.message);
  }finally{
    btn.disabled = false; btn.textContent = old;
  }
}

function initControls(){
  $("symbolInput").addEventListener("change", e=>{
    state.symbol = (e.target.value||"BTCUSDT").trim().toUpperCase();
    $("chartTitle").textContent = state.symbol;
  });

  $("loadBtn").addEventListener("click", ()=>{
    // 你后端还没 /api/market：这里不装作“已加载”，直接给 Demo + 提示
    renderDemoChart();
    toast("<strong>Market API pending:</strong> /api/market not enabled in app.py yet.");
  });

  $("refreshSubBtn").addEventListener("click", refreshSubscriptionStatus);
  $("subActionBtn").addEventListener("click", handleSubscriptionAction);
  $("userIdInput").addEventListener("input", updateSubActionEnabled);

  $("btnSelfTest").addEventListener("click", async ()=>{
    const ok = await checkHealth();
    if(ok) toast("Self test: backend reachable.");
    else toast("<strong>Self test failed:</strong> backend unreachable (CORS/URL/cache).");
  });

  $("copyLinkBtn").addEventListener("click", async ()=>{
    const u = new URL(location.href);
    u.searchParams.set("symbol", state.symbol);
    u.searchParams.set("tf", state.tf);
    await navigator.clipboard.writeText(u.toString());
    toast("Share link copied.");
  });

  $("exportPngBtn").addEventListener("click", async ()=>{
    try{ await Plotly.downloadImage("chart", {format:"png", filename:`${state.symbol}_${state.tf}`}); }
    catch(e){ toast(`<strong>Export failed:</strong> ${e.message}`); }
  });
}

async function boot(){
  // 永远先画 Demo，保证不会空白
  renderDemoChart();

  initTimeframesUI();
  initControls();

  await checkHealth();
  await loadPlans();
  await refreshSubscriptionStatus();
  updateSubActionButtonText();
}

boot();
</script>
</body>
</html>
