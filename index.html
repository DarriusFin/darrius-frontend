<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DarriusAI • Inflection Hunter</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root{
      --bg:#070b12;
      --panel:#0b1220;
      --line:#1a2a44;
      --txt:#e7eefc;
      --muted:#9cb0d6;
      --good:#2ee59d;
      --bad:#ff5c6c;
      --warn:#ffcc66;
      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 35% 20%, rgba(32,214,167,.10), transparent 60%),
                  radial-gradient(1000px 500px at 70% 10%, rgba(99,155,255,.10), transparent 60%),
                  var(--bg);
      color:var(--txt);
    }
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 360px 1fr 360px;
      gap:14px;
      padding:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .cardHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .brand .title{ font-weight:800; letter-spacing:.2px; }
    .brand .sub{ font-size:12px; color:var(--muted); }
    .badge{
      font-size:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:4px 8px;
      border-radius:999px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.ok{ color:var(--good); border-color: rgba(46,229,157,.35); background: rgba(46,229,157,.08); }
    .badge.warn{ color:var(--warn); border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.08); }
    .badge.bad{ color:var(--bad); border-color: rgba(255,92,108,.35); background: rgba(255,92,108,.08); }
    .cardBody{ padding:14px; overflow:auto; min-height:0; }

    .section{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sectionTitle{
      font-weight:800;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .mini{ font-size:12px; color:var(--muted); line-height:1.35; }
    .mono{ font-family: var(--mono); font-size:12px; color:rgba(231,238,252,.92); }
    .row{ display:flex; gap:10px; align-items:center; }

    label{ font-size:12px; color:var(--muted); }
    input, select{
      width:100%;
      border-radius:12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      color:var(--txt);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{ color:rgba(156,176,214,.55); }

    .btn{
      width:100%;
      border:none;
      border-radius:12px;
      padding:11px 12px;
      cursor:pointer;
      font-weight:900;
      color:#022016;
      background: linear-gradient(180deg, rgba(32,214,167,1), rgba(20,190,150,1));
      box-shadow: 0 10px 18px rgba(32,214,167,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:none;
      font-weight:700;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Center chart */
    #chartWrap{ padding:0; }
    #chartTop{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #chartTitle{ font-weight:900; letter-spacing:.2px; }
    #tfPills{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      color:var(--txt);
      border-color: rgba(32,214,167,.38);
      background: rgba(32,214,167,.10);
    }
    #chart{
      width:100%;
      height: calc(100vh - 14px*2 - 44px - 2px);
      min-height:520px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      font-size:13px;
      display:none;
      max-width: min(860px, 92vw);
      z-index:9999;
    }
    .toast.show{ display:block; }
    .toast strong{ color: var(--warn); }
    .divider{ height:1px; background: rgba(255,255,255,.06); margin:6px 0; }
  </style>
</head>

<body>
  <div class="app">

    <!-- LEFT -->
    <div class="card">
      <div class="cardHeader">
        <div class="brand">
          <div class="title">DarriusAI • Inflection Hunter</div>
          <div class="sub">AI 拐点猎手系统</div>
        </div>
        <div id="apiBadge" class="badge">API …</div>
      </div>

      <div class="cardBody">
        <div class="section">
          <div class="sectionTitle">
            Market Pulse
            <span id="pulseBadge" class="badge ok">BULL</span>
          </div>
          <div class="row">
            <div style="flex:1">
              <div class="mini">Sentiment</div>
              <div style="font-size:42px;font-weight:900;line-height:1; color:var(--good);" id="sentimentScore">—</div>
            </div>
            <div style="flex:2">
              <div class="mini" id="pulseDesc">Ready.</div>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <!-- Signal Summary (NO algorithm leakage) -->
        <div class="section">
          <div class="sectionTitle">Signal Summary</div>
          <div class="mini" id="signalText">Signals Ready</div>
          <div class="mini">Proprietary rules. UI shows confirmation status only.</div>
        </div>

        <div style="height:10px"></div>

        <div class="section">
          <div class="sectionTitle">Signals Count</div>
          <div class="mini">Buy: <span class="mono" id="buyCount">0</span> · Sell: <span class="mono" id="sellCount">0</span></div>
          <div class="mini" id="sigHint">—</div>
        </div>

        <div style="height:10px"></div>

        <div class="mini">
          Educational use only. No solicitation to buy/sell. Past performance is not indicative of future results.
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="card" id="chartWrap">
      <div id="chartTop">
        <div class="row" style="gap:10px;">
          <div id="chartTitle">BTCUSDT</div>
          <div class="badge" id="lastPrice">—</div>
          <div class="badge" id="loadedText">Loaded · —</div>
        </div>
        <div id="tfPills"></div>
      </div>
      <div id="chart"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="cardHeader">
        <div class="brand">
          <div class="title">Control Center • 控制台</div>
          <div class="sub">Market / Timeframe / Subscription</div>
        </div>
        <div class="badge">© 2026</div>
      </div>

      <div class="cardBody" style="display:flex; flex-direction:column; gap:12px;">

        <!-- Market -->
        <div class="section">
          <div class="sectionTitle">Market</div>

          <div class="row">
            <div style="flex:1">
              <label for="symbolInput">Symbol</label>
              <input id="symbolInput" placeholder="e.g. BTCUSDT" value="BTCUSDT" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="tfSelect">Timeframe</label>
              <select id="tfSelect"></select>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="loadBtn">Load • 加载</button>
          </div>

          <div class="mini" id="marketModeHint">
            Data Mode: <span class="mono" id="dataMode">DEMO</span>
          </div>

          <div class="mini" id="tfSupportHint" style="display:none; color: var(--warn);">
            <strong>Notice:</strong> timeframe not supported. Fallback to 1D.
          </div>
        </div>

        <!-- Indicators -->
        <div class="section">
          <div class="sectionTitle">Indicators</div>
          <div class="row">
            <label class="mini" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="toggleEMA" checked /> EMA
            </label>
            <label class="mini" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="toggleAUX" checked /> AUX
            </label>
            <label class="mini" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="toggleSignals" checked /> B/S
            </label>
          </div>
          <div class="mini">B/S are independent overlays and persist across redraws.</div>
        </div>

        <!-- Subscription (SINGLE BUTTON) -->
        <div class="section">
          <div class="sectionTitle">
            Subscription
            <span class="badge ok" id="stripeBadge">Stripe Secure</span>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="userIdInput">User ID</label>
              <input id="userIdInput" placeholder="e.g. user_123" value="darrius888"/>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="emailInput">Email (optional)</label>
              <input id="emailInput" placeholder="name@domain.com" value="perrywu666@outlook.com"/>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="planSelect">Plan</label>
              <select id="planSelect"></select>
              <div class="mini" id="planSelfCheck"></div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- only 2 lines status -->
          <div class="mini">
            <div>Status: <span id="subStatusText" class="mono">unknown</span></div>
            <div>Plan: <span id="subPlanText" class="mono">—</span></div>
          </div>

          <div class="row">
            <button class="btn" id="subActionBtn" disabled>Subscribe & Start</button>
          </div>

          <button class="btn secondary" id="refreshSubBtn">Refresh Status</button>
        </div>

        <!-- Utilities -->
        <div class="section">
          <div class="sectionTitle">Utilities</div>
          <div class="row">
            <button class="btn secondary" id="copyLinkBtn">Copy Share Link</button>
            <button class="btn secondary" id="exportPngBtn">Export PNG</button>
          </div>
          <div class="mini">Share link stores symbol/tf in URL.</div>
        </div>

      </div>
    </div>

  </div>

  <div id="toast" class="toast"></div>

<script>
/** =========================================================
 *  ✅ CONFIG — aligned to your current app.py (Render)
 *  ========================================================= */
const API_BASE = "https://darrius-api.onrender.com";

const ENDPOINTS = {
  health:   "/health",
  prices:   "/billing/prices",
  checkout: "/billing/checkout",
  subStatus:"/api/subscription/status",
  portal:   "/api/billing/portal",
  // market endpoint NOT required today; we will auto-switch if exists later
  market:   "/api/market"
};

const TIMEFRAMES = [
  {key:'5m', label:'5m'},
  {key:'15m', label:'15m'},
  {key:'30m', label:'30m'},
  {key:'1h', label:'1h'},
  {key:'4h', label:'4h'},
  {key:'1d', label:'1D'},
  {key:'1w', label:'1W'},
  {key:'1m', label:'1M'},
];
const FALLBACK_TF = '1d';

const PLAN_ORDER = { weekly:1, week:1, monthly:2, month:2, quarterly:3, quarter:3, yearly:4, year:4, annual:4 };

// ✅ Your 4 Stripe Price IDs (hard fallback)
const PLAN_CATALOG_FALLBACK = [
  { price_id:"price_1SpJMmR84UMUVSTg0T7xfm6r", interval:"weekly",    amount:4.90,   currency:"USD" },
  { price_id:"price_1SpbvRR84UMUVSTggbg0SFzi", interval:"monthly",   amount:19.90,  currency:"USD" },
  { price_id:"price_1SpbwYR84UMUVSTgMQpUrE42", interval:"quarterly", amount:49.90,  currency:"USD" },
  { price_id:"price_1SpbpxR84UMUVSTgapaJDjMX", interval:"yearly",    amount:189.00, currency:"USD" },
];

/** =========================
 *  STATE
 *  ========================= */
let state = {
  symbol: "BTCUSDT",
  tf: "1d",
  plans: [],
  selectedPriceId: null,
  subscription: { status: "unknown", plan: "" },
  chartData: null,
  marketMode: "DEMO" // DEMO until /api/market exists
};

function $(id){ return document.getElementById(id); }

function toast(msg, ms=2600){
  const el = $("toast");
  el.innerHTML = msg;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=> el.classList.remove("show"), ms);
}

function setApiBadge(kind, text){
  const b = $("apiBadge");
  b.textContent = text;
  b.className = "badge " + kind;
}

async function apiFetch(path, options={}){
  const url = API_BASE + path;
  const res = await fetch(url, {
    headers: { "Content-Type":"application/json" },
    ...options
  });
  const ct = res.headers.get("content-type") || "";
  let data = null;
  if(ct.includes("application/json")) data = await res.json().catch(()=>null);
  else data = { raw: await res.text().catch(()=> "") };

  if(!res.ok){
    const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

function normalizeTf(tf){
  tf = (tf||"").toLowerCase().trim();
  const ok = TIMEFRAMES.some(x=>x.key===tf);
  return ok ? tf : FALLBACK_TF;
}

function planNameByInterval(interval){
  interval = (interval||"").toLowerCase();
  if(interval === "week" || interval === "weekly") return "Weekly";
  if(interval === "month" || interval === "monthly") return "Monthly";
  if(interval === "quarter" || interval === "quarterly") return "Quarterly";
  if(interval === "year" || interval === "yearly" || interval === "annual") return "Yearly";
  return interval || "Plan";
}

function centsToUSD(amount){
  if(typeof amount !== "number") amount = Number(amount||0);
  if(Number.isFinite(amount) && !Number.isInteger(amount) && amount < 100) return amount.toFixed(2);
  if(Number.isInteger(amount) && amount >= 50) return (amount/100).toFixed(2);
  return Number(amount||0).toFixed(2);
}

function planLabel(p){
  const name = planNameByInterval(p.interval);
  const price = `$${centsToUSD(p.amount)}`;
  return `${name} — ${price}`;
}

function buildShareLink(symbol, tf){
  const u = new URL(location.href);
  u.searchParams.set("symbol", symbol);
  u.searchParams.set("tf", tf);
  return u.toString();
}

/** =========================
 *  TIMEFRAMES UI
 *  ========================= */
function initTimeframesUI(){
  const sel = $("tfSelect");
  sel.innerHTML = TIMEFRAMES.map(t => `<option value="${t.key}">${t.label}</option>`).join("");
  sel.value = state.tf;

  sel.addEventListener("change", ()=>{
    state.tf = normalizeTf(sel.value);
    setActiveTfPill(state.tf);
  });

  const wrap = $("tfPills");
  wrap.innerHTML = TIMEFRAMES.map(t => `<div class="pill" data-tf="${t.key}">${t.label}</div>`).join("");
  wrap.addEventListener("click", (e)=>{
    const p = e.target.closest(".pill");
    if(!p) return;
    const tf = p.getAttribute("data-tf");
    state.tf = normalizeTf(tf);
    $("tfSelect").value = state.tf;
    setActiveTfPill(state.tf);
  });

  setActiveTfPill(state.tf);
}

function setActiveTfPill(tf){
  tf = normalizeTf(tf);
  document.querySelectorAll(".pill").forEach(p=>{
    p.classList.toggle("active", normalizeTf(p.getAttribute("data-tf")) === tf);
  });
}

/** =========================
 *  CONTROLS
 *  ========================= */
function initControls(){
  $("symbolInput").addEventListener("change", (e)=>{
    state.symbol = (e.target.value || "BTCUSDT").trim().toUpperCase();
    $("chartTitle").textContent = state.symbol;
  });

  $("loadBtn").addEventListener("click", ()=> loadAndRender());

  $("toggleEMA").addEventListener("change", ()=> renderChart(state.chartData));
  $("toggleAUX").addEventListener("change", ()=> renderChart(state.chartData));
  $("toggleSignals").addEventListener("change", ()=> renderChart(state.chartData));

  $("copyLinkBtn").addEventListener("click", async ()=>{
    const link = buildShareLink(state.symbol, state.tf);
    await navigator.clipboard.writeText(link);
    toast("Share link copied.");
  });

  $("exportPngBtn").addEventListener("click", async ()=>{
    try{
      await Plotly.downloadImage("chart", {format:"png", filename:`${state.symbol}_${state.tf}`});
    }catch(err){
      toast(`<strong>Export failed:</strong> ${err.message}`);
    }
  });

  $("refreshSubBtn").addEventListener("click", ()=> refreshSubscriptionStatus());
  $("subActionBtn").addEventListener("click", ()=> handleSubscriptionAction());

  $("userIdInput").addEventListener("input", ()=> updateSubActionEnabled());
}

/** =========================
 *  ✅ PLANS: always 4
 *  ========================= */
async function loadPlans(){
  let plans = [];
  let fromBackend = false;

  try{
    const data = await apiFetch(ENDPOINTS.prices, { method:"GET" });
    // your backend returns array
    const raw = Array.isArray(data) ? data : (data.prices || data.data || []);
    plans = raw.map(p=>{
      const price_id = p.price_id || p.id || p.priceId || p.price;
      const interval = (p.plan || p.interval || p.nickname || "").toString().toLowerCase();
      // your backend doesn't provide amount; we accept missing and still keep
      return { price_id, interval, amount: 0, currency:"USD", raw:p };
    }).filter(x=>x.price_id);

    // if backend returns 4 ids, merge amount info from fallback
    if(plans.length === 4){
      plans = plans.map(p=>{
        const f = PLAN_CATALOG_FALLBACK.find(x=>x.price_id===p.price_id);
        return f ? {...p, interval: f.interval, amount:f.amount, currency:f.currency} : p;
      });
      fromBackend = true;
    }
  }catch(e){
    fromBackend = false;
  }

  if(plans.length !== 4){
    plans = PLAN_CATALOG_FALLBACK.map(x=>({ ...x, raw:x }));
    fromBackend = false;
  }

  plans.sort((a,b)=>{
    const ia = PLAN_ORDER[a.interval] ?? 99;
    const ib = PLAN_ORDER[b.interval] ?? 99;
    if(ia !== ib) return ia - ib;
    return Number(a.amount||0) - Number(b.amount||0);
  });

  state.plans = plans;

  const sel = $("planSelect");
  sel.innerHTML = plans.map(p => `<option value="${p.price_id}">${planLabel(p)}</option>`).join("");

  sel.onchange = ()=>{
    state.selectedPriceId = sel.value;
    updateSubPlanTextFromSelection();
    updateSubActionEnabled();
  };

  state.selectedPriceId = plans[0]?.price_id || null;
  if(state.selectedPriceId) sel.value = state.selectedPriceId;

  updateSubPlanTextFromSelection();
  updateSubActionEnabled();

  const el = $("planSelfCheck");
  if(fromBackend){
    el.textContent = "Plans OK: loaded 4 from backend.";
    el.style.color = "var(--good)";
  }else{
    el.textContent = "Plans OK: forced 4-plan fallback (safe).";
    el.style.color = "var(--warn)";
  }
}

function updateSubPlanTextFromSelection(){
  const p = state.plans.find(x=>x.price_id === state.selectedPriceId);
  $("subPlanText").textContent = p ? planLabel(p) : "—";
}

function updateSubActionEnabled(){
  const userId = ($("userIdInput").value||"").trim();
  $("subActionBtn").disabled = !(userId && state.selectedPriceId);
}

/** =========================
 *  SUBSCRIPTION (single button) — aligned to your app.py
 *  ========================= */
async function refreshSubscriptionStatus(){
  const userId = ($("userIdInput").value||"").trim();
  if(!userId){
    toast("<strong>User ID required.</strong>");
    return;
  }

  $("refreshSubBtn").disabled = true;
  $("refreshSubBtn").textContent = "Refreshing…";

  try{
    const qs = new URLSearchParams({ user_id: userId });
    const data = await apiFetch(`${ENDPOINTS.subStatus}?${qs.toString()}`, { method:"GET" });

    const status = (data.status || "unknown").toString().toLowerCase();
    const priceId = data.price_id || "";
    const plan = priceId ? (state.plans.find(p=>p.price_id===priceId)?.interval || priceId) : "";

    state.subscription = { status, plan };
    $("subStatusText").textContent = status;
    if(plan) $("subPlanText").textContent = plan;

    updateSubActionButtonText();

  }catch(err){
    state.subscription = { status:"unknown", plan:"" };
    $("subStatusText").textContent = "unknown";
    updateSubActionButtonText();
  }finally{
    $("refreshSubBtn").disabled = false;
    $("refreshSubBtn").textContent = "Refresh Status";
    updateSubActionEnabled();
  }
}

function updateSubActionButtonText(){
  const st = state.subscription.status;
  const btn = $("subActionBtn");
  if(st === "active" || st === "trialing"){
    btn.textContent = "Manage Subscription";
  }else if(st === "incomplete" || st === "past_due" || st === "pending"){
    btn.textContent = "Complete Checkout";
  }else{
    btn.textContent = "Subscribe & Start";
  }
}

async function handleSubscriptionAction(){
  const userId = ($("userIdInput").value||"").trim();
  const email = ($("emailInput").value||"").trim();

  if(!userId){
    toast("<strong>User ID required.</strong>");
    return;
  }

  const st = state.subscription.status;
  const btn = $("subActionBtn");
  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "Working…";

  try{
    if(st === "active" || st === "trialing"){
      const data = await apiFetch(ENDPOINTS.portal, {
        method:"POST",
        body: JSON.stringify({ user_id: userId })
      });
      if(data && data.portal_url){
        window.location.href = data.portal_url;
        return;
      }
      toast("<strong>Portal not available.</strong>");
      return;
    }

    if(!state.selectedPriceId){
      toast("<strong>Please select a plan.</strong>");
      return;
    }

    const data = await apiFetch(ENDPOINTS.checkout, {
      method:"POST",
      body: JSON.stringify({ user_id: userId, price_id: state.selectedPriceId, email })
    });

    if(data && data.checkout_url){
      window.location.href = data.checkout_url;
      return;
    }

    toast("<strong>Checkout error:</strong> missing checkout_url.");

  }catch(err){
    toast(`<strong>Action failed:</strong> ${err.message}`);
  }finally{
    btn.disabled = false;
    btn.textContent = oldText;
  }
}

/** =========================
 *  MARKET: today no /api/market — use DEMO data always
 *  Later, when you add /api/market, this will auto-switch to LIVE.
 *  ========================= */
async function detectMarketEndpoint(){
  try{
    // quick probe (HEAD may be blocked by CORS/proxy; use GET with short query)
    const qs = new URLSearchParams({ symbol:"BTCUSDT", tf:"1d" });
    await apiFetch(`${ENDPOINTS.market}?${qs.toString()}`, { method:"GET" });
    state.marketMode = "LIVE";
  }catch(_){
    state.marketMode = "DEMO";
  }
  $("dataMode").textContent = state.marketMode;
}

async function loadAndRender(){
  state.symbol = ($("symbolInput").value || "BTCUSDT").trim().toUpperCase();
  state.tf = normalizeTf($("tfSelect").value || state.tf || FALLBACK_TF);
  $("chartTitle").textContent = state.symbol;
  setActiveTfPill(state.tf);

  $("loadBtn").disabled = true;
  $("loadBtn").textContent = "Loading…";

  try{
    let payload = null;

    if(state.marketMode === "LIVE"){
      const qs = new URLSearchParams({ symbol: state.symbol, tf: state.tf });
      payload = await apiFetch(`${ENDPOINTS.market}?${qs.toString()}`, { method:"GET" });
      $("loadedText").textContent = `Loaded · TF=${state.tf.toUpperCase()} · Live`;
    }else{
      payload = buildDemoPayload(state.symbol, state.tf);
      $("loadedText").textContent = `Loaded · TF=${state.tf.toUpperCase()} · Demo`;
    }

    state.chartData = payload;
    renderChart(payload);
    updateLeftPanelsFromPayload(payload);

  }catch(err){
    toast(`<strong>Load failed:</strong> ${err.message}`);
  }finally{
    $("loadBtn").disabled = false;
    $("loadBtn").textContent = "Load • 加载";
  }
}

/** =========================
 *  DEMO payload generator (stable and nice-looking)
 *  ========================= */
function buildDemoPayload(symbol, tf){
  const N = 140;
  const now = new Date();
  const stepMs = tfToStepMs(tf);

  let candles = [];
  let base = 90000;
  for(let i=0;i<N;i++){
    const t = new Date(now.getTime() - (N-1-i)*stepMs).toISOString();
    const wave1 = Math.sin(i/12) * 520;
    const wave2 = Math.sin(i/28) * 980;
    const trend = (i < 92) ? i*210 : (92*210 - (i-92)*360);
    const c = base + trend + wave1 + wave2;

    const o = c + Math.sin(i/6) * 120;
    const h = Math.max(o,c) + 220 + (i%4)*25;
    const l = Math.min(o,c) - 220 - (i%3)*35;

    candles.push({ t, o:round2(o), h:round2(h), l:round2(l), c:round2(c) });
  }

  // EMA(20)
  const k = 2/(20+1);
  let emaVal = candles[0].c;
  let ema = candles.map((d)=>{
    emaVal = d.c*k + emaVal*(1-k);
    return { t:d.t, v: round2(emaVal) };
  });

  // AUX as slight offset of EMA (placeholder)
  const aux = ema.map((d)=>({ t:d.t, v: round2(d.v * 0.998) }));

  // Signals: B near early low, S near peak
  const buyIdx = 10;
  const sellIdx = 86;
  const signals = [
    { type:"B", t:candles[buyIdx].t, price:candles[buyIdx].c },
    { type:"S", t:candles[sellIdx].t, price:candles[sellIdx].c },
  ];

  return {
    symbol, tf,
    candles, ema, aux, signals,
    sentiment_score: 91,
    pulse: "BULL",
    pulse_desc: "Demo mode. Market API will be enabled soon.",
    current_signal: "Signals Ready"
  };
}

function tfToStepMs(tf){
  if(tf==="5m") return 5*60*1000;
  if(tf==="15m") return 15*60*1000;
  if(tf==="30m") return 30*60*1000;
  if(tf==="1h") return 60*60*1000;
  if(tf==="4h") return 4*60*60*1000;
  if(tf==="1d") return 24*60*60*1000;
  if(tf==="1w") return 7*24*60*60*1000;
  if(tf==="1m") return 30*24*60*60*1000;
  return 24*60*60*1000;
}

function round2(x){ return Math.round(Number(x)*100)/100; }

/** =========================
 *  CHART (B/S overlay stable)
 *  ========================= */
function renderChart(payload){
  if(!payload){
    Plotly.newPlot("chart", [], baseLayout(), {displayModeBar:false, responsive:true});
    return;
  }

  const candles = payload.candles || [];
  const ema = payload.ema || [];
  const aux = payload.aux || [];
  const signals = payload.signals || [];

  const x = candles.map(d => d.t);
  const open = candles.map(d => d.o);
  const high = candles.map(d => d.h);
  const low  = candles.map(d => d.l);
  const close= candles.map(d => d.c);

  const last = close.length ? close[close.length-1] : null;
  $("lastPrice").textContent = last ? `Last: ${Number(last).toFixed(2)}` : "—";

  const showEMA = $("toggleEMA").checked;
  const showAUX = $("toggleAUX").checked;
  const showSig = $("toggleSignals").checked;

  const traces = [{
    type:"candlestick",
    x, open, high, low, close,
    name:"Price",
    increasing: {line:{color:"#2ee59d"}},
    decreasing: {line:{color:"#ff5c6c"}},
    hoverlabel:{ bgcolor:"rgba(0,0,0,.75)" }
  }];

  if(showEMA){
    traces.push({ type:"scatter", mode:"lines",
      x: ema.map(d=>d.t), y: ema.map(d=>d.v),
      name:"EMA", line:{width:2, color:"rgba(255,255,255,.65)"},
      hoverinfo:"skip"
    });
  }
  if(showAUX){
    traces.push({ type:"scatter", mode:"lines",
      x: aux.map(d=>d.t), y: aux.map(d=>d.v),
      name:"AUX", line:{width:2, color:"rgba(99,155,255,.75)"},
      hoverinfo:"skip"
    });
  }

  const normSide = (s)=>{
    const t = (s.type ?? s.side ?? s.signal ?? "").toString().trim().toUpperCase();
    if(["B","BUY","LONG","ENTRY"].includes(t)) return "B";
    if(["S","SELL","SHORT","EXIT"].includes(t)) return "S";
    return "";
  };

  const buys = signals.filter(s=>normSide(s)==="B");
  const sells = signals.filter(s=>normSide(s)==="S");
  $("buyCount").textContent = String(buys.length);
  $("sellCount").textContent = String(sells.length);

  if(showSig){
    if(buys.length){
      traces.push({
        type:"scatter", mode:"markers+text", name:"Buy",
        x: buys.map(s=>s.t), y: buys.map(s=>s.price),
        text: buys.map(()=> "B"), textposition:"top center",
        marker:{size:10, color:"#2ee59d", line:{width:1, color:"rgba(0,0,0,.45)"}},
        hovertemplate:"<b>B</b><br>%{x}<br>%{y}<extra></extra>"
      });
    }
    if(sells.length){
      traces.push({
        type:"scatter", mode:"markers+text", name:"Sell",
        x: sells.map(s=>s.t), y: sells.map(s=>s.price),
        text: sells.map(()=> "S"), textposition:"bottom center",
        marker:{size:10, color:"#ff5c6c", line:{width:1, color:"rgba(0,0,0,.45)"}},
        hovertemplate:"<b>S</b><br>%{x}<br>%{y}<extra></extra>"
      });
    }
  }

  $("sigHint").textContent = (state.marketMode==="DEMO")
    ? "Demo signals shown. Live market signals will appear when /api/market is enabled."
    : "Live signals ready.";

  Plotly.react("chart", traces, baseLayout(), {displayModeBar:false, responsive:true});
}

function baseLayout(){
  return {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:60,r:20,t:18,b:40},
    xaxis:{ gridcolor:"rgba(255,255,255,.06)", tickfont:{color:"rgba(231,238,252,.7)"}, rangeslider:{visible:false}, zeroline:false },
    yaxis:{ gridcolor:"rgba(255,255,255,.06)", tickfont:{color:"rgba(231,238,252,.7)"}, zeroline:false },
    legend:{ orientation:"h", y:1.02, x:0, font:{color:"rgba(231,238,252,.65)"} }
  };
}

/** =========================
 *  LEFT PANEL (NO algorithm leakage)
 *  ========================= */
function updateLeftPanelsFromPayload(payload){
  const sentiment = payload.sentiment_score ?? payload.sentiment ?? null;
  $("sentimentScore").textContent = (sentiment!==null && sentiment!==undefined) ? Math.round(Number(sentiment)) : "—";

  const pulse = (payload.pulse ?? "BULL").toString().toUpperCase();
  $("pulseBadge").textContent = pulse;
  $("pulseBadge").className = pulse.includes("BEAR") ? "badge bad" : "badge ok";
  $("pulseDesc").textContent = payload.pulse_desc ?? "Ready.";

  // Important: never show algorithm internals
  $("signalText").textContent = payload.current_signal || "Signals Ready";
}

/** =========================
 *  HEALTH + BOOT
 *  ========================= */
async function checkHealth(){
  try{
    await apiFetch(ENDPOINTS.health, { method:"GET" });
    setApiBadge("ok", "API OK");
    return true;
  }catch(e){
    setApiBadge("bad", "API ERR");
    return false;
  }
}

async function boot(){
  // URL params
  const params = new URLSearchParams(location.search);
  const urlSymbol = (params.get("symbol")||"").trim();
  const urlTf = normalizeTf(params.get("tf")||"");

  if(urlSymbol) state.symbol = urlSymbol.toUpperCase();
  if(urlTf) state.tf = urlTf;

  $("symbolInput").value = state.symbol;
  $("chartTitle").textContent = state.symbol;

  initTimeframesUI();
  initControls();

  renderChart(null);

  await checkHealth();
  await loadPlans();                 // ✅ always 4 plans
  await refreshSubscriptionStatus(); // optional

  $("tfSelect").value = state.tf;
  setActiveTfPill(state.tf);

  state.selectedPriceId = $("planSelect").value || state.plans[0]?.price_id || null;
  updateSubPlanTextFromSelection();
  updateSubActionEnabled();
  updateSubActionButtonText();

  // Detect if /api/market exists; if not, stay DEMO
  await detectMarketEndpoint();

  await loadAndRender();

  // Update URL
  history.replaceState({}, "", buildShareLink(state.symbol, state.tf));
}

boot();
</script>
</body>
</html>
