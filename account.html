<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DarriusAI · Account & Subscription</title>

  <style>
    :root{
      --bg:#0B0F17;
      --bg2:#0A1220;
      --border:rgba(255,255,255,.08);
      --text:#EAF0F7;
      --muted:#A2B0C2;

      --brand1:#2BE2A6;
      --brand2:#4CC2FF;
      --warn:#FFB86C;
      --danger:#FF5A5A;
      --ok:#39F3A1;

      --shadow: 0 18px 45px rgba(0,0,0,.40);
      --shadow2: 0 10px 25px rgba(0,0,0,.28);

      --r12:12px;
      --r14:14px;
      --r18:18px;

      --gradBrand: linear-gradient(90deg, rgba(43,226,166,1) 0%, rgba(76,194,255,1) 100%);

      /* ✅ Logo 放大到 2.5x */
      --logoSize:160px;
      --logoRadius:44px;
      --logoGlowOpacity:.72;
      --logoGlowBlur:.3px;
      --logoGlowSpeed:6.8s;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,194,255,.10), transparent 60%),
        radial-gradient(900px 520px at 88% 12%, rgba(43,226,166,.10), transparent 62%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
    }

    a{ color: rgba(76,194,255,.95); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* ===== Topbar ===== */
    #topbar{
      height:96px;
      padding:0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(10,15,23,.55);
      backdrop-filter: blur(10px);
    }

    #brand{
      display:flex;
      align-items:center;
      gap:16px;
      min-width:460px;
    }

    .logo{
      width: var(--logoSize);
      height: var(--logoSize);
      border-radius: var(--logoRadius);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
      position:relative;
      overflow:hidden;
      flex:0 0 auto;
      background: rgba(0,0,0,.16);
      isolation:isolate;
    }
    .logo img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      border-radius:inherit;
      display:block;
      z-index:1;
      user-select:none;
      -webkit-user-drag:none;
    }
    @keyframes logoSpin{ to{ transform: rotate(360deg);} }
    .logo::after{
      content:"";
      position:absolute; inset:-70%;
      background: conic-gradient(from 180deg,
        rgba(43,226,166,0),
        rgba(43,226,166,.68),
        rgba(76,194,255,.68),
        rgba(255,90,90,.52),
        rgba(43,226,166,0));
      animation: logoSpin var(--logoGlowSpeed) linear infinite;
      opacity: var(--logoGlowOpacity);
      pointer-events:none;
      z-index:2;
      mix-blend-mode: screen;
      filter: blur(var(--logoGlowBlur));
    }

    #brandText{ line-height:1.08; }
    #brandLine1{
      font-weight:950;
      letter-spacing:.3px;
      font-size:26px;
    }
    #brandLine1 .accent{
      background: var(--gradBrand);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    #brandLine2{
      margin-top:7px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chip{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,247,.90);
      white-space:nowrap;
    }
    .chip.brand{
      border:1px solid rgba(43,226,166,.30);
      background: rgba(43,226,166,.12);
      color: rgba(234,240,247,.95);
    }

    #topRight{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width:380px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,26,40,.65);
      box-shadow: var(--shadow2);
      font-size:12px;
      color: var(--text);
      white-space:nowrap;
      max-width: 46vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(57,243,161,.12);
      flex:0 0 auto;
    }
    .btnTop{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: rgba(234,240,247,.90);
      border-radius:999px;
      padding:9px 12px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }

    /* ===== Layout ===== */
    #wrap{ padding:16px; }
    #grid{
      height: calc(100vh - 96px);
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:16px;
      min-height:0;
    }

    .panel{
      background: linear-gradient(180deg, rgba(18,26,40,.92), rgba(15,23,38,.88));
      border: 1px solid var(--border);
      border-radius: var(--r18);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .panelHeader{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .panelHeader .h{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panelBody{
      padding:14px;
      overflow:auto;
      min-height:0;
    }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,247,.92);
      font-weight:950;
      letter-spacing:.3px;
      white-space:nowrap;
    }
    .badge.ok{
      border-color: rgba(57,243,161,.35);
      background: rgba(57,243,161,.14);
    }
    .badge.bad{
      border-color: rgba(255,90,90,.35);
      background: rgba(255,90,90,.12);
    }

    .card{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--r14);
      padding:12px;
      margin-bottom:12px;
    }

    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      color: var(--muted);
      font-size:12px;
    }
    .cardTitle b{
      color: var(--text);
      font-size:12.5px;
      font-weight:900;
    }

    .note{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .note b{ color: var(--text); }

    .field{ margin-bottom:10px; }
    .label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
      font-size:12px;
      color: var(--muted);
    }
    .label b{ color: var(--text); }

    input{
      width:100%;
      background: rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 10px;
      border-radius: var(--r12);
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(162,176,194,.80); }
    input:focus{
      border-color: rgba(76,194,255,.50);
      box-shadow: 0 0 0 4px rgba(76,194,255,.12);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .btn{
      width:100%;
      border:0;
      color:#081119;
      font-weight:950;
      letter-spacing:.3px;
      padding:12px 12px;
      border-radius: var(--r12);
      cursor:pointer;
      background: var(--gradBrand);
      box-shadow: var(--shadow2);
      transition: transform .06s ease, filter .15s ease;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight:900;
      padding:11px 12px;
      border-radius: var(--r12);
      cursor:pointer;
      background: rgba(0,0,0,.14);
      transition: transform .06s ease, filter .15s ease;
    }
    .btnGhost:hover{ filter: brightness(1.05); }
    .btnGhost:active{ transform: translateY(1px); }

    .kv{
      display:grid;
      grid-template-columns: 220px 1fr; /* ✅ 左标签右值，稳定不乱 */
      gap:10px 14px;
      font-size:12px;
      color: var(--muted);
      align-items:center;
    }
    .kv b{ color: var(--text); font-weight:950; }
    .kv .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    @media (max-width: 1180px){
      #topbar{ height:auto; padding:12px 14px; align-items:flex-start; }
      #grid{ height:auto; grid-template-columns: 1fr; }
      #brand{ min-width:0; }
      #topRight{ min-width:0; }
      :root{
        --logoSize: 120px;
        --logoRadius: 34px;
      }
      .kv{ grid-template-columns: 140px 1fr; }
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="brand">
      <div class="logo" aria-label="darrius.ai logo">
        <img id="logoImg" alt="darrius.ai logo">
      </div>
      <div id="brandText">
        <div id="brandLine1"><span class="accent">DarriusAI</span> · Inflection Hunter</div>
        <div id="brandLine2">
          <span class="chip brand">Account & Subscription Management</span>
          <span class="chip">账户与订阅管理</span>
        </div>
      </div>
    </div>

    <div id="topRight">
      <div class="pill"><span class="dot"></span><span id="loginText">Logged in · 已登录</span></div>
      <div class="pill"><span class="dot"></span><span id="accessText">Access: DELAYED · 市场数据（延时）</span></div>
      <button class="btnTop" id="backBtn">← Back to Dashboard（返回主界面）</button>
    </div>
  </div>

  <div id="wrap">
    <div id="grid">

      <!-- LEFT MAIN -->
      <div class="panel">
        <div class="panelHeader">
          <div class="h">Subscription Overview · 订阅概览</div>
          <div class="badge" id="statusBadge">STATUS: UNKNOWN</div>
        </div>

        <div class="panelBody">
          <div class="note" style="margin-bottom:12px">
            This page manages your subscription. Access & data mode are enforced by backend policy.<br/>
            本页用于订阅管理；访问权限与数据模式由后端策略控制。
          </div>

          <!-- Input Card -->
          <div class="card">
            <div class="cardTitle"><b>Identity · 身份信息</b><span class="note">用于拉取订阅状态</span></div>

            <div class="row2" style="margin-top:0">
              <div class="field" style="margin-bottom:0">
                <div class="label"><span><b>User ID</b>（用户ID）</span><span class="note">必填</span></div>
                <input id="userId" placeholder="例如：darrius888">
                <div class="note" style="margin-top:6px">Used to fetch status and open portal.<br/>用于查询状态并进入账单管理。</div>
              </div>

              <div class="field" style="margin-bottom:0">
                <div class="label"><span>Email（邮箱）</span><span class="note">可选</span></div>
                <input id="email" placeholder="例如：perry.darrius@outlook.com">
                <div class="note" style="margin-top:6px">Optional; helps match Stripe customer.<br/>可选：帮助匹配 Stripe 客户。</div>
              </div>
            </div>

            <div class="row2">
              <button class="btn" id="saveBtn">Save（保存/刷新）</button>
              <button class="btnGhost" id="refreshBtn">Refresh Status（刷新状态）</button>
            </div>
          </div>

          <!-- Status Card -->
          <div class="card">
            <div class="cardTitle"><b>Status · 状态信息</b><span class="note" id="backendHint">Backend: —</span></div>

            <div class="kv">
              <span>User（用户）</span><b class="mono" id="kvUser">—</b>
              <span>Current Plan（当前套餐）</span><b id="kvPlan">—</b>
              <span>Subscription Status（订阅状态）</span><b id="kvSubStatus">—</b>
              <span>Renews / Ends（续订/到期）</span><b class="mono" id="kvEnds">—</b>
              <span>Data Source Mode（数据模式）</span><b id="kvDataMode">—</b>
            </div>

            <div class="note" style="margin-top:10px">
              Note: After cancellation, access often remains active until period end (policy-dependent).<br/>
              说明：取消订阅后通常可用至周期结束（以策略为准）。
            </div>
          </div>

          <!-- Actions -->
          <div class="card">
            <div class="cardTitle"><b>Actions · 操作</b><span class="note">不改变你的数据授权</span></div>

            <div class="row2" style="margin-top:0">
              <button class="btn" id="portalBtn">Open Billing Portal（账单管理）</button>
              <button class="btn" id="chooseBtn">Choose / Change Plan（选择/更换套餐）</button>
            </div>

            <div class="note" style="margin-top:10px">
              These buttons should route to your existing billing flow.<br/>
              这两个按钮应跳转到你现有的订阅支付/管理流程（不在本页硬改逻辑）。
            </div>
          </div>

          <!-- Plans placeholder -->
          <div class="card">
            <div class="cardTitle"><b>Plans（套餐）</b><span class="note">Overview</span></div>
            <div class="note">
              If you want, we can render plan cards here by calling your existing <b>/billing/prices</b> API and mapping IDs.<br/>
              如需恢复套餐列表，我们可直接读取你后端 prices 接口展示（不动支付逻辑）。
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="panel">
        <div class="panelHeader">
          <div class="h">Control Center · 控制台</div>
          <div class="badge" id="sysBadge">SYSTEM（系统）</div>
        </div>

        <div class="panelBody">
          <div class="card">
            <div class="cardTitle"><b>Quick Actions（快捷操作）</b></div>
            <button class="btnGhost" id="openDashBtn">Open Dashboard（打开主界面）</button>
          </div>

          <div class="card">
            <div class="cardTitle"><b>Support（支持）</b></div>
            <div class="note">
              Billing: use Billing Portal first (invoices, payment methods, cancellations).<br/>
              账单：优先使用账单管理（发票、付款方式、取消订阅）。<br/>
              Tech: support@darrius.ai
            </div>
          </div>

          <div class="card">
            <div class="cardTitle"><b>System（系统信息）</b></div>
            <div class="kv" style="grid-template-columns: 120px 1fr;">
              <span>Build（版本）</span><b class="mono" id="buildText">—</b>
              <span>Backend（后端）</span><b id="backendText">—</b>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    window.API_BASE = "https://darrius-api.onrender.com";
    window.__API_BASE__ = window.__API_BASE__ || window.API_BASE;

    // ✅ Logo loader w/ fallback
    (function(){
      const img = document.getElementById('logoImg');
      if (!img) return;
      const candidates = [
        '/assets/logo.png',
        '/assets/logo.webp',
        '/assets/icon.png',
        '/favicon.png',
        '/favicon.ico'
      ];
      let idx = 0;
      img.onerror = () => {
        idx += 1;
        if (idx < candidates.length) img.src = candidates[idx];
      };
      img.src = candidates[0];
    })();
  </script>

  <script>
    (function(){
      const base = (window.__API_BASE__ || window.API_BASE || '').replace(/\/+$/,'');
      const $ = (id) => document.getElementById(id);

      const userIdEl = $('userId');
      const emailEl  = $('email');

      function setBadge(kind, text){
        const b = $('statusBadge');
        if (!b) return;
        b.classList.remove('ok','bad');
        if (kind === 'ok') b.classList.add('ok');
        if (kind === 'bad') b.classList.add('bad');
        b.textContent = text || 'STATUS: UNKNOWN';
      }

      function normStatus(s){
        return (s || '').toString().trim().toUpperCase();
      }

      async function refreshStatus(){
        const uid = (userIdEl && userIdEl.value || '').trim();
        const em  = (emailEl && emailEl.value || '').trim();

        if (!uid){
          setBadge('bad', 'STATUS: MISSING USER');
          return;
        }

        try{
          localStorage.setItem('darrius_user_id', uid);
          if (em) localStorage.setItem('darrius_email', em);
        }catch(e){}

        $('backendHint').textContent = 'Backend: fetching…';
        $('backendText').textContent = 'Connecting…';

        try{
          const url = base + '/billing/status?user_id=' + encodeURIComponent(uid) + (em ? '&email=' + encodeURIComponent(em) : '');
          const res = await fetch(url, { method:'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const j = await res.json().catch(() => ({}));

          const plan   = j.plan || j.current_plan || j.price_name || '—';
          const status = j.status || j.subscription_status || '—';
          const ends   = j.renews_or_ends || j.ends_at || j.current_period_end || '—';
          const mode   = j.data_mode || j.data_source || 'DELAYED';

          $('kvUser').textContent = j.user || uid;
          $('kvPlan').textContent = plan;
          $('kvSubStatus').textContent = status;
          $('kvEnds').textContent = ends;
          $('kvDataMode').textContent = mode;

          $('buildText').textContent = j.build || new Date().toISOString();
          $('backendText').textContent = 'Connected';
          $('backendHint').textContent = 'Backend: connected';

          const st = normStatus(status);
          if (st.includes('ACTIVE') || st.includes('TRIAL')) setBadge('ok', 'STATUS: ' + st);
          else if (st && st !== '—') setBadge('bad', 'STATUS: ' + st);
          else setBadge('', 'STATUS: UNKNOWN');
        }catch(e){
          // ✅ 不假 ACTIVE：失败就 UNKNOWN（方便你定位真实问题）
          $('kvUser').textContent = uid;
          $('kvPlan').textContent = '—';
          $('kvSubStatus').textContent = '—';
          $('kvEnds').textContent = '—';
          $('kvDataMode').textContent = '—';

          $('buildText').textContent = new Date().toISOString();
          $('backendText').textContent = 'Disconnected';
          $('backendHint').textContent = 'Backend: disconnected';

          setBadge('', 'STATUS: UNKNOWN');
        }
      }

      // restore cached
      try{
        const uid = localStorage.getItem('darrius_user_id') || '';
        const em  = localStorage.getItem('darrius_email') || '';
        if (uid) userIdEl.value = uid;
        if (em) emailEl.value = em;
      }catch(e){}

      $('saveBtn')?.addEventListener('click', refreshStatus);
      $('refreshBtn')?.addEventListener('click', refreshStatus);

      $('openDashBtn')?.addEventListener('click', () => { window.location.href = '/index.html'; });
      $('backBtn')?.addEventListener('click', () => { window.location.href = '/index.html'; });

      // ✅ 不碰你现有订阅支付逻辑：这里只做“跳转占位”
      $('portalBtn')?.addEventListener('click', () => {
        alert('请将该按钮接到你后端已有的 Billing Portal 路由（例如 /billing/portal 或 /billing/manage）。目前保持占位，不改支付逻辑。');
      });
      $('chooseBtn')?.addEventListener('click', () => {
        alert('请将该按钮接到你现有的 Checkout Flow（例如 /billing/checkout 或 create-checkout-session）。目前保持占位，不改支付逻辑。');
      });

      // auto refresh once
      setTimeout(refreshStatus, 250);
    })();
  </script>
</body>
</html>
