<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DarriusAI · Account & Subscription</title>

  <style>
    :root{
      --bg:#0B0F17;
      --bg2:#0A1220;
      --panel:#121A28;
      --border:rgba(255,255,255,.08);
      --text:#EAF0F7;
      --muted:#A2B0C2;
      --brand1:#2BE2A6;
      --brand2:#4CC2FF;
      --danger:#FF5A5A;
      --shadow: 0 18px 45px rgba(0,0,0,.40);
      --shadow2: 0 10px 25px rgba(0,0,0,.28);
      --r12:12px; --r14:14px; --r18:18px;
      --gradBrand: linear-gradient(90deg, rgba(43,226,166,1) 0%, rgba(76,194,255,1) 100%);

      /* ✅ Logo control (按你要求 3.3 倍) */
      --logoBase: 40px;
      --logoScale: 3.0;
      --logoSize: calc(var(--logoBase) * var(--logoScale));
      --logoRadius: 18px;

      /* ✅ Page gutters (黄色留白) */
      --pageMax: 1480px;
      --pagePadX: 56px;
      --pagePadY: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,194,255,.10), transparent 60%),
        radial-gradient(900px 520px at 88% 12%, rgba(43,226,166,.10), transparent 62%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
    }
    a{ color: rgba(76,194,255,.95); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* ===== Top bar ===== */
    #topbar{
      height:78px;
      padding:0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(10,15,23,.55);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:420px;
    }

    .logoBox{
      width: var(--logoSize);
      height: var(--logoSize);
      border-radius: var(--logoRadius);
      overflow:hidden;
      border: 0;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      flex:0 0 auto;
      background: rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #logoImg{
      width: 100%;
      height: 100%;
      border-radius: var(--logoRadius);
      object-fit: cover;
      display:block;
    }

    .brandText{ line-height:1.08; }
    .brandLine1{
      font-weight:950;
      letter-spacing:.3px;
      font-size:22px;
    }
    .brandLine1 .accent{
      background: var(--gradBrand);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .brandLine2{
      margin-top:7px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chip{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,247,.90);
      white-space:nowrap;
    }
    .chip.brand{
      border:1px solid rgba(43,226,166,.30);
      background: rgba(43,226,166,.12);
      color: rgba(234,240,247,.95);
    }

    .topRight{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width:360px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,26,40,.65);
      box-shadow: var(--shadow2);
      font-size:12px;
      color: var(--text);
      white-space:nowrap;
      max-width: 42vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--brand1);
      box-shadow: 0 0 0 4px rgba(43,226,166,.10);
      flex:0 0 auto;
    }
    .dot.bad{
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(255,90,90,.10);
    }
    .btnTop{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: rgba(234,240,247,.90);
      border-radius:999px;
      padding:9px 12px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }

    /* ===== Main ===== */
    #wrap{
      padding: var(--pagePadY) var(--pagePadX);
      max-width: var(--pageMax);
      margin: 0 auto; /* ✅ 黄色留白来自页面居中 + max-width */
    }

    #grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      min-height: calc(100vh - 78px - 40px);
    }

    .panel{
      background: linear-gradient(180deg, rgba(18,26,40,.92), rgba(15,23,38,.88));
      border: 1px solid var(--border);
      border-radius: var(--r18);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
      position:relative;
    }
    .panelHeader{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .panelHeader .h{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panelBody{ padding:14px; min-height:0; }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(43,226,166,.30);
      background: rgba(43,226,166,.12);
      color: rgba(234,240,247,.95);
      font-weight:950;
      letter-spacing:.3px;
      user-select:none;
    }
    .badge.bad{
      border-color: rgba(255,90,90,.30);
      background: rgba(255,90,90,.12);
    }

    .card{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--r14);
      padding:12px;
      margin-bottom:12px;
      position:relative;
      z-index:5;
    }
    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      color: var(--muted);
      font-size:12px;
    }
    .cardTitle b{ color: var(--text); font-size:12.5px; font-weight:900; }

    .field{ margin-bottom:10px; }
    .label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
      font-size:12px;
      color: var(--muted);
    }
    .label b{ color: var(--text); }

    input{
      width:100%;
      background: rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 10px;
      border-radius: var(--r12);
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(162,176,194,.80); }
    input:focus{
      border-color: rgba(76,194,255,.50);
      box-shadow: 0 0 0 4px rgba(76,194,255,.12);
    }

    .note{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .note b{ color: var(--text); }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      font-size:12px;
      color: var(--muted);
    }
    .kv b{
      color: var(--text);
      font-weight:950;
      text-align:right;
    }
    /* ✅ Status 3 lines: make sure long texts don't crush layout */
    .kv .kvVal{
      max-width: 60ch;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:0;
      color:#081119;
      font-weight:950;
      letter-spacing:.3px;
      padding:10px 16px;
      border-radius: var(--r12);
      cursor:pointer;
      user-select:none;
      background: var(--gradBrand);
      box-shadow: var(--shadow2);
      transition: transform .06s ease, filter .15s ease;
      min-width: 170px;
      position:relative;
      z-index:20;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight:900;
      padding:10px 16px;
      border-radius: var(--r12);
      cursor:pointer;
      user-select:none;
      background: rgba(0,0,0,.14);
      transition: transform .06s ease, filter .15s ease;
      min-width: 170px;
      position:relative;
      z-index:20;
    }
    .btnGhost:hover{ filter: brightness(1.05); }
    .btnGhost:active{ transform: translateY(1px); }

    .btnRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-top:10px;
      position:relative;
      z-index:10;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .plansGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .planCard{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--r14);
      padding:12px;
      overflow:hidden;
      min-height: 150px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      position:relative;
      z-index:5;
    }
    .planTop{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .planName{ font-weight:950; letter-spacing:.2px; }
    .planPrice{ font-weight:950; }
    .planDesc{ margin-top:6px; font-size:12px; color: var(--muted); line-height:1.4; }
    .pillMini{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid rgba(43,226,166,.22);
      background: rgba(43,226,166,.10);
      color: rgba(234,240,247,.90);
      margin-top:8px;
      width: fit-content;
    }
    .planActions{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:20;
    }

    /* ✅ hide internal source labels that were red-boxed */
    #plansSource{ display:none; }
    #plansSource2{ display:none; }

    footer{
      padding:14px 18px;
      color: rgba(234,240,247,.62);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      opacity:.9;
      max-width: var(--pageMax);
      margin: 0 auto;
    }

    @media (max-width: 1180px){
      :root{ --pagePadX: 18px; }
      #grid{ grid-template-columns: 1fr; }
      .brand{ min-width:0; }
      .topRight{ min-width:0; }
      .plansGrid{ grid-template-columns: 1fr; }
    }

    /* =====================================================================
     * ✅ Step 2: account.html#plans auto scroll + highlight (UI-only)
     * ===================================================================== */
    .darr-plans-anchor { scroll-margin-top: 92px; }
    .darr-plans-focus {
      outline: 2px solid rgba(76,194,255,.45);
      box-shadow:
        0 0 0 6px rgba(76,194,255,.12),
        0 16px 60px rgba(0,0,0,.30);
      border-radius: var(--r14);
      transition: box-shadow .25s ease, outline-color .25s ease;
    }
    @keyframes darrPulse {
      0%   { box-shadow: 0 0 0 0 rgba(43,226,166,.18), 0 16px 60px rgba(0,0,0,.25); }
      60%  { box-shadow: 0 0 0 10px rgba(43,226,166,.10), 0 16px 60px rgba(0,0,0,.30); }
      100% { box-shadow: 0 0 0 0 rgba(43,226,166,.00), 0 16px 60px rgba(0,0,0,.25); }
    }
    .darr-plans-pulse { animation: darrPulse 1.05s ease-in-out 0s 2; }
  </style>
</head>

<body>
  <div id="topbar">
    <div class="brand">
      <div class="logoBox" aria-hidden="true">
        <img id="logoImg" alt="darrius.ai logo" />
      </div>
      <div class="brandText">
        <div class="brandLine1"><span class="accent">DarriusAI</span> · Inflection Hunter</div>
        <div class="brandLine2">
          <span class="chip brand">Account & Subscription</span>
          <span class="chip">账户与订阅管理</span>
        </div>
      </div>
    </div>

    <div class="topRight">
      <div class="pill" id="loginPill"><span class="dot" id="loginDot"></span><span id="loginText">Logged in · 已登录</span></div>
      <div class="pill" id="accessPill"><span class="dot"></span><span id="accessText">Access: DELAYED · 市场数据（延时）</span></div>
      <button class="btnTop" id="backBtn">← Back to Dashboard（返回主界面）</button>
    </div>
  </div>

  <div id="wrap">
    <div id="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="panelHeader">
          <div class="h">Subscription Overview · 订阅概览</div>
          <div class="badge bad" id="statusBadge">STATUS: UNKNOWN</div>
        </div>

        <div class="panelBody">
          <div class="card">
            <div class="cardTitle"><b>Identity · 身份信息</b><span class="note" id="backendHint">Backend: —</span></div>

            <div class="row2">
              <div class="field">
                <div class="label"><span><b>User ID</b>（用户ID）</span><span>必填</span></div>
                <input id="userId" placeholder="例如：darrius888"/>
              </div>

              <div class="field">
                <div class="label"><span>Email（邮箱，可选）</div>
                <input id="email" placeholder="（可选）用于 Stripe 匹配/收据"/>
              </div>
            </div>

            <div style="display:flex;align-items:center;gap:10px;margin-top:8px">
              <input id="useEmailMatch" type="checkbox" style="width:auto;transform:translateY(1px)"/>
              <label for="useEmailMatch" class="note" style="cursor:pointer">
                <b>Use email for Stripe match</b>
              </label>
            </div>

            <div class="btnRow">
              <button class="btn" id="saveBtn">Save（保存/刷新）</button>
              <button class="btnGhost" id="refreshBtn">Refresh Status（刷新状态）</button>
            </div>
          </div>

          <div class="card">
            <div class="cardTitle">
              <b>Status · 状态信息</b>
              <span class="note" id="updatedAt">Updated: —</span>
            </div>

            <div class="kv">
              <span>User（用户）</span><b id="kvUser" class="kvVal">—</b>

              <span>Current Plan（当前套餐）</span><b id="kvPlan" class="kvVal">—</b>
              <span>Subscription Status（订阅状态）</span><b id="kvSubStatus" class="kvVal">—</b>
              <span>Renews / Ends（续订/到期）</span><b id="kvEnds" class="kvVal">—</b>

              <span>Data Source Mode（数据模式）</span><b id="kvDataMode" class="kvVal">—</b>
            </div>

            <div class="note" style="margin-top:10px">
              Note: Cancellation usually keeps access active until period end (policy-dependent).<br/>
              说明：取消订阅后，通常会在当前计费周期结束前继续可用（以策略为准）。
            </div>
          </div>

          <div class="card">
            <div class="cardTitle"><b>Actions · 操作</b><span class="note">Route-only</span></div>
            <div class="btnRow">
              <button class="btn" id="openPortalBtn">Open Billing Portal（账单管理）</button>
              <button class="btn" id="scrollPlansBtn">Go to Plans（查看套餐）</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel" id="rightPanel">
        <div class="panelHeader">
          <div class="h">Plans & Control · 套餐与订阅</div>
          <div class="badge" style="border-color: rgba(255,255,255,.12); background: rgba(255,255,255,.06);" id="sysBadge">SYSTEM</div>
        </div>

        <div class="panelBody">
          <!-- ✅ Step2: anchor target lives here -->
          <div class="card darr-plans-anchor" id="plans">
            <div class="cardTitle">
              <b>Plans（4 plans/ 4个产品订购）</b>
              <span class="note" id="plansSource">plans: —</span>
            </div>

            <div class="plansGrid" id="plansGrid"></div>
          </div>

          <div class="card">
            <div class="cardTitle"><b>Quick Actions（快捷操作）</b></div>
            <div class="btnRow">
              <button class="btnGhost" id="openDashBtn">Open Dashboard（打开主界面）</button>
            </div>
          </div>

          <div class="card">
            <div class="cardTitle"><b>System（系统信息）</b></div>
            <div class="kv">
              <span>Build（版本）</span><b id="buildText">—</b>
              <span>Backend（后端）</span><b id="backendText">—</b>
              <span>Plans Source（计划来源）</span><b id="plansSource2">—</b>
            </div>
          </div>

          <div class="card">
            <div class="cardTitle"><b>Support（支持）</b></div>
            <div class="note">
              Billing: use Billing Portal first (invoices, payment methods, cancellations).<br/>
              账单相关请优先使用账单管理（发票、付款方式、取消订阅）。<br/>
              Technical: support@darrius.ai
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div>© <span id="yearNow"></span> Darrius FinTech Inc. All Rights Reserved.</div>
      <div><a href="#" onclick="alert('Terms / Privacy later');return false;">Terms</a> · <a href="#" onclick="alert('Privacy later');return false;">Privacy</a></div>
    </footer>
  </div>

  <script>
    // ===== Globals =====
    window.API_BASE = "https://darrius-api.onrender.com";
    window.__API_BASE__ = window.__API_BASE__ || window.API_BASE;

    window.DARRIUS_BILLING_PRICES_PATH = window.DARRIUS_BILLING_PRICES_PATH || "/billing/prices";
    window.DARRIUS_BILLING_CHECKOUT_NEW_PATH = window.DARRIUS_BILLING_CHECKOUT_NEW_PATH || "/billing/create-checkout-session";
    window.DARRIUS_BILLING_CHECKOUT_OLD_PATH = window.DARRIUS_BILLING_CHECKOUT_OLD_PATH || "/billing/checkout";
    window.DARRIUS_BILLING_PORTAL_PATH  = window.DARRIUS_BILLING_PORTAL_PATH  || "/billing/portal";

    document.getElementById("yearNow").textContent = String(new Date().getFullYear());

    // ✅ load logo (try multiple paths)
    (function(){
      const img = document.getElementById('logoImg');
      if (!img) return;
      const candidates = ['/assets/logo.png','/assets/icon.png','/favicon.png','/favicon.ico'];
      let idx = 0;
      img.onerror = () => { idx += 1; if (idx < candidates.length) img.src = candidates[idx]; };
      img.src = candidates[0];
    })();
  </script>

  <!-- ✅ Step 2: #plans jump + highlight patch (UI-only, safe) -->
  <script>
    (function(){
      'use strict';

      function safe(fn){ try { return fn(); } catch(e){ return null; } }
      function $(id){ return document.getElementById(id); }

      function hasUpgradeIntent(){
        const h = (location.hash || '').toLowerCase();
        if (h === '#plans') return true;
        const qs = new URLSearchParams(location.search || '');
        return qs.get('upgrade') === '1';
      }

      function pulsePlans(){
        const el = $('plans');
        if (!el) return;

        if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex','-1');

        safe(() => el.scrollIntoView({ behavior:'smooth', block:'start' }));
        setTimeout(() => {
          el.classList.add('darr-plans-focus');
          el.classList.add('darr-plans-pulse');
          safe(() => el.focus({ preventScroll:true }));
          setTimeout(() => {
            el.classList.remove('darr-plans-pulse');
            el.classList.remove('darr-plans-focus');
          }, 2600);
        }, 220);
      }

      // Expose for button click reuse
      window.__DARRIUS_PULSE_PLANS__ = pulsePlans;

      function run(){
        if (!hasUpgradeIntent()) return;
        setTimeout(pulsePlans, 80);

        // 可选：清理 hash，避免刷新反复跳
        setTimeout(() => {
          safe(() => history.replaceState(null,'', location.pathname + location.search));
        }, 1200);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run, { once:true });
      } else {
        run();
      }
    })();
  </script>

  <!-- ✅ 订阅/支付/套餐渲染：保持你的原逻辑不变 -->
  <script>
    (function(){
      'use strict';

      const base = (window.__API_BASE__ || window.API_BASE || '').replace(/\/+$/,'');
      const $ = (id) => document.getElementById(id);

      const userIdEl = $('userId');
      const emailEl  = $('email');
      const useEmailEl = $('useEmailMatch');

      // ✅ 你的真实 price_id
      const PRICE_ID_BY_KEY = {
        weekly:    "price_1SpJMmR84UMUVSTg0T7xfm6r",
        monthly:   "price_1SpbvRR84UMUVSTggbg0SFzi",
        quarterly: "price_1SpbwYR84UMUVSTgMQpUrE42",
        yearly:    "price_1SpbpxR84UMUVSTgapaJDjMX"
      };

      // Restore previous input
      try{
        const uid = localStorage.getItem('darrius_user_id') || '';
        const em  = localStorage.getItem('darrius_email') || '';
        const useEm = localStorage.getItem('darrius_use_email_match') || '0';
        if (uid && userIdEl) userIdEl.value = uid;
        if (em && emailEl) emailEl.value = em;
        if (useEmailEl) useEmailEl.checked = (useEm === '1');
      }catch(e){}

      async function fetchJSON(url, opts = {}) {
        const r = await fetch(url, {
          credentials: 'include',
          ...opts,
          headers: {
            'Content-Type': 'application/json',
            ...(opts.headers || {})
          }
        });
        const text = await r.text();
        let data = null;
        try { data = JSON.parse(text); } catch { data = { ok: false, raw: text }; }
        data.__http = { ok: r.ok, status: r.status };
        return data;
      }

      function setBackendState(connected){
        $('backendText').textContent = connected ? "Connected" : "Disconnected";
        $('backendHint').textContent = "Backend: " + (connected ? "connected" : "disconnected");
        const dot = $('loginDot');
        if (dot) dot.classList.toggle('bad', !connected);
      }

      // ---------- Plans ----------
      const FALLBACK_PLANS = [
        { key:"weekly",    name:"Weekly · 周付",    price:"$4.90",   desc:"Short-term access. Ideal for trials and quick evaluations. 短期体验。", trial:"—",  price_id: PRICE_ID_BY_KEY.weekly },
        { key:"monthly",   name:"Monthly · 月付",   price:"$19.90",  desc:"Most popular. Balanced commitment and flexibility. 最受欢迎。",       trial:"1-day free trial（1天免费试用）",  price_id: PRICE_ID_BY_KEY.monthly },
        { key:"quarterly", name:"Quarterly · 季付", price:"$49.90",  desc:"Better value. Recommended for active users. 性价比更高。",           trial:"3-day free trial（3天免费试用）",  price_id: PRICE_ID_BY_KEY.quarterly },
        { key:"yearly",    name:"Yearly · 年付",    price:"$189.00", desc:"Best value for professionals and long-term users. 专业长期。",       trial:"5-day free trial（5天免费试用）",  price_id: PRICE_ID_BY_KEY.yearly },
      ];

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function renderPlans(plans, sourceLabel){
        $('plansSource').textContent = "plans: " + sourceLabel;
        $('plansSource2').textContent = sourceLabel;

        const grid = $('plansGrid');
        grid.innerHTML = "";

        plans.forEach(p => {
          const card = document.createElement('div');
          card.className = "planCard";

          const trialHtml = (p.trial && p.trial !== "—")
            ? `<div class="pillMini">● ${escapeHtml(p.trial)}</div>`
            : "";

          card.innerHTML = `
            <div>
              <div class="planTop">
                <div>
                  <div class="planName">${escapeHtml(p.name || p.nickname || "Plan")}</div>
                  <div class="planDesc">${escapeHtml(p.desc || "")}</div>
                  ${trialHtml}
                </div>
                <div class="planPrice">${escapeHtml(p.price || "")}</div>
              </div>
            </div>
            <div class="planActions">
              <button class="btn" data-act="subscribe">Subscribe（订阅）</button>
              <button class="btnGhost" data-act="details">Details（详情）</button>
            </div>
          `;

          card.querySelector('[data-act="subscribe"]').addEventListener('click', async (ev) => {
            ev.preventDefault(); ev.stopPropagation();
            await startCheckout(p);
          });
          card.querySelector('[data-act="details"]').addEventListener('click', (ev) => {
            ev.preventDefault(); ev.stopPropagation();
            alert((p.name || "Plan") + "\n" + (p.desc || "") + (p.trial ? ("\n" + p.trial) : ""));
          });

          grid.appendChild(card);
        });
      }

      async function loadPlans(){
        const url = base + window.DARRIUS_BILLING_PRICES_PATH;
        try{
          const res = await fetch(url, { method:'GET' });
          const text = await res.text();
          let j = {};
          try{ j = JSON.parse(text); } catch { j = { ok:false, raw:text }; }

          if (!res.ok) throw new Error("HTTP " + res.status);

          const arr = Array.isArray(j) ? j : (Array.isArray(j.prices) ? j.prices : []);
          if (!arr.length) throw new Error("empty prices");

          const mapped = arr.map(x => ({
            key: (x.key || x.lookup_key || "").toLowerCase(),
            name: x.nickname || x.name || x.product_name || x.id,
            price: x.unit_amount_display || x.price_display || x.display || (x.unit_amount ? ("$"+(x.unit_amount/100).toFixed(2)) : ""),
            desc: x.description || "",
            trial: x.trial || "",
            price_id: x.id || x.price_id || ""
          }));

          mapped.forEach(p => {
            if (!p.price_id && p.key && PRICE_ID_BY_KEY[p.key]) p.price_id = PRICE_ID_BY_KEY[p.key];
          });

          renderPlans(mapped, "backend");
          setBackendState(true);
        }catch(e){
          renderPlans(FALLBACK_PLANS, "fallback (backend unavailable)");
          setBackendState(true);
        }
      }

      async function postCheckout(endpoint, payload){
        const url = base + endpoint;
        const resp = await fetchJSON(url, { method:'POST', body: JSON.stringify(payload) });
        const checkoutUrl = resp.url || resp.checkout_url || (resp.data && resp.data.url);
        return { resp, checkoutUrl, url };
      }

      async function startCheckout(plan){
        const uid = (userIdEl && userIdEl.value || '').trim();
        const em  = (emailEl && emailEl.value || '').trim();

        if (!uid){
          alert("Please enter User ID first.");
          return;
        }

        const priceId = (plan && plan.price_id) ? String(plan.price_id).trim()
                      : (plan && plan.key && PRICE_ID_BY_KEY[plan.key]) ? PRICE_ID_BY_KEY[plan.key]
                      : "";

        if (!priceId){
          alert("Missing price_id for this plan.\nPlease ensure backend /billing/prices returns price ids, or fallback has correct ids.");
          return;
        }

        const payload = {
          user_id: uid,
          email: em || "",
          price_id: priceId,
          success_url: window.location.origin + "/account.html?checkout=success",
          cancel_url: window.location.origin + "/account.html?checkout=cancel"
        };

        const tried = [];
        try{
          tried.push(base + window.DARRIUS_BILLING_CHECKOUT_NEW_PATH);
          const r1 = await postCheckout(window.DARRIUS_BILLING_CHECKOUT_NEW_PATH, payload);
          if (r1.checkoutUrl) { window.location.href = r1.checkoutUrl; return; }

          const detail = r1.resp.detail || r1.resp.error || r1.resp.raw || ("HTTP " + (r1.resp.__http && r1.resp.__http.status));
          throw new Error(detail || "no url");
        }catch(e1){
          try{
            tried.push(base + window.DARRIUS_BILLING_CHECKOUT_OLD_PATH);
            const r2 = await postCheckout(window.DARRIUS_BILLING_CHECKOUT_OLD_PATH, payload);
            if (r2.checkoutUrl) { window.location.href = r2.checkoutUrl; return; }

            const detail2 = r2.resp.detail || r2.resp.error || r2.resp.raw || ("HTTP " + (r2.resp.__http && r2.resp.__http.status));
            throw new Error(detail2 || "no url");
          }catch(e2){
            alert(
              "Checkout not ready: backend did not return [url].\n\n" +
              "Tried endpoints:\n" + tried.join("\n") + "\n\n" +
              "price_id: " + priceId + "\n" +
              "Error: " + String(e2 && e2.message ? e2.message : e2)
            );
          }
        }
      }

      async function openPortal(){
        const uid = (userIdEl && userIdEl.value || '').trim();
        const em  = (emailEl && emailEl.value || '').trim();
        const useEmail = !!(useEmailEl && useEmailEl.checked);

        if (!uid){
          alert("Please enter User ID first.");
          return;
        }

        const payload = {
          user_id: uid,
          email: (useEmail ? (em || "") : ""),
          return_url: window.location.origin + "/account.html"
        };

        const url = base + window.DARRIUS_BILLING_PORTAL_PATH;
        const resp = await fetchJSON(url, { method:'POST', body: JSON.stringify(payload) });

        const portalUrl = resp.url || resp.portal_url || (resp.data && resp.data.url);
        if (portalUrl) { window.location.href = portalUrl; return; }

        alert(
          "Billing Portal not available.\nEndpoint: " + url + "\n\n" +
          "HTTP: " + (resp.__http ? resp.__http.status : "?") + "\n" +
          "Detail: " + (resp.detail || resp.error || resp.raw || "unknown")
        );
      }

      // ===== Wire UI events =====
      $('openPortalBtn').addEventListener('click', (ev) => { ev.preventDefault(); ev.stopPropagation(); openPortal(); });

      // ✅ 改成滚到 #plans + 触发高亮（比滚到 plansCard 更准）
      $('scrollPlansBtn').addEventListener('click', (ev) => {
        ev.preventDefault(); ev.stopPropagation();
        if (window.__DARRIUS_PULSE_PLANS__) { window.__DARRIUS_PULSE_PLANS__(); return; }
        const el = $('plans');
        if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
      });

      $('openDashBtn').addEventListener('click', (ev) => { ev.preventDefault(); ev.stopPropagation(); window.location.href = '/index.html'; });
      $('backBtn').addEventListener('click', (ev) => { ev.preventDefault(); ev.stopPropagation(); window.location.href = '/index.html'; });

      // ✅ Save / Refresh：由 account.manage.fix.js 实现
      $('saveBtn').addEventListener('click', (ev) => { ev.preventDefault(); ev.stopPropagation(); window.DARRIUS_ACCOUNT_REFRESH_STATUS && window.DARRIUS_ACCOUNT_REFRESH_STATUS(); });
      $('refreshBtn').addEventListener('click', (ev) => { ev.preventDefault(); ev.stopPropagation(); window.DARRIUS_ACCOUNT_REFRESH_STATUS && window.DARRIUS_ACCOUNT_REFRESH_STATUS(); });

      // ===== init =====
      (async function init(){
        setBackendState(true);
        $('backendHint').textContent = "Backend: connected";
        $('buildText').textContent = new Date().toISOString();
        await loadPlans();

        setTimeout(() => { window.DARRIUS_ACCOUNT_REFRESH_STATUS && window.DARRIUS_ACCOUNT_REFRESH_STATUS(); }, 250);
      })();
    })();
  </script>

  <!-- ✅ 状态打通专用：只读 /billing/status，不碰订阅支付 -->
  <script src="js/account.manage.fix.js"></script>
</body>
</html>
