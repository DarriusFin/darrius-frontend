<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DarriusAI · Account & Subscription</title>

  <style>
    :root{
      --bg:#0B0F17;
      --bg2:#0A1220;

      --panel: rgba(18,26,40,.92);
      --panel2: rgba(15,23,38,.88);

      --border:rgba(255,255,255,.08);
      --border2:rgba(255,255,255,.10);

      --text:#EAF0F7;
      --muted:#A2B0C2;

      --brand1:#2BE2A6;
      --brand2:#4CC2FF;
      --danger:#FF5A5A;
      --warn:#FFB86C;

      --shadow: 0 18px 45px rgba(0,0,0,.40);
      --shadow2: 0 10px 25px rgba(0,0,0,.28);

      --r12:12px;
      --r14:14px;
      --r18:18px;

      --gradBrand: linear-gradient(90deg, rgba(43,226,166,1) 0%, rgba(76,194,255,1) 100%);
      --gradHeader: linear-gradient(90deg, rgba(43,226,166,.20) 0%, rgba(76,194,255,.16) 100%);
      --gradHeader2: linear-gradient(180deg, rgba(76,194,255,.10) 0%, rgba(255,255,255,0.02) 100%);

      /* ✅ Logo 2.4x（你要2.0就改这里） */
      --logoScale: 3.3;
      --logoBase: 40px;
      --logoSize: calc(var(--logoBase) * var(--logoScale));
      --logoRadius: calc(12px * var(--logoScale));

      /* ✅ 短按钮宽度（防止背景拉满一整行） */
      --shortBtnW: 320px;

      /* ✅ 页面最大宽度（解决你说的“左边太宽”） */
      --pageMax: 1280px;

      /* ✅ 右侧栏宽度更窄、更合理 */
      --rightCol: 340px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 12% 10%, rgba(76,194,255,.10), transparent 60%),
        radial-gradient(900px 520px at 88% 12%, rgba(43,226,166,.10), transparent 62%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
    }
    a{ color: rgba(76,194,255,.95); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* ===== Topbar ===== */
    #topbar{
      height:78px;
      padding:0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(10,15,23,.55);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:420px;
    }

    /* ✅ Logo：放大 + 无旋转光晕 */
    .logoBox{
      width: var(--logoSize);
      height: var(--logoSize);
      border-radius: var(--logoRadius);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
      flex:0 0 auto;
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
    }
    .logoBox::before{
      content:"";
      position:absolute; inset:-6px;
      background: linear-gradient(135deg, rgba(76,194,255,.30), rgba(43,226,166,.22), rgba(255,255,255,.06));
      filter: blur(12px);
      opacity:.35;
      pointer-events:none;
    }
    #logoImg{
      width: var(--logoSize);
      height: var(--logoSize);
      border-radius: var(--logoRadius);
      object-fit: cover;
      display:block;
      position: relative;
      z-index: 2;
    }

    .brandText{ line-height:1.08; }
    .brandLine1{
      font-weight:950;
      letter-spacing:.3px;
      font-size:22px;
    }
    .brandLine1 .accent{
      background: var(--gradBrand);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .brandLine2{
      margin-top:7px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chip{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,247,.90);
      white-space:nowrap;
    }
    .chip.brand{
      border:1px solid rgba(43,226,166,.30);
      background: rgba(43,226,166,.12);
      color: rgba(234,240,247,.95);
    }

    .topRight{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width:360px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,26,40,.65);
      box-shadow: var(--shadow2);
      font-size:12px;
      color: var(--text);
      white-space:nowrap;
      max-width: 42vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--brand1);
      box-shadow: 0 0 0 4px rgba(43,226,166,.10);
      flex:0 0 auto;
    }
    .btnTop{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: rgba(234,240,247,.90);
      border-radius:999px;
      padding:9px 12px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }

    /* ===== Page wrap ===== */
    #wrap{
      padding:16px;
      display:flex;
      justify-content:center;   /* ✅ 居中 */
    }
    #container{
      width: 100%;
      max-width: var(--pageMax);  /* ✅ 限制最大宽度 */
    }

    #grid{
      display:grid;
      grid-template-columns: minmax(0,1fr) var(--rightCol); /* ✅ 左自适应，右固定更窄 */
      gap:16px;
      min-height: calc(100vh - 78px - 40px);
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--border);
      border-radius: var(--r18);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .panelHeader{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .panelHeader .h{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .panelBody{ padding:14px; min-height:0; }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,247,.95);
      font-weight:950;
      letter-spacing:.3px;
    }
    .badge.ok{
      border-color: rgba(43,226,166,.30);
      background: rgba(43,226,166,.12);
    }
    .badge.bad{
      border-color: rgba(255,90,90,.30);
      background: rgba(255,90,90,.12);
    }

    .card{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--r14);
      padding:12px;
      margin-bottom:12px;
    }

    /* ✅ 通用“栏目标题条”（你图里黄色框缺的就是这个） */
    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: var(--gradHeader);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .sectionHeader b{
      font-weight:950;
      font-size:12.5px;
      letter-spacing:.2px;
    }
    .sectionHeader .small{
      font-size:12px;
      color: rgba(234,240,247,.78);
    }

    .note{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .note b{ color: var(--text); }

    .field{ margin-bottom:10px; }
    .label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
      font-size:12px;
      color: var(--muted);
    }
    input{
      width:100%;
      background: rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 10px;
      border-radius: var(--r12);
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(162,176,194,.80); }
    input:focus{
      border-color: rgba(76,194,255,.50);
      box-shadow: 0 0 0 4px rgba(76,194,255,.12);
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      font-size:12px;
      color: var(--muted);
    }
    .kv b{ color: var(--text); font-weight:900; }

    .btn{
      border:0;
      color:#081119;
      font-weight:950;
      letter-spacing:.3px;
      padding:12px 12px;
      border-radius: var(--r12);
      cursor:pointer;
      background: var(--gradBrand);
      box-shadow: var(--shadow2);
      transition: transform .06s ease, filter .15s ease;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{ transform: translateY(1px); }

    .btnGhost{
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight:900;
      padding:11px 12px;
      border-radius: var(--r12);
      cursor:pointer;
      background: rgba(0,0,0,.14);
      transition: transform .06s ease, filter .15s ease;
    }
    .btnGhost:hover{ filter: brightness(1.05); }
    .btnGhost:active{ transform: translateY(1px); }

    .btnShort{
      width: var(--shortBtnW);
      max-width: 100%;
    }

    .btnRow{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* ✅ Actions 两个按钮：和你“订阅卡片按钮长度”一致风格，不拉满 */
    .actionBtns .btn{ width: 260px; max-width:100%; }
    .actionBtns{ display:flex; gap:12px; flex-wrap:wrap; }

    /* ===== Plans grid ===== */
    .plansGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .planCard{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--r14);
      padding:12px;
      min-height: 132px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .planTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .planName{ font-weight:950; }
    .planPrice{ font-weight:950; color: rgba(234,240,247,.92); }
    .planDesc{ margin-top:6px; color: var(--muted); font-size:12px; line-height:1.4; }
    .pillMini{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,247,.86);
      margin-top:8px;
      width: fit-content;
    }
    .pillMini.ok{
      border-color: rgba(43,226,166,.26);
      background: rgba(43,226,166,.10);
    }
    .planActions{
      display:flex;
      gap:10px;
      margin-top:10px;
      align-items:center;
      justify-content:flex-start; /* ✅ 不要左右拉开太大 */
      flex-wrap:wrap;
    }
    .planActions .btn, .planActions .btnGhost{
      width: 170px;
      max-width:100%;
    }

    .mutRed{ color: rgba(255,90,90,.92); }
    .mutOk{ color: rgba(43,226,166,.92); }

    footer{
      padding:14px 4px 0 4px;
      color: rgba(234,240,247,.62);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      opacity:.9;
    }

    @media (max-width: 1180px){
      #grid{ grid-template-columns: 1fr; }
      .brand{ min-width:0; }
      .topRight{ min-width:0; }
      .plansGrid{ grid-template-columns: 1fr; }
      :root{ --shortBtnW: 100%; --rightCol: 100%; }
      .actionBtns .btn{ width: 100%; }
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div class="brand">
      <div class="logoBox">
        <img id="logoImg" alt="darrius.ai logo" />
      </div>
      <div class="brandText">
        <div class="brandLine1"><span class="accent">DarriusAI</span> · Inflection Hunter</div>
        <div class="brandLine2">
          <span class="chip brand">Account & Subscription Management</span>
          <span class="chip">账户与订阅管理</span>
        </div>
      </div>
    </div>

    <div class="topRight">
      <div class="pill"><span class="dot"></span><span id="loginText">Logged in · 已登录</span></div>
      <div class="pill"><span class="dot"></span><span id="accessText">Access: DELAYED · 市场数据（延时）</span></div>
      <button class="btnTop" id="backBtn">← Back to Dashboard（返回主界面）</button>
    </div>
  </div>

  <div id="wrap">
    <div id="container">
      <div id="grid">
        <!-- LEFT -->
        <div class="panel">
          <div class="panelHeader">
            <div class="h">Subscription Overview · 订阅概览</div>
            <div class="badge" id="statusBadge">STATUS: —</div>
          </div>

          <div class="panelBody">

            <div class="note" style="margin-bottom:12px">
              This page manages your subscription. Access and data mode are enforced by backend policy.<br/>
              本页用于订阅管理；访问权限与数据模式由后端策略控制。
            </div>

            <!-- Identity -->
            <div class="card">
              <div class="sectionHeader">
                <b>Identity · 身份信息</b>
                <span class="small" id="backendHint">—</span>
              </div>

              <div class="field">
                <div class="label"><span><b>User ID</b>（用户ID）</span><span class="small">必填</span></div>
                <input id="userId" placeholder="例如：darrius888"/>
                <div class="note" style="margin-top:6px">Used to fetch status and open billing portal.<br/>用于获取订阅状态并打开账单管理。</div>
              </div>

              <div class="field">
                <div class="label"><span>Email（邮箱，可选）</span><span class="small">可选</span></div>
                <input id="email" placeholder="用于收据 / checkout 匹配（不参与状态查询）"/>
                <div class="note" style="margin-top:6px">Optional; for checkout/receipt only.<br/>可选：只用于 Checkout/收据兜底，不参与状态查询。</div>
              </div>

              <div class="btnRow" style="margin-top:10px">
                <button class="btn btnShort" id="saveBtn">Save（保存/刷新）</button>
                <button class="btnGhost btnShort" id="refreshBtn">Refresh Status（刷新状态）</button>
              </div>

              <div class="note" style="margin-top:10px">
                <b>说明：</b>如果你发现“填 email 反而 Unknown”，通常是 email 与 Stripe Customer 绑定不一致导致。这里我们默认用 user_id 查询状态，避免误判。
              </div>
            </div>

            <!-- Status -->
            <div class="card">
              <div class="sectionHeader">
                <b>Status · 状态信息</b>
                <span class="small" id="statusMini">—</span>
              </div>

              <div class="kv">
                <span>User（用户）</span><b id="kvUser">—</b>
                <span>Current Plan（当前套餐）</span><b id="kvPlan">—</b>
                <span>Subscription Status（订阅状态）</span><b id="kvSubStatus">—</b>
                <span>Renews / Ends（续订/到期）</span><b id="kvEnds">—</b>
                <span>Data Source Mode（数据模式）</span><b id="kvDataMode">—</b>
              </div>

              <div class="note" style="margin-top:10px">
                Note: After cancellation, access normally remains active until the end of the current billing period (policy-dependent).<br/>
                说明：取消订阅后，通常会在当前计费周期结束前继续可用（以策略为准）。
              </div>
            </div>

            <!-- Actions -->
            <div class="card">
              <div class="sectionHeader">
                <b>Actions · 操作</b>
                <span class="small">Route-only</span>
              </div>

              <div class="actionBtns">
                <button class="btn" id="openPortalBtn">Open Billing Portal（账单管理）</button>
                <button class="btn" id="choosePlanBtn">Choose / Change Plan（选择/更换套餐）</button>
              </div>

              <div class="note" style="margin-top:10px">
                These buttons route through your existing billing flow (do not change your payment logic).<br/>
                这些按钮只做跳转/调用，不改动你现有订阅支付逻辑。
              </div>
            </div>

            <!-- ✅ Plans：这里就是你黄色框的地方，必须有“蓝色标题条” -->
            <div class="card" id="plansCard">
              <div class="sectionHeader">
                <b>Plans（套餐）</b>
                <span class="small" id="plansHint">loading…</span>
              </div>

              <div class="note">
                We render plan cards by calling your existing <b>/billing/prices</b> endpoint.<br/>
                我们通过你现有 <b>/billing/prices</b> 接口渲染套餐卡片（不改订阅逻辑）。<br/>
                <b>Fallback:</b> If backend is unavailable, we still show 4 plans locally (never empty).<br/>
                <b>兜底：</b>后端断开也会显示4个计划（永不为空）。
              </div>

              <div class="plansGrid" id="plansGrid"></div>

              <div class="note" style="margin-top:10px">
                Compliance note (display-only): Delayed mode is shown when required by your data provider terms.<br/>
                合规提示（仅展示）：当数据提供方要求时，会显示 Delayed。
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="panelHeader">
            <div class="h">Control Center · 控制台</div>
            <div class="badge" id="sysBadge">SYSTEM（系统）</div>
          </div>

          <div class="panelBody">
            <div class="card">
              <div class="sectionHeader">
                <b>Quick Actions（快捷操作）</b>
                <span class="small">—</span>
              </div>
              <button class="btnGhost" id="openDashBtn" style="width:100%">Open Dashboard（打开主界面）</button>
            </div>

            <div class="card">
              <div class="sectionHeader">
                <b>Support（支持）</b>
                <span class="small">support@darrius.ai</span>
              </div>
              <div class="note">
                For billing questions, use Billing Portal first (invoices, payment methods, cancellations).<br/>
                账单相关请优先使用账单管理（发票、付款方式、取消订阅）。
              </div>
            </div>

            <div class="card">
              <div class="sectionHeader">
                <b>System（系统信息）</b>
                <span class="small" id="buildText">—</span>
              </div>

              <div class="kv">
                <span>Backend（后端）</span><b id="backendText">—</b>
                <span>Plans Source（计划来源）</span><b id="planSource">—</b>
              </div>
            </div>
          </div>
        </div>

      </div>

      <footer>
        <div>© <span id="yearNow"></span> Darrius FinTech Inc. All Rights Reserved.</div>
        <div><a href="#" onclick="alert('Terms / Privacy later');return false;">Terms</a> · <a href="#" onclick="alert('Privacy later');return false;">Privacy</a></div>
      </footer>
    </div>
  </div>

  <script>
    // ===== Globals =====
    window.API_BASE = "https://darrius-api.onrender.com";
    window.__API_BASE__ = window.__API_BASE__ || window.API_BASE;

    document.getElementById("yearNow").textContent = String(new Date().getFullYear());

    // Load logo (best effort)
    (function(){
      const img = document.getElementById('logoImg');
      if (!img) return;
      const candidates = ['/assets/logo.png','/assets/icon.png','/favicon.png','/favicon.ico'];
      let idx = 0;
      img.onerror = () => { idx += 1; if (idx < candidates.length) img.src = candidates[idx]; };
      img.src = candidates[0];
    })();
  </script>

  <script>
    (function(){
      const base = (window.__API_BASE__ || window.API_BASE || '').replace(/\/+$/,'');
      const $ = (id) => document.getElementById(id);

      const userIdEl = $('userId');
      const emailEl  = $('email');

      // ===== 4-plan fallback (永不为空) =====
      const FALLBACK_PLANS = [
        { key:'weekly',    name:'Weekly · 周付',    price:'$4.90',  desc:'Short-term access. Ideal for trials and quick evaluations. 短期体验，适合快速评估。', trial:'—',  price_id:'price_weekly' },
        { key:'monthly',   name:'Monthly · 月付',   price:'$19.90', desc:'Most popular. Balanced commitment and flexibility. 最受欢迎，兼顾灵活与稳定。', trial:'1-day free trial（1天免费试用）', price_id:'price_monthly' },
        { key:'quarterly', name:'Quarterly · 季付', price:'$49.90', desc:'Better value. Recommended for active users. 性价比更高，适合活跃用户。', trial:'3-day free trial（3天免费试用）', price_id:'price_quarterly' },
        { key:'yearly',    name:'Yearly · 年付',    price:'$189.00',desc:'Best value. For professionals and long-term users. 最佳价值，适合专业与长期用户。', trial:'5-day free trial（5天免费试用）', price_id:'price_yearly' }
      ];

      // Restore from localStorage
      try{
        const uid = localStorage.getItem('darrius_user_id') || '';
        const em  = localStorage.getItem('darrius_email') || '';
        if (uid && userIdEl) userIdEl.value = uid;
        if (em && emailEl) emailEl.value = em;
      }catch(e){}

      function setBadge(ok, text){
        const b = $('statusBadge');
        b.textContent = text;
        b.className = 'badge ' + (ok ? 'ok' : 'bad');
      }

      function setBackendState(connected, msg){
        $('backendText').textContent = connected ? 'Connected' : 'Disconnected';
        $('backendText').className = connected ? 'mutOk' : 'mutRed';
        $('backendHint').textContent = msg || (connected ? 'Backend connected' : 'Backend disconnected');
      }

      function fillKV(j, uid){
        $('kvUser').textContent = (j.user || j.user_id || uid || '—');
        $('kvPlan').textContent = (j.plan || j.current_plan || j.price_nickname || '—');
        $('kvSubStatus').textContent = (j.status || j.subscription_status || '—');
        $('kvEnds').textContent = (j.renews_or_ends || j.ends_at || j.current_period_end || '—');
        $('kvDataMode').textContent = (j.data_mode || j.mode || 'DELAYED');
        $('statusMini').textContent = 'Updated: ' + new Date().toLocaleString();
      }

      // ✅ Status query: only user_id (avoid email causes Unknown)
      async function refreshStatus(){
        const uid = (userIdEl?.value || '').trim();
        const em  = (emailEl?.value || '').trim();

        if (!uid){
          setBadge(false, 'STATUS: MISSING USER');
          setBackendState(false, 'Missing user_id');
          return;
        }
        try{
          localStorage.setItem('darrius_user_id', uid);
          if (em) localStorage.setItem('darrius_email', em);
        }catch(e){}

        try{
          const url = base + '/billing/status?user_id=' + encodeURIComponent(uid);
          const res = await fetch(url, { method:'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const j = await res.json().catch(()=> ({}));

          fillKV(j, uid);
          setBackendState(true, 'Backend connected');
          setBadge(true, 'STATUS: ' + (j.status || 'ACTIVE'));
        }catch(e){
          fillKV({}, uid);
          setBackendState(false, 'Backend disconnected');
          setBadge(false, 'STATUS: UNKNOWN');
        }
      }

      function escapeHtml(s){
        return String(s || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }

      function renderPlans(plans, sourceLabel){
        const grid = $('plansGrid');
        grid.innerHTML = '';
        $('plansHint').textContent = sourceLabel;
        $('planSource').textContent = sourceLabel;

        plans.forEach(p => {
          const card = document.createElement('div');
          card.className = 'planCard';

          const trialHtml = p.trial && p.trial !== '—'
            ? `<div class="pillMini ok"><span class="dot" style="width:7px;height:7px;box-shadow:none"></span>${escapeHtml(p.trial)}</div>`
            : '';

          card.innerHTML = `
            <div>
              <div class="planTop">
                <div>
                  <div class="planName">${escapeHtml(p.name)}</div>
                  <div class="planDesc">${escapeHtml(p.desc || '')}</div>
                  ${trialHtml}
                </div>
                <div class="planPrice">${escapeHtml(p.price || '—')}</div>
              </div>
            </div>
            <div class="planActions">
              <button class="btn" data-price="${escapeHtml(p.price_id || '')}">Subscribe（订阅）</button>
              <button class="btnGhost" data-details="${escapeHtml(p.key || '')}">Details（详情）</button>
            </div>
          `;

          grid.appendChild(card);
        });

        // Bind
        grid.querySelectorAll('button.btn[data-price]').forEach(btn => {
          btn.addEventListener('click', () => startCheckout(btn.getAttribute('data-price')));
        });
        grid.querySelectorAll('button.btnGhost[data-details]').forEach(btn => {
          btn.addEventListener('click', () => alert('Details: ' + btn.getAttribute('data-details')));
        });
      }

      // Load plans from backend; if fail -> fallback
      async function loadPlans(){
        $('plansHint').textContent = 'loading…';
        try{
          const res = await fetch(base + '/billing/prices', { method:'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const j = await res.json().catch(()=> ({}));
          const prices = Array.isArray(j.prices) ? j.prices : (Array.isArray(j) ? j : []);

          if (!prices.length) throw new Error('empty prices');

          // Normalize to our plan card schema
          const normalized = prices.map(p => {
            const name = p.nickname || p.name || p.lookup_key || 'Plan';
            const unit = (p.unit_amount != null) ? ('$' + (p.unit_amount/100).toFixed(2)) : (p.price || '—');
            const interval = (p.recurring && p.recurring.interval) ? p.recurring.interval : (p.interval || '');
            const title = interval ? `${name}` : `${name}`;
            const desc  = p.description || '';
            const priceId = p.id || p.price_id || '';
            return {
              key: (p.lookup_key || priceId || name || '').toString(),
              name: title,
              price: unit + (interval ? (' · ' + interval) : ''),
              desc,
              trial: (p.trial_days ? (p.trial_days + '-day free trial') : '—'),
              price_id: priceId
            };
          });

          $('planSource').textContent = 'backend';
          renderPlans(normalized, 'backend');
        }catch(e){
          // fallback always show 4 plans
          $('planSource').textContent = 'fallback';
          renderPlans(FALLBACK_PLANS, 'fallback (backend unavailable)');
        }
      }

      async function startCheckout(priceId){
        const uid = (userIdEl?.value || '').trim();
        const em  = (emailEl?.value || '').trim();
        if (!uid){ alert('Please input User ID first.'); return; }
        if (!priceId){ alert('Missing price id.'); return; }

        // route-only: /billing/checkout (your backend)
        try{
          const res = await fetch(base + '/billing/checkout', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ user_id: uid, email: em || null, price_id: priceId })
          });
          const j = await res.json().catch(()=> ({}));
          if (j && j.url){ window.location.href = j.url; return; }
          alert('Checkout not ready: backend did not return {url}.');
        }catch(e){
          alert('Checkout failed. Please check backend /billing/checkout.');
        }
      }

      // Portal (optional)
      $('openPortalBtn')?.addEventListener('click', async () => {
        const uid = (userIdEl?.value || '').trim();
        if (!uid){ alert('Please input User ID first.'); return; }
        try{
          const res = await fetch(base + '/billing/portal', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ user_id: uid })
          });
          const j = await res.json().catch(()=> ({}));
          if (j && j.url){ window.location.href = j.url; return; }
          alert('Billing Portal not wired. If you have a portal route, return {url}.');
        }catch(e){
          alert('Billing Portal not available. Please wire /billing/portal in backend.');
        }
      });

      $('choosePlanBtn')?.addEventListener('click', () => {
        $('plansCard')?.scrollIntoView({ behavior:'smooth', block:'start' });
      });

      $('openDashBtn')?.addEventListener('click', () => { window.location.href = '/index.html'; });
      $('backBtn')?.addEventListener('click', () => { window.location.href = '/index.html'; });

      $('saveBtn')?.addEventListener('click', () => { refreshStatus(); loadPlans(); });
      $('refreshBtn')?.addEventListener('click', () => { refreshStatus(); loadPlans(); });

      // Boot
      $('buildText').textContent = new Date().toISOString();
      setTimeout(() => { refreshStatus(); loadPlans(); }, 120);
    })();
  </script>
</body>
</html>
